<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebase/auth/dist/index.mjs";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebase/firestore/dist/index.mjs";

    // Dynamically retrieve Firebase configuration provided by the Canvas environment
    // Fallback to a placeholder if running outside Canvas (for local development testing)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID"
    };

    // Use the actual appId from the Canvas environment, or fallback to the config's appId, then a default
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId || 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    // Global Firebase vars
    let app;
    let db;
    let auth;
    let userId; // Will store the authenticated user ID

    // Firestore Paths - Using a public collection for shared data
    const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/retirement_calculator`;
    const SHARED_DOC_ID = 'shared_inputs'; // A single document for all shared inputs

    // Revision Level
    const appRevision = "1.7"; // Dynamic retirement draw based on slider

    // Predefined default values for dynamic sections
    const defaultInvestmentAccounts = [
        { name: "401K", value: 524620 },
        { name: "Roth 1", value: 177474 },
        { name: "Roth 2", value: 156407 },
        { name: "529", value: 55485 },
        { name: "HSA", value: 25187 },
        { name: "Gold", value: 6600 },
        { name: "Checking", value: 17522 }
    ];

    const defaultOtherAssets = [
        { name: "Home Value", value: 979500 },
        { name: "Other Equity (car, tractor, camper)", value: 90601 }
    ];

    const defaultLiabilities = [
        { name: "Mortgage", value: 202212 }
    ];

    const defaultOtherIncomes = [
        { name: "Cell Tower", value: 1200, escalationRate: 0.015 },
        { name: "Rental House", value: 1300, escalationRate: 0.03 }
    ];


        // Flag to prevent saving when data is being loaded from Firestore
        window.isLoadingFromFirestore = false;

        // Helper functions for number formatting in input fields
        function formatInputNumber(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // Ensure value is treated as a number before formatting, removing existing commas
            let num = Number(String(value).replace(/,/g, ''));
            if (isNaN(num)) {
                return '';
            }
            return new Intl.NumberFormat('en-US').format(num);
        }

        function cleanInputNumber(stringValue) {
            if (stringValue === null || stringValue === undefined || stringValue === '') {
                return 0;
            }
            // Remove all non-digit characters except for a potential leading minus sign and decimal
            const cleaned = stringValue.replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // Get references to all static input elements
        const staticInputs = {
            currentAge: document.getElementById('currentAge'),
            baseSalary: document.getElementById('baseSalary'),
            bonusRate: document.getElementById('bonusRate'),
            my401kContributionRate: document.getElementById('my401kContributionRate'),
            company401kContributionRate: document.getElementById('company401kContributionRate'),
            annualRothContribution: document.getElementById('annualRothContribution'),
            monthly529Contribution: document.getElementById('monthly529Contribution'),
            monthlyHSAContribution: document.getElementById('monthlyHSAContribution'),
            annualSalaryRaise: document.getElementById('annualSalaryRaise'),
            stockAppreciation: document.getElementById('stockAppreciation'),
            housingAppreciation: document.getElementById('housingAppreciation'),
            inflation: document.getElementById('inflation'),
            retirementDrawRate: document.getElementById('retirementDrawRate'),
            retirementYear: document.getElementById('retirementYear'),
            monthlyPrincipalPayment: document.getElementById('monthlyPrincipalPayment')
        };

        // Get references to display elements
        const currentNetWorthDisplay = document.getElementById('currentNetWorth');
        const currentNetInvestmentsDisplay = document.getElementById('currentNetInvestments');
        const annualIncomeDisplay = document.getElementById('annualIncomeDisplay');
        const annualSavingsDisplay = document.getElementById('annualSavingsDisplay');
        const todaysDrawDisplay = document.getElementById('todaysDraw');
        const dynamicRetirementDrawLabel = document.getElementById('dynamicRetirementDrawLabel'); // New: Dynamic label for retirement draw
        const dynamicRetirementDrawValue = document.getElementById('dynamicRetirementDrawValue'); // New: Dynamic value for retirement draw
        const sixtyTwoYODrawDisplay = document.getElementById('sixtyTwoYODraw');
        const dynamicRetirementDrawLabelSticky = document.getElementById('dynamicRetirementDrawLabelSticky'); // New: Dynamic sticky label
        const dynamicRetirementDrawValueSticky = document.getElementById('dynamicRetirementDrawValueSticky'); // New: Dynamic sticky value
        const projectionTableBody = document.getElementById('projectionTableBody');
        const investmentAccountsContainer = document.getElementById('investmentAccountsContainer');
        const addInvestmentBtn = document.getElementById('addInvestmentBtn');
        const otherAssetsContainer = document.getElementById('otherAssetsContainer');
        const addOtherAssetBtn = document.getElementById('addOtherAssetBtn');
        const liabilitiesContainer = document.getElementById('liabilitiesContainer');
        const addLiabilityBtn = document.getElementById('addLiabilityBtn');
        const otherIncomeContainer = document.getElementById('otherIncomeContainer');
        const addOtherIncomeBtn = document.getElementById('addOtherIncomeBtn');
        const chartContainer = document.getElementById('chart-container');
        const appRevisionDisplay = document.getElementById('appRevisionDisplay'); // New: For revision display

        // References for the summary spans
        const totalInvestmentsSummary = document.getElementById('totalInvestmentsSummary');
        const totalOtherAssetsSummary = document.getElementById('totalOtherAssetsSummary');
        const totalLiabilitiesSummary = document.getElementById('totalLiabilitiesSummary');

        // Get references to slider input and value display pairs
        const sliderPairs = [
            { slider: staticInputs.currentAge, valueDisplay: document.getElementById('currentAgeValue'), unit: '' },
            { slider: staticInputs.bonusRate, valueDisplay: document.getElementById('bonusRateValue'), unit: '%' },
            { slider: staticInputs.my401kContributionRate, valueDisplay: document.getElementById('my401kContributionRateValue'), unit: '%' },
            { slider: staticInputs.company401kContributionRate, valueDisplay: document.getElementById('company401kContributionRateValue'), unit: '%' },
            { slider: staticInputs.annualSalaryRaise, valueDisplay: document.getElementById('annualSalaryRaiseValue'), unit: '%' },
            { slider: staticInputs.stockAppreciation, valueDisplay: document.getElementById('stockAppreciationValue'), unit: '%' },
            { slider: staticInputs.housingAppreciation, valueDisplay: document.getElementById('housingAppreciationValue'), unit: '%' },
            { slider: staticInputs.inflation, valueDisplay: document.getElementById('inflationValue'), unit: '%' },
            { slider: staticInputs.retirementDrawRate, valueDisplay: document.getElementById('retirementDrawRateValue'), unit: '%' },
            { slider: staticInputs.retirementYear, valueDisplay: document.getElementById('retirementYearValue'), unit: '' }
        ];

        // Function to format numbers as currency, rounded to nearest thousand, without K/M (for table)
        const formatTableCurrency = (amount) => {
            const roundedAmount = Math.round(amount / 1000) * 1000;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(roundedAmount);
        };

        // Function to format numbers as currency with K/M and specified decimal places (for summary displays)
        const formatLargeCurrency = (amount) => {
            if (Math.abs(amount) >= 1000000) {
                return `$${(amount / 1000000).toFixed(2)}M`;
            }
            if (Math.abs(amount) >= 1000) {
                return `$${(amount / 1000).toFixed(0)}K`;
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Function to format Y-axis labels dynamically based on max value in the chart
        function formatProjectedChartAxisLabel(value, maxChartValue) {
            if (maxChartValue < 5000000) { // If max value is under 5 million, show in thousands
                return `$${(value / 1000).toFixed(0)}K`; // No decimals for K
            } else { // Otherwise, show in millions
                return `$${(value / 1000000).toFixed(0)}M`; // No decimals for M
            }
        }

        // Function to update slider value display
        function updateSliderValueDisplay(slider, valueDisplay, unit) {
            const val = parseFloat(slider.value);
            valueDisplay.textContent = `${val.toFixed(slider.step === '0.1' || slider.step === '0.5' ? 1 : 0)}${unit}`;
        }

        // Firebase Initialization
        const initFirebase = async () => {
            console.log("Initializing Firebase...");
            try {
                // Ensure firebaseConfig is logged to confirm it's available
                console.log("Firebase Config:", firebaseConfig);

                // Initialize app and get services directly
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Get auth instance immediately

                // Use onAuthStateChanged to manage the authentication state.
                // This ensures we react to Firebase's internal auth state readiness.
                // We'll resolve this promise once an auth state is determined (signed in or anonymous).
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        // This callback fires when Firebase Auth is initialized and also on subsequent state changes.
                        // We only want to attempt sign-in if there's no active user.
                        if (!user) {
                            // If no user is signed in, attempt sign-in based on token or anonymously
                            if (initialAuthToken) {
                                console.log("Attempting sign-in with custom token...");
                                try {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    userId = auth.currentUser.uid;
                                    console.log("Firebase authenticated with custom token. User ID:", userId);
                                } catch (customTokenError) {
                                    console.warn("Custom token sign-in failed, falling back to anonymous:", customTokenError);
                                    // If custom token fails, try anonymous
                                    try {
                                        await signInAnonymously(auth);
                                        userId = auth.currentUser.uid;
                                        console.log("Firebase authenticated anonymously (after custom token fallback). User ID:", userId);
                                    } catch (anonError) {
                                        console.error("Anonymous sign-in failed:", anonError);
                                        unsubscribe(); // Unsubscribe even on failure
                                        reject(anonError); // Reject the promise if anonymous also fails
                                        return; // Exit to prevent further execution in this branch
                                    }
                                }
                            } else {
                                // No custom token, just try anonymous sign-in
                                console.log("Attempting anonymous sign-in...");
                                try {
                                    await signInAnonymously(auth);
                                    userId = auth.currentUser.uid;
                                    console.log("Firebase authenticated anonymously. User ID:", userId);
                                } catch (anonError) {
                                    console.error("Anonymous sign-in failed:", anonError);
                                    unsubscribe(); // Unsubscribe even on failure
                                    reject(anonError); // Reject the promise if anonymous fails
                                    return; // Exit to prevent further execution in this branch
                                }
                            }
                        } else {
                            // User is already signed in (either from a previous session or via __initial_auth_token)
                            userId = user.uid;
                            console.log("Firebase auth state detected existing user:", userId);
                        }
                        unsubscribe(); // Unsubscribe after the first relevant state change
                        resolve(); // Resolve the promise once auth state is settled
                    }, (error) => {
                        // Error during initial auth state observation
                        console.error("Error observing Firebase auth state:", error);
                        unsubscribe();
                        reject(error);
                    });
                });

                // Only proceed to setupRealtimeListener once authentication is confirmed
                setupRealtimeListener();
            } catch (error) {
                console.error("Critical error during Firebase initialization or authentication flow:", error);
                throw error; // Re-throw to be caught by the DOMContentLoaded catch block
            }
        };

        // Function to save data to Firestore
        async function saveDataToFirestore(data) {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Data not saved.");
                return;
            }
            // Prevent saving if the update came from Firestore itself
            if (window.isLoadingFromFirestore) {
                console.log("Skipping save: Data currently being loaded from Firestore.");
                return;
            }
            console.log("Attempting to save data to Firestore:", data);
            try {
                const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
                await setDoc(docRef, data, { merge: true }); // Merge to update specific fields
                console.log("Data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        /**
         * Gathers all current input values (static and dynamic) from the DOM.
         * This function is used to create a snapshot of the current UI state to save to Firestore.
         * @returns {Object} An object containing all current financial input data.
         */
        function collectAllCurrentInputs() {
            let collectedData = {};

            // Collect static input values
            for (const key in staticInputs) {
                let value;
                if (staticInputs[key].type === 'range') {
                    value = parseFloat(staticInputs[key].value);
                } else {
                    value = cleanInputNumber(staticInputs[key].value);
                }
                // Convert percentages to decimal for internal calculations and storage
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRate'].includes(key)) {
                    value = value / 100;
                }
                collectedData[key] = value;
            }

            // Collect dynamic investment account values
            collectedData.investmentAccounts = [];
            document.querySelectorAll('.investment-row').forEach(row => {
                const name = row.querySelector('.investment-name').value;
                const value = cleanInputNumber(row.querySelector('.investment-value').value);
                collectedData.investmentAccounts.push({ name, value });
            });

            // Collect dynamic other asset values
            collectedData.otherAssets = [];
            document.querySelectorAll('.other-asset-row').forEach(row => {
                const name = row.querySelector('.asset-name').value;
                const value = cleanInputNumber(row.querySelector('.asset-value').value);
                collectedData.otherAssets.push({ name, value });
            });

            // Collect dynamic liability values
            collectedData.liabilities = [];
            document.querySelectorAll('.liability-row').forEach(row => {
                const name = row.querySelector('.liability-name').value;
                const value = cleanInputNumber(row.querySelector('.liability-value').value);
                collectedData.liabilities.push({ name, value });
            });

            // Collect dynamic other income values
            collectedData.otherIncome = [];
            document.querySelectorAll('.other-income-row').forEach(row => {
                const name = row.querySelector('.income-name').value;
                const value = cleanInputNumber(row.querySelector('.income-value').value);
                const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
                collectedData.otherIncome.push({ name, value, escalationRate });
            });

            return collectedData;
        }


        // Function to set up real-time listener for data
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Cannot set up listener.");
                return;
            }
            console.log("Setting up real-time Firestore listener.");
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
            onSnapshot(docRef, async (docSnap) => { // Made async to allow awaiting `saveDataToFirestore`
                window.isLoadingFromFirestore = true; // Set flag when loading from Firestore
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Data loaded from Firestore:", data);
                    populateInputsFromFirestore(data);
                } else {
                    console.log("No shared data found in Firestore. Initializing with provided values and saving this state.");
                    // Explicitly clear dynamic inputs
                    investmentAccountsContainer.innerHTML = '';
                    otherAssetsContainer.innerHTML = '';
                    liabilitiesContainer.innerHTML = '';
                    otherIncomeContainer.innerHTML = '';

                    // Add dynamic rows with user-provided default values
                    defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
                    defaultOtherAssets.forEach(asset => addOtherAssetInput(asset));
                    defaultLiabilities.forEach(liability => addLiabilityInput(liability));
                    defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));


                    // Save this initial blank state to Firestore
                    await saveDataToFirestore(collectAllCurrentInputs());
                }
                window.isLoadingFromFirestore = false; // Reset flag after processing
            }, (error) => {
                console.error("Error listening to Firestore document:", error);
                calculateFinancials(false); // Fallback to local calculation
                window.isLoadingFromFirestore = false; // Reset flag on error
            });
        }

        // Function to populate inputs from Firestore data
        function populateInputsFromFirestore(data) {
            // Update static inputs
            for (const key in staticInputs) {
                if (data[key] !== undefined) {
                    let value = data[key];
                    // Special handling for percentage sliders to convert back to 0-100 range for display
                    if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRate'].includes(key)) {
                        value = parseFloat(value) * 100; // Convert decimal back to percentage for UI
                    }

                    if (staticInputs[key].type === 'range') {
                         staticInputs[key].value = value;
                    } else {
                         staticInputs[key].value = formatInputNumber(value);
                    }
                    // Update the visual display for sliders
                    const pair = sliderPairs.find(p => p.slider === staticInputs[key]);
                    if (pair) {
                        updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
                    }
                }
            }

            // Update dynamic inputs (investments, other assets, liabilities, other income)
            // Clear existing dynamic rows first to avoid duplicates
            investmentAccountsContainer.innerHTML = '';
            otherAssetsContainer.innerHTML = '';
            liabilitiesContainer.innerHTML = '';
            otherIncomeContainer.innerHTML = '';

            // Handle Investment Accounts
            if (data.investmentAccounts && data.investmentAccounts.length > 0) {
                data.investmentAccounts.forEach(account => addInvestmentAccountInput(account));
            } else {
                // If no data or empty array from Firestore, use predefined defaults
                defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
            }

            // Handle Other Assets
            if (data.otherAssets && data.otherAssets.length > 0) {
                data.otherAssets.forEach(asset => addOtherAssetInput(asset));
            } else {
                // If no data or empty array from Firestore, use predefined defaults
                defaultOtherAssets.forEach(asset => addOtherAssetInput(asset));
            }

            // Handle Liabilities
            if (data.liabilities && data.liabilities.length > 0) {
                data.liabilities.forEach(liability => addLiabilityInput(liability));
            } else {
                // If no data or empty array from Firestore, use predefined defaults
                defaultLiabilities.forEach(liability => addLiabilityInput(liability));
            }

            // Handle Other Income
            if (data.otherIncome && data.otherIncome.length > 0) {
                data.otherIncome.forEach(income => addOtherIncomeInput(income));
            } else {
                // If no data or empty array from Firestore, use predefined defaults
                defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
            }
            // --- END CHANGE ---

            // After populating, recalculate to update summaries and chart (but don't save yet)
            calculateFinancials(false);
        }

        // Function to add a new investment account input row
        function addInvestmentAccountInput(account = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('investment-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Account Name" value="${account.name}" class="input-field investment-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(account.value)}" class="input-field investment-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            investmentAccountsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.investment-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.investment-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new other asset input row
        function addOtherAssetInput(asset = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-asset-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Asset Name" value="${asset.name}" class="input-field asset-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(asset.value)}" class="input-field asset-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherAssetsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.asset-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.asset-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new liability input row
        function addLiabilityInput(liability = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('liability-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Liability Name" value="${liability.name}" class="input-field liability-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(liability.value)}" class="input-field liability-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            liabilitiesContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.liability-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.liability-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new other income input row
        function addOtherIncomeInput(income = { name: '', value: 0, escalationRate: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-income-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Income Source" value="${income.name}" class="input-field income-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Monthly Value ($)" value="${formatInputNumber(income.value)}" class="input-field income-value flex-1 min-w-[100px]">
                <div class="flex items-center">
                    <input type="number" placeholder="Escalation Rate" value="${(income.escalationRate * 100).toFixed(1)}" step="0.1" min="0" max="10" class="input-field income-escalation-rate w-24">
                    <span class="ml-1 text-gray-700">%</span>
                </div>
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherIncomeContainer.appendChild(rowDiv);

            // Attach event listeners for value and escalation rate, and for name changes
            rowDiv.querySelectorAll('input').forEach(input => {
                if (input.classList.contains('income-value')) {
                    input.addEventListener('input', (event) => {
                        event.target.value = formatInputNumber(event.target.value);
                        calculateFinancials(true); // Trigger save
                    });
                } else {
                    input.addEventListener('input', () => calculateFinancials(true)); // Trigger save for name/escalation
                }
            });

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Main calculation function (now accepts a shouldSave flag)
        function calculateFinancials(shouldSaveData = true) {
            let totalInvestments = 0;
            let totalOtherAssets = 0;
            let totalLiabilities = 0;
            let currentMortgageValue = 0;

            let currentFinancials = {}; // Object to store all inputs for saving

            // Collect static input values
            for (const key in staticInputs) {
                let value;
                if (staticInputs[key].type === 'range') {
                    value = parseFloat(staticInputs[key].value);
                } else { // Text inputs
                    value = cleanInputNumber(staticInputs[key].value);
                }
                // Convert percentages to decimal for internal calculations and storage
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRate'].includes(key)) {
                    value = value / 100;
                }
                currentFinancials[key] = value;
            }

            // Read dynamic investment account values
            currentFinancials.investmentAccounts = [];
            document.querySelectorAll('.investment-row').forEach(row => {
                const name = row.querySelector('.investment-name').value;
                const value = cleanInputNumber(row.querySelector('.investment-value').value);
                totalInvestments += value;
                currentFinancials.investmentAccounts.push({ name, value });
            });

            // Read dynamic other asset values
            currentFinancials.otherAssets = [];
            document.querySelectorAll('.other-asset-row').forEach(row => {
                const name = row.querySelector('.asset-name').value;
                const value = cleanInputNumber(row.querySelector('.asset-value').value);
                totalOtherAssets += value;
                currentFinancials.otherAssets.push({ name, value });
            });

            // Read dynamic liability values
            currentFinancials.liabilities = [];
            document.querySelectorAll('.liability-row').forEach(row => {
                const nameInput = row.querySelector('.liability-name');
                const valueInput = row.querySelector('.liability-value');
                const name = nameInput.value;
                const value = cleanInputNumber(valueInput.value);
                totalLiabilities += value;
                currentFinancials.liabilities.push({ name, value });

                if (name.toLowerCase() === "mortgage") {
                    currentMortgageValue = value;
                }
            });

            // Read dynamic other income values
            currentFinancials.otherIncome = [];
            let totalOtherMonthlyIncome = 0;
            document.querySelectorAll('.other-income-row').forEach(row => {
                const name = row.querySelector('.income-name').value;
                const value = cleanInputNumber(row.querySelector('.income-value').value);
                const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
                currentFinancials.otherIncome.push({ name, value, escalationRate });
                totalOtherMonthlyIncome += value;
            });

            // Re-read values from currentFinancials for calculations to ensure consistency with what's being saved
            const currentAge = currentFinancials.currentAge;
            const baseSalary = currentFinancials.baseSalary;
            const bonusRate = currentFinancials.bonusRate;
            const my401kContributionRate = currentFinancials.my401kContributionRate;
            const company401kContributionRate = currentFinancials.company401kContributionRate;
            const annualRothContribution = currentFinancials.annualRothContribution;
            const monthly529Contribution = currentFinancials.monthly529Contribution;
            const monthlyHSAContribution = currentFinancials.monthlyHSAContribution;
            const annualSalaryRaise = currentFinancials.annualSalaryRaise;
            const stockAppreciation = currentFinancials.stockAppreciation;
            const housingAppreciation = currentFinancials.housingAppreciation;
            const inflation = currentFinancials.inflation;
            const retirementDrawRate = currentFinancials.retirementDrawRate;
            const retirementYear = currentFinancials.retirementYear; // This is the dynamic retirement age
            const monthlyPrincipalPayment = currentFinancials.monthlyPrincipalPayment;
            const annualPrincipalPayment = monthlyPrincipalPayment * 12;

            // Update min for retirementYear slider dynamically based on currentAge
            staticInputs.retirementYear.min = currentAge;
            if (retirementYear < currentAge) {
                staticInputs.retirementYear.value = currentAge;
            }

            // Update slider value displays (already done in populateInputsFromFirestore or event listeners)
            sliderPairs.forEach(pair => {
                updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
            });

            // Update dynamic retirement draw labels based on slider value
            dynamicRetirementDrawLabel.textContent = `${retirementYear} YO Draw (Today's $):`;
            dynamicRetirementDrawLabelSticky.textContent = `${retirementYear} YO Draw (Today's $):`;


            // Calculate Net Worth and Net Investments
            const currentTotalAssets = totalInvestments + totalOtherAssets;
            const currentNetWorth = currentTotalAssets - totalLiabilities;
            const currentNetInvestments = totalInvestments;

            // Calculate Annual Income
            const annualBonusIncome = baseSalary * bonusRate;
            const totalAnnualOtherIncome = totalOtherMonthlyIncome * 12;
            const totalAnnualIncome = baseSalary + annualBonusIncome + totalAnnualOtherIncome;

            // Calculate Total Annual Savings
            const totalAnnualSavings =
                (baseSalary * my401kContributionRate) +
                (baseSalary * company401kContributionRate) +
                (monthly529Contribution * 12) +
                (monthlyHSAContribution * 12) +
                annualRothContribution +
                (monthlyPrincipalPayment * 12);

            // Display current values using new formatting
            currentNetWorthDisplay.textContent = formatLargeCurrency(currentNetWorth);
            currentNetInvestmentsDisplay.textContent = formatLargeCurrency(currentNetInvestments);
            annualIncomeDisplay.textContent = formatLargeCurrency(totalAnnualIncome);
            annualSavingsDisplay.textContent = formatLargeCurrency(totalAnnualSavings);

            // Update the summary spans
            totalInvestmentsSummary.textContent = `(${formatLargeCurrency(totalInvestments)})`;
            totalOtherAssetsSummary.textContent = `(${formatLargeCurrency(totalOtherAssets)})`;
            totalLiabilitiesSummary.textContent = `(${formatLargeCurrency(totalLiabilities)})`;

            // Project growth over years
            projectGrowth(currentNetInvestments, currentNetWorth,
                          currentFinancials.otherAssets.find(asset => asset.name === "Home Value")?.value || 0,
                          totalLiabilities, currentMortgageValue, baseSalary,
                          bonusRate, my401kContributionRate, company401kContributionRate,
                          annualRothContribution, monthly529Contribution, monthlyHSAContribution,
                          annualSalaryRaise, stockAppreciation,
                          housingAppreciation, inflation, annualPrincipalPayment,
                          currentFinancials.otherIncome, // Pass the collected current other income state
                          currentFinancials.otherAssets.find(asset => asset.name === "Other Equity (car, tractor, camper)")?.value || 0,
                          currentAge,
                          retirementDrawRate, todaysDrawDisplay, dynamicRetirementDrawValue, sixtyTwoYODrawDisplay,
                          retirementYear, // Pass the dynamic retirement year
                          dynamicRetirementDrawValueSticky, // Pass the sticky element for update
                          totalAnnualOtherIncome);

            // Trigger saving if flag is true AND it's not from a Firestore load
            if (shouldSaveData && !window.isLoadingFromFirestore) {
                saveDataToFirestore(currentFinancials);
            }
        }


        function projectGrowth(initialNetInvestments, initialNetWorth, initialHomeValue, initialTotalLiabilities, initialMortgageValue, initialBaseSalary,
                               bonusRate, my401kContributionRate, company401kContributionRate,
                               annualRothContribution, monthly529Contribution, monthlyHSAContribution,
                               annualSalaryRaise, stockAppreciation,
                               housingAppreciation, inflation, annualPrincipalPayment,
                               currentOtherIncomesStateForProjection,
                               otherEquityValueFromInitialAssets,
                               initialAge,
                               retirementDrawRate, todaysDrawDisplay, dynamicRetirementDrawValue, sixtyTwoYODrawDisplay,
                               retirementYearInput, dynamicRetirementDrawValueSticky, initialTotalOtherAnnualIncome) {

            projectionTableBody.innerHTML = '';
            chartContainer.innerHTML = '';

            let currentInvestments = initialNetInvestments;
            let currentHomeValue = initialHomeValue;
            let currentMortgage = initialMortgageValue;
            let currentOtherLiabilitiesTotal = initialTotalLiabilities - initialMortgageValue;
            let currentBaseSalary = initialBaseSalary;
            let currentOtherEquity = otherEquityValueFromInitialAssets; 

            const startYear = new Date().getFullYear();
            let currentProjectedAge = initialAge;

            let projectedOtherIncomes = JSON.parse(JSON.stringify(currentOtherIncomesStateForProjection));
            const inflationRate = inflation;

            const chartData = [];

            const todaysDrawValue = (initialNetInvestments * retirementDrawRate) + initialTotalOtherAnnualIncome;
            todaysDrawDisplay.textContent = formatLargeCurrency(todaysDrawValue);

            chartData.push({
                age: initialAge,
                investments: initialNetInvestments,
                netWorth: initialNetWorth / Math.pow((1 + inflationRate), 0)
            });

            for (let i = 1; currentProjectedAge <= 80; i++) {
                const year = startYear + i;
                const age = currentProjectedAge;

                let annualMy401kContributionCurrentYear = 0;
                let annualCompany401kContributionCurrentYear = 0;
                let annual529ContributionCurrentYear = 0;
                let annualHSAContributionCurrentYear = 0;
                let annualRothContributionCurrentYear = 0;

                if (age < retirementYearInput) {
                    annualMy401kContributionCurrentYear = currentBaseSalary * my401kContributionRate;
                    annualCompany401kContributionCurrentYear = currentBaseSalary * company401kContributionRate;
                    annual529ContributionCurrentYear = monthly529Contribution * 12;
                    annualHSAContributionCurrentYear = monthlyHSAContribution * 12;
                    annualRothContributionCurrentYear = annualRothContribution;
                }
                
                currentInvestments *= (1 + stockAppreciation);

                let currentAnnualOtherIncome = 0;
                projectedOtherIncomes.forEach(income => {
                    income.value *= (1 + income.escalationRate);
                    if (income.name.toLowerCase().includes("rental") && income.escalationRate > 0) {
                        income.value = Math.floor(income.value / 100) * 100;
                    }
                    currentAnnualOtherIncome += income.value * 12;
                });

                currentInvestments += annualMy401kContributionCurrentYear;
                currentInvestments += annualCompany401kContributionCurrentYear;
                currentInvestments += annual529ContributionCurrentYear;
                currentInvestments += annualHSAContributionCurrentYear;
                currentInvestments += annualRothContributionCurrentYear;
                currentInvestments += currentAnnualOtherIncome;

                // Apply draw if at or after retirement year
                if (age >= retirementYearInput) {
                    const annualDrawAmount = 100000 * Math.pow((1 + inflationRate), i); 
                    currentInvestments -= annualDrawAmount;
                }

                // Update the dynamic retirement draw value when the specific retirement year is reached
                if (age === retirementYearInput) {
                    const drawValue = (currentInvestments * retirementDrawRate) + currentAnnualOtherIncome;
                    const drawValueInTodaysDollars = drawValue / Math.pow((1 + inflationRate), i);
                    dynamicRetirementDrawValue.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                    dynamicRetirementDrawValueSticky.textContent = formatLargeCurrency(drawValueInTodaysDollars); // Update sticky value
                }

                // Keep 62 YO Draw display as a separate fixed value for comparison
                if (age === 62) {
                    const drawValue = (currentInvestments * retirementDrawRate) + currentAnnualOtherIncome;
                    const drawValueInTodaysDollars = drawValue / Math.pow((1 + inflationRate), i);
                    sixtyTwoYODrawDisplay.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                }

                currentHomeValue *= (1 + housingAppreciation);
                currentMortgage = Math.max(0, currentMortgage - annualPrincipalPayment);

                const currentHomeEquity = currentHomeValue - currentMortgage;
                const currentTotalLiabilitiesInProjection = currentMortgage + currentOtherLiabilitiesTotal;
                let currentNetWorth = currentInvestments + currentHomeEquity + currentOtherEquity - currentTotalLiabilitiesInProjection;
                const netWorthInTodaysDollars = currentNetWorth / Math.pow((1 + inflationRate), i);

                chartData.push({
                    age: age,
                    investments: currentInvestments,
                    netWorth: netWorthInTodaysDollars
                });

                const row = projectionTableBody.insertRow();
                row.classList.add('hover:bg-blue-50');

                if (age % 5 === 0) {
                    row.classList.add('bg-blue-100');
                }

                row.insertCell().textContent = age;
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatTableCurrency(currentInvestments);
                row.insertCell().textContent = formatTableCurrency(currentNetWorth);
                row.insertCell().textContent = formatTableCurrency(netWorthInTodaysDollars);

                if (age < retirementYearInput) {
                    currentBaseSalary *= (1 + annualSalaryRaise);
                }
                
                currentProjectedAge++;
            }
            renderChart(chartData);
        }

        // D3.js Chart Rendering Function for Projected Growth
        function renderChart(data) {
            d3.select(chartContainer).select("svg").remove();

            const parentWidth = chartContainer.offsetWidth;
            const margin = { top: 40, right: 60, bottom: 50, left: 80 };
            const width = parentWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(chartContainer).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("class", "chart-svg")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.age))
                .range([0, width]);

            const yMax = d3.max(data, d => Math.max(d.investments, d.netWorth));
            const yMin = d3.min(data, d => Math.min(d.investments, d.netWorth));

            const yScale = d3.scaleLinear()
                .domain([yMin * 0.95, yMax * 1.05])
                .range([height, 0]);

            const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
            const yAxis = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));


            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                );

            const lineInvestments = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.investments));

            const lineNetWorth = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.netWorth));

            svg.append("path")
                .datum(data)
                .attr("class", "line line-investments")
                .attr("fill", "none")
                .attr("d", lineInvestments);

            svg.append("path")
                .datum(data)
                .attr("class", "line line-networth")
                .attr("fill", "none")
                .attr("d", lineNetWorth);

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Age");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 20)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Value ($)");

            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .text("Projected Investments & Net Worth");

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute");

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .on("mouseover", function() { focusInvestment.style("display", null); focusNetWorth.style("display", null); tooltip.style("opacity", 1); })
                .on("mouseout", function() { focusInvestment.style("display", "none"); focusNetWorth.style("display", "none"); tooltip.style("opacity", 0); })
                .on("mousemove", mousemove);

            const focusInvestment = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusInvestment.append("circle")
                .attr("r", 5)
                .attr("fill", "#2563eb");

            const focusNetWorth = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusNetWorth.append("circle")
                .attr("r", 5)
                .attr("fill", "#10b981");

            function mousemove(event) {
                const x0 = xScale.invert(d3.pointer(event)[0]);
                const bisect = d3.bisector(d => d.age).left;
                const i = bisect(data, x0, 1);
                const d0 = data[i - 1];
                const d1 = data[i];
                const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

                focusInvestment.attr("transform", `translate(${xScale(d.age)},${yScale(d.investments)})`);
                focusNetWorth.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorth)})`);

                tooltip.html(`Age: ${d.age}<br>Investments: ${formatTableCurrency(d.investments)}<br>Net Worth (Today's $): ${formatTableCurrency(d.netWorth)}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            }
            chartContainer.__chartData__ = data; // Store data for resize handling
        }


        // Add event listeners to all static input fields
        for (const key in staticInputs) {
            // All changes to static inputs trigger save
            staticInputs[key].addEventListener('input', () => calculateFinancials(true));
            // Add specific input formatting for relevant fields
            if (staticInputs[key].type === 'text') {
                 staticInputs[key].addEventListener('input', (event) => {
                    const rawValue = event.target.value;
                    event.target.value = formatInputNumber(rawValue);
                });
            }
        }

        // Add event listener for adding new investment accounts
        addInvestmentBtn.addEventListener('click', () => { addInvestmentAccountInput(); calculateFinancials(true); });
        // Add event listener for adding new other asset accounts
        addOtherAssetBtn.addEventListener('click', () => { addOtherAssetInput(); calculateFinancials(true); });
        // Add event listener for adding new liability accounts
        addLiabilityBtn.addEventListener('click', () => { addLiabilityInput(); calculateFinancials(true); });
        // Add event listener for adding new other income accounts
        addOtherIncomeBtn.addEventListener('click', () => { addOtherIncomeInput(); calculateFinancials(true); });

        // Attach event listeners for slider value display updates and trigger save
        sliderPairs.forEach(pair => {
            pair.slider.addEventListener('input', () => updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit));
            pair.slider.addEventListener('change', () => calculateFinancials(true)); // Change also triggers save
            // Initial display update handled by populateInputsFromFirestore
        });

        // Function to handle sticky header on scroll for mobile
        function handleMobileStickyHeader() {
            const stickyElement = document.getElementById('dynamicRetirementDrawSticky'); // Updated ID
            const leftStickyBanner = document.getElementById('leftStickyBanner');
            // Only apply on mobile (less than 1024px width, which is the 'lg' breakpoint in Tailwind)
            if (window.innerWidth < 1024 && stickyElement && leftStickyBanner) {
                // Get the bottom of the initial banner
                const bannerBottom = leftStickyBanner.offsetHeight;
                // If the user has scrolled past the banner, make it sticky
                if (window.scrollY > bannerBottom) {
                    stickyElement.classList.remove('hidden'); // Show the sticky element
                    stickyElement.classList.add('mobile-sticky-draw');
                } else {
                    stickyElement.classList.add('hidden'); // Hide the sticky element
                    stickyElement.classList.remove('mobile-sticky-draw');
                }
            } else if (stickyElement) {
                // Ensure it's not sticky and hidden on desktop
                stickyElement.classList.add('hidden');
                stickyElement.classList.remove('mobile-sticky-draw');
            }
        }


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Display the current application revision
            if (appRevisionDisplay) {
                appRevisionDisplay.textContent = `v${appRevision}`;
            }

            // Attempt Firebase initialization
            initFirebase().then(() => {
                // Firebase init successful and listener set up, data should be populated by onSnapshot
                // No need to manually add initial rows here if Firestore will handle it.
            }).catch(() => {
                // Firebase init failed or auth failed, explicitly add one blank row for each dynamic section
                // so the 'Add' buttons are functional for manual input.
                console.warn("Firebase initialization failed, initializing dynamic inputs with blank rows for local use.");
                investmentAccountsContainer.innerHTML = ''; // Clear existing
                otherAssetsContainer.innerHTML = '';
                liabilitiesContainer.innerHTML = '';
                otherIncomeContainer.innerHTML = '';

                // If Firebase fails, use all defaults for dynamic sections
                defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
                defaultOtherAssets.forEach(asset => addOtherAssetInput(asset));
                defaultLiabilities.forEach(liability => addLiabilityInput(liability));
                defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
                
                calculateFinancials(false); // Calculate based on initial blank inputs, don't save.
            });

            // Re-render charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                const projectedData = chartContainer.__chartData__;
                if (projectedData) {
                    renderChart(projectedData);
                }
                handleMobileStickyHeader(); // Adjust sticky header on resize
            });

            // Add scroll listener for sticky header on mobile
            window.addEventListener('scroll', handleMobileStickyHeader);
        });
    </script>
    <style>
        /* Custom styles for the Inter font and overall aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Dark slate gray for text */
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px; /* Track height */
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
            margin: 0;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; /* Standard thumb size */
            height: 20px; /* Standard thumb size */
            border-radius: 50%;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2; /* Ensure thumb is above track */
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; /* Standard thumb size */
            height: 20px; /* Standard thumb size */
            border-radius: 50%;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2; /* Ensure thumb is above track */
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .rounded-lg {
            border-radius: 0.75rem;
        }
        /* Custom styling for inputs */
        .input-field {
            @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline;
        }
        .label-style {
            @apply block text-gray-700 text-sm font-bold mb-1; /* Reduced mb for labels */
        }
        /* Table row hover effect */
        tbody tr:hover {
            background-color: #e0f2fe; /* Light blue on hover */
        }

        /* Slider value display wrapper */
        .slider-input-wrapper {
            display: flex; /* Use flexbox for horizontal alignment */
            align-items: center; /* Vertically center items */
            margin-bottom: 0.5rem; /* Space between slider groups */
            /* No fixed height needed as content flows horizontally */
            /* Removed padding-top as value is no longer above thumb */
        }

        /* Value display to the left of the slider */
        .slider-value-display {
            /* No longer absolute positioning */
            position: static;
            width: 60px; /* Fixed width to accommodate values like "88.8%" */
            text-align: right; /* Align text to the right */
            margin-right: 8px; /* Space between value and slider */
            color: #334155; /* Text color to match body */
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0; /* Prevent it from shrinking */
        }
        /* Make the slider take up remaining space */
        .slider-input-wrapper input[type="range"] {
            flex-grow: 1;
            width: auto; /* Override w-full from Tailwind */
            margin: 0; /* Reset margins */
        }


        /* D3 Chart Specific Styles */
        .chart-svg {
            display: block;
            margin: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .line {
            fill: none;
            stroke-width: 3px;
        }
        .line-investments {
            stroke: #2563eb; /* Blue for investments */
        }
        .line-networth {
            stroke: #10b981; /* Green for net worth */
        }
        .axis text {
            font-size: 0.8rem;
            fill: #6b7280; /* Gray text for axes */
        }
        .axis path, .axis line {
            stroke: #d1d5db; /* Light gray for axis lines */
            stroke-width: 1px;
        }
        .grid line {
            stroke: #e5e7eb; /* Even lighter gray for grid lines */
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            color: #333;
        }

        /* Responsive adjustments for the sticky banner and main content */
        @media (max-width: 1023px) { /* Adjust for screens smaller than 'lg' breakpoint (1024px) */
            #leftStickyBanner {
                width: 100%;
                height: auto;
                position: relative; /* Not sticky on mobile */
                top: auto;
                left: auto;
                flex-direction: row; /* Horizontal layout for mobile */
                flex-wrap: wrap; /* Allow items to wrap */
                justify-content: center; /* Center items horizontally */
                align-items: flex-start; /* Align items to the top */
                padding: 1rem; /* Smaller padding for mobile */
                box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Add shadow to top banner */
            }
            #leftStickyBanner h2 {
                font-size: 1.5rem; /* Smaller title on mobile */
                margin-bottom: 0.5rem;
                width: 100%; /* Take full width for title */
            }
            #leftStickyBanner .summary-item {
                flex: 1 1 auto; /* Allow items to grow and shrink, wrap as needed */
                min-width: 100px; /* Minimum width for each item to prevent too much squishing */
                margin-bottom: 0.5rem;
                padding: 0 0.5rem; /* Add horizontal padding to items */
            }
            #leftStickyBanner .summary-item p {
                font-size: 0.8rem; /* Smaller text for mobile */
            }
            #leftStickyBanner .summary-item p:last-child {
                font-size: 1.1rem; /* Smaller value for mobile */
            }
            /* main-content-wrapper no longer needs specific margin-top on mobile */
            .flex-1.p-4.md\:p-8.lg\:ml-64 {
                margin-top: 0;
            }

            /* Mobile-only sticky dynamic retirement draw */
            .mobile-sticky-draw {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: #1e3a8a; /* Darker blue for sticky header */
                color: white;
                text-align: center;
                padding: 0.5rem 0;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
        }
        /* Make the main container full width on mobile */
        .container.mx-auto {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* For lg and up (desktop) */
        @media (min-width: 1024px) {
            #leftStickyBanner {
                width: 16rem; /* Tailwind's w-64 */
                height: 100vh; /* Full viewport height */
                position: fixed; /* Sticky on desktop */
                top: 0;
                left: 0;
                flex-direction: column; /* Vertical layout for desktop */
                justify-content: flex-start; /* Align items to the top */
                align-items: center;
                padding: 1.5rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Original shadow */
            }
            #leftStickyBanner h2 {
                font-size: 1.875rem; /* Tailwind text-3xl */
                margin-bottom: 2rem; /* Tailwind mb-8 */
                width: auto;
            }
            #leftStickyBanner .summary-item {
                flex: none; /* Don't allow items to grow/shrink based on space */
                width: auto; /* Take natural width */
                margin-bottom: 1rem; /* Tailwind mb-4 */
                padding: 0;
            }
            #leftStickyBanner .summary-item p {
                font-size: 1.125rem; /* Tailwind text-xl */
            }
            #leftStickyBanner .summary-item p:last-child {
                font-size: 1.875rem; /* Tailwind text-3xl */
            }
            .flex-1.p-4.md\:p-8.lg\:ml-64 { /* Corrected class for main content wrapper */
                margin-left: 16rem; /* Tailwind's ml-64 */
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Snapshot Banner (not sticky on mobile, sticky on left for desktop) -->
    <div id="leftStickyBanner" class="
        relative w-full h-auto bg-blue-800 text-white p-4 shadow-xl flex flex-row flex-wrap justify-center items-start z-50
        lg:fixed lg:top-0 lg:left-0 lg:h-screen lg:w-64 lg:flex-col lg:items-center lg:justify-start lg:p-6 lg:shadow-2xl lg:overflow-y-auto
    ">
        <h2 class="text-xl font-extrabold mb-4 text-center text-white w-full lg:text-3xl lg:mb-8">Your Snapshot</h2>
        <span id="appRevisionDisplay" class="text-xs text-blue-200 font-semibold mb-4 lg:mb-6">v1.7</span>
        <!-- Each summary item will be a div -->
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Worth:</p>
            <p id="currentNetWorth" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Investments:</p>
            <p id="currentNetInvestments" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Income:</p>
            <p id="annualIncomeDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Savings:</p>
            <p id="annualSavingsDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Today's Draw:</p>
            <p id="todaysDraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg" id="dynamicRetirementDrawLabel">Retirement Draw (Today's $):</p>
            <p id="dynamicRetirementDrawValue" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">62 YO Draw (Today's $):</p>
            <p id="sixtyTwoYODraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
    </div>

    <!-- Mobile-only sticky dynamic retirement draw display (initially hidden) -->
    <div id="dynamicRetirementDrawSticky" class="hidden text-center mb-2 w-full bg-blue-800 text-white p-2">
        <p class="text-sm font-bold text-blue-200" id="dynamicRetirementDrawLabelSticky">Retirement Draw (Today's $):</p>
        <p id="dynamicRetirementDrawValueSticky" class="text-xl font-semibold text-white">$0</p>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-4 md:p-8 lg:ml-64">
        <div class="w-full bg-white rounded-lg shadow-xl p-4 md:p-8">
            <h1 class="text-4xl font-extrabold mb-4 text-center text-blue-800">Retirement Plan Calculator</h1>

            <!-- Section 1: Current Financials & Assumptions -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <!-- Collapsible Section: Assets, Investments, and Liabilities -->
                <details open>
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        1. Assets, Investments, and Liabilities
                    </summary>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Investment Accounts (Dynamic) -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Investment Accounts <span class="font-bold text-green-600" id="totalInvestmentsSummary"></span></h3>
                            <div id="investmentAccountsContainer" class="mb-4 space-y-4">
                                <!-- Dynamic investment inputs will be added here by JavaScript -->
                            </div>
                            <button id="addInvestmentBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Investment Account
                            </button>
                        </div>

                        <!-- Other Assets -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Other Assets <span class="font-bold text-green-600" id="totalOtherAssetsSummary"></span></h3>
                            <div id="otherAssetsContainer" class="mb-4 space-y-4">
                                <!-- Dynamic other assets inputs will be added here by JavaScript -->
                            </div>
                            <button id="addOtherAssetBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Asset
                            </button>

                            <!-- Liabilities - Moved here, no longer spanning two columns -->
                            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Liabilities <span class="font-bold text-red-600" id="totalLiabilitiesSummary"></span></h3>
                            <div id="liabilitiesContainer" class="mb-4 space-y-4">
                                <!-- Dynamic liability inputs will be added here by JavaScript -->
                            </div>
                            <button id="addLiabilityBtn" type="button" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Liability
                            </button>
                        </div>
                    </div>
                </details>

                <!-- Collapsible Section: Income, Savings, and Assumptions -->
                <details open class="mt-8">
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        2. Income, Savings, and Assumptions
                    </summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Income & Contribution Assumptions</h3>
                            <div class="mb-2"> <!-- Reduced margin-bottom for condensed sliders -->
                                <label for="currentAge" class="label-style">Current Age</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="currentAgeValue"></span>
                                    <input type="range" id="currentAge" min="18" max="100" value="38" step="1" class="w-full">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="baseSalary" class="label-style">Base Salary ($)</label>
                                <input type="text" id="baseSalary" value="179386" class="input-field">
                            </div>

                            <div class="mb-2">
                                <label for="bonusRate" class="label-style">Bonus Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="bonusRateValue"></span>
                                    <input type="range" id="bonusRate" min="0" max="50" value="23" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="my401kContributionRate" class="label-style">My 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="my401kContributionRateValue"></span>
                                    <input type="range" id="my401kContributionRate" min="0" max="20" value="13" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="company401kContributionRate" class="label-style">Company 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="company401kContributionRateValue"></span>
                                    <input type="range" id="company401kContributionRate" min="0" max="20" value="10" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthly529Contribution" class="label-style">Monthly 529 Contribution ($)</label>
                                <input type="text" id="monthly529Contribution" value="400" class="input-field">
                            </div>
                            <div class="mb-4">
                                <label for="monthlyHSAContribution" class="label-style">Monthly HSA Contribution ($)</label>
                                <input type="text" id="monthlyHSAContribution" value="600" class="input-field">
                            </div>

                            <div class="mb-4">
                                <label for="annualRothContribution" class="label-style">Other Annual Savings Contribution ($)</label>
                                <input type="text" id="annualRothContribution" value="25000" class="input-field">
                            </div>
                            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Other Income (Continues Post-Retirement)</h3>
                            <!-- Labels for Other Income inputs -->
                            <div class="flex items-center text-sm font-semibold mb-2 ml-2">
                                <div class="flex-1 min-w-[120px]">Income Description</div>
                                <div class="flex-1 min-w-[100px]">Monthly Amount</div>
                                <div class="w-24 ml-1">Annual Escalation</div>
                                <div class="w-6"></div> <!-- Spacer for delete button -->
                            </div>
                            <div id="otherIncomeContainer" class="mb-4 space-y-4">
                                <!-- Dynamic other income inputs will be added here by JavaScript -->
                            </div>
                            <button id="addOtherIncomeBtn" type="button" class="mt-4 bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Income
                            </button>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Growth & Expense Assumptions</h3>
                            <div class="mb-2">
                                <label for="annualSalaryRaise" class="label-style">Annual Salary Raise (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="annualSalaryRaiseValue"></span>
                                    <input type="range" id="annualSalaryRaise" min="0" max="10" value="3.8" step="0.1" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="stockAppreciation" class="label-style">Stock Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="stockAppreciationValue"></span>
                                    <input type="range" id="stockAppreciation" min="0" max="15" value="10" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="housingAppreciation" class="label-style">Housing Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="housingAppreciationValue"></span>
                                    <input type="range" id="housingAppreciation" min="0" max="10" value="4" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="inflation" class="label-style">Inflation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="inflationValue"></span>
                                    <input type="range" id="inflation" min="0" max="10" value="3" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="retirementDrawRate" class="label-style">Retirement Draw (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="retirementDrawRateValue"></span>
                                    <input type="range" id="retirementDrawRate" min="0" max="10" value="7" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="retirementYear" class="label-style">Retirement Year (Age)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="retirementYearValue"></span>
                                    <input type="range" id="retirementYear" min="38" max="80" value="45" step="1" class="w-full">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthlyPrincipalPayment" class="label-style">Monthly Principal Payment ($)</label>
                                <input type="text" id="monthlyPrincipalPayment" value="1428" class="input-field">
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Section 3: Projected Growth Chart -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">3. Projected Growth Chart</h2>
                <div id="chart-container" class="w-full overflow-x-auto">
                    <!-- D3.js chart will be rendered here -->
                </div>
                <div class="flex justify-center mt-4 space-x-6 text-gray-700 font-semibold">
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #2563eb;"></span>
                        Net Investments
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #10b981;"></span>
                        Net Worth (Today's $)
                    </div>
                </div>
            </div>

            <!-- Section 4: Growth Projection Table -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">4. Projected Growth Table</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-blue-600 text-white uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Age</th>
                                <th class="py-3 px-6 text-left">Year</th>
                                <th class="py-3 px-6 text-left">Investments</th>
                                <th class="py-3 px-6 text-left">Net Worth</th>
                                <th class="py-3 px-6 text-left">Net Worth (Today's $)</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTableBody" class="text-gray-700 text-sm font-light divide-y divide-gray-200">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
