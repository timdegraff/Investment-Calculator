<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /*
    Prepopulated Default Values for Reference (dynamically created if Firestore is empty):

    const defaultInvestmentAccounts = [
        { name: "401K", value: 527030 },
        { name: "Roth 1", value: 178181 },
        { name: "Roth 2", value: 157347 },
        { name: "HSA", value: 25340 },
        { name: "Gold", value: 6600 }
    ];

    const defaultHomes = [
        { name: "Personal Home", value: 1017000 }
    ];

    const defaultOtherStaticAssets = [
        { name: "Suburban", value: 32000 },
        { name: "Tractor", value: 16000 },
        { name: "RV", value: 25000 },
        { name: "Checking", value: 16296 }
    ];

    const defaultLiabilities = [
        { name: "Home Mortgage", value: 203000 },
        { name: "Credit Cards", value: 0 }
    ];

    const defaultOtherIncomes = [
        { name: "Cell Tower Lease", value: 1200, escalationRate: 0.015 },
        { name: "Rental Income", value: 1300, escalationRate: 0.04 }
    ];
    */

    // Firebase configuration (uses Canvas globals or hardcoded fallback)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyCC1UKUPFRUnWyQ09hGFkJxVEVBBkZ7X40",
        authDomain: "investment-calculator-931f2.firebaseapp.com",
        projectId: "investment-calculator-931f2",
        storageBucket: "investment-calculator-931f2.firebasestorage.app",
        messagingSenderId: "943895110805",
        appId: "1:943895110805:web:ba6e1e6177ae31d7af279c",
        measurementId: "G-F0CRPKLS7G"
    };

    // Canvas-provided auth token or null for anonymous sign-in
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Canvas-provided appId or derived from hardcoded config
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

    // Revision Level
    const appRevision = "1.41";


    let app;
    let db;
    let auth;
    let userId;

    const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/retirement_calculator`;
    const SHARED_DOC_ID = 'shared_inputs';

    // IRS Uniform Lifetime Table for 72(t) calculations
    const irsLifeExpectancyTable = {
        38: 46.5, 39: 45.5, 40: 44.6, 41: 43.6, 42: 42.6, 43: 41.7, 44: 40.7, 45: 39.8,
        46: 38.8, 47: 37.9, 48: 36.9, 49: 36.0, 50: 35.0, 51: 34.1, 52: 33.1, 53: 32.2,
        54: 31.2, 55: 30.3, 56: 29.3, 57: 28.4, 58: 27.4, 59: 26.5, 60: 25.5, 61: 24.6,
        62: 23.6, 63: 22.7, 64: 21.8, 65: 20.8, 66: 19.9, 67: 19.0, 68: 18.1, 69: 17.2,
        70: 16.3, 71: 15.5, 72: 14.7, 73: 13.9, 74: 13.1, 75: 12.4, 76: 11.6, 77: 10.9,
        78: 10.1, 79: 9.4, 80: 8.7, 81: 8.1, 82: 7.6, 83: 7.1, 84: 6.6, 85: 6.2,
        86: 5.8, 87: 5.5, 88: 5.2, 89: 4.9, 90: 4.6, 91: 4.3, 92: 4.1, 93: 3.9,
        94: 3.7, 95: 3.5, 96: 3.4, 97: 3.2, 98: 3.0, 99: 2.9, 100: 2.8, 101: 2.6,
        102: 2.5, 103: 2.4, 104: 2.3, 105: 2.2, 106: 2.1, 107: 2.0, 108: 1.9, 109: 1.8,
        110: 1.7, 111: 1.6, 112: 1.5, 113: 1.4, 114: 1.3, 115: 1.2, 116: 1.1, 117: 1.0,
        118: 0.9, 119: 0.8, 120: 0.7
    };

    window.isLoadingFromFirestore = false;

    // Formats number to currency string with commas
    function formatInputNumber(value) {
        if (value === null || value === undefined || value === '') return '';
        let num = Number(String(value).replace(/,/g, ''));
        if (isNaN(num)) return '';
        return new Intl.NumberFormat('en-US').format(num);
    }

    // Cleans currency string to number
    function cleanInputNumber(stringValue) {
        if (stringValue === null || stringValue === undefined || stringValue === '') return 0;
        const cleaned = String(stringValue).replace(/[^\d.-]/g, '');
        return parseFloat(cleaned) || 0;
    }

    // References to static input elements
    const staticInputs = {
        currentAge: document.getElementById('currentAge'),
        baseSalary: document.getElementById('baseSalary'),
        bonusRate: document.getElementById('bonusRate'),
        my401kContributionRate: document.getElementById('my401kContributionRate'),
        company401kContributionRate: document.getElementById('company401kContributionRate'),
        annualRothContribution: document.getElementById('annualRothContribution'),
        monthlyHSAContribution: document.getElementById('monthlyHSAContribution'),
        annualSalaryRaise: document.getElementById('annualSalaryRaise'),
        stockAppreciation: document.getElementById('stockAppreciation'),
        housingAppreciation: document.getElementById('housingAppreciation'),
        inflation: document.getElementById('inflation'),
        retirementDrawRatePre62: document.getElementById('retirementDrawRatePre62'),
        retirementDrawRatePost62: document.getElementById('retirementDrawRatePost62'),
        retirementYear: document.getElementById('retirementYear'),
        monthlyPrincipalPayment: document.getElementById('monthlyPrincipalPayment'),
        socialSecurityStartAge: document.getElementById('socialSecurityStartAge'),
        socialSecurityMonthly: document.getElementById('socialSecurityMonthly'),
        seventyTwoTStartAge: document.getElementById('seventyTwoTStartAge'),
        seventyTwoTInterestRate: document.getElementById('seventyTwoTInterestRate')
    };

    // References to display elements
    const currentNetWorthDisplay = document.getElementById('currentNetWorth');
    const currentNetInvestmentsDisplay = document.getElementById('currentNetInvestments');
    const annualIncomeDisplay = document.getElementById('annualIncomeDisplay');
    const annualSavingsDisplay = document.getElementById('annualSavingsDisplay');
    const todaysDrawDisplay = document.getElementById('todaysDraw');
    const dynamicRetirementDrawLabel = document.getElementById('dynamicRetirementDrawLabel');
    const dynamicRetirementDrawValue = document.getElementById('dynamicRetirementDrawValue');
    const ssStartAgeDrawDisplay = document.getElementById('ssStartAgeDraw');
    const dynamicRetirementDrawLabelSticky = document.getElementById('dynamicRetirementDrawLabelSticky');
    const dynamicRetirementDrawValueSticky = document.getElementById('dynamicRetirementDrawValueSticky');
    const projectionTableBody = document.getElementById('projectionTableBody');
    const investmentAccountsContainer = document.getElementById('investmentAccountsContainer');
    const addInvestmentBtn = document.getElementById('addInvestmentBtn');
    const homesContainer = document.getElementById('homesContainer');
    const addHomeBtn = document.getElementById('addHomeBtn');
    const otherStaticAssetsContainer = document.getElementById('otherStaticAssetsContainer');
    const addOtherStaticAssetBtn = document.getElementById('addOtherStaticAssetBtn');
    const liabilitiesContainer = document.getElementById('liabilitiesContainer');
    const addLiabilityBtn = document.getElementById('addLiabilityBtn');
    const otherIncomeContainer = document.getElementById('otherIncomeContainer');
    // Corrected the problematic line:
    const addOtherIncomeBtn = document.getElementById('addOtherIncomeBtn');

    const chartContainer = document.getElementById('chart-container');
    const appRevisionDisplay = document.getElementById('appRevisionDisplay');

    const totalInvestmentsSummary = document.getElementById('totalInvestmentsSummary');
    const totalHomesSummary = document.getElementById('totalHomesSummary');
    const totalOtherStaticAssetsSummary = document.getElementById('totalOtherStaticAssetsSummary');
    const totalLiabilitiesSummary = document.getElementById('totalLiabilitiesSummary');

    const socialSecurityMonthlyLabel = document.getElementById('socialSecurityMonthlyLabel');
    const ssStartAgeDrawLabel = document.getElementById('ssStartAgeDrawLabel');

    const seventyTwoTTableBody = document.getElementById('seventyTwoTTableBody');
    const seventyTwoTChartContainer = document.getElementById('seventyTwoTChartContainer');

    // Slider input and value display pairs
    const sliderPairs = [
        { slider: staticInputs.currentAge, valueDisplay: document.getElementById('currentAgeValue'), unit: '' },
        { slider: staticInputs.bonusRate, valueDisplay: document.getElementById('bonusRateValue'), unit: '%' },
        { slider: staticInputs.my401kContributionRate, valueDisplay: document.getElementById('my401kContributionRateValue'), unit: '%' },
        { slider: staticInputs.company401kContributionRate, valueDisplay: document.getElementById('company401kContributionRateValue'), unit: '%' },
        { slider: staticInputs.annualSalaryRaise, valueDisplay: document.getElementById('annualSalaryRaiseValue'), unit: '%' },
        { slider: staticInputs.stockAppreciation, valueDisplay: document.getElementById('stockAppreciationValue'), unit: '%' },
        { slider: staticInputs.housingAppreciation, valueDisplay: document.getElementById('housingAppreciationValue'), unit: '%' },
        { slider: staticInputs.inflation, valueDisplay: document.getElementById('inflationValue'), unit: '%' },
        { slider: staticInputs.retirementDrawRatePre62, valueDisplay: document.getElementById('retirementDrawRatePre62Value'), unit: '%' },
        { slider: staticInputs.retirementDrawRatePost62, valueDisplay: document.getElementById('retirementDrawRatePost62Value'), unit: '%' },
        { slider: staticInputs.retirementYear, valueDisplay: document.getElementById('retirementYearValue'), unit: '' },
        { slider: staticInputs.socialSecurityStartAge, valueDisplay: document.getElementById('socialSecurityStartAgeValue'), unit: '' },
        { slider: staticInputs.socialSecurityMonthly, valueDisplay: document.getElementById('socialSecurityMonthlyValue'), unit: '' },
        { slider: staticInputs.seventyTwoTStartAge, valueDisplay: document.getElementById('seventyTwoTStartAgeValue'), unit: '' },
        { slider: staticInputs.seventyTwoTInterestRate, valueDisplay: document.getElementById('seventyTwoTInterestRateValue'), unit: '%' }
    ];

    // Formats number to currency string, rounded to nearest thousand
    const formatTableCurrency = (amount) => {
        const roundedAmount = Math.round(amount / 1000) * 1000;
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(roundedAmount);
    };

    // Formats number to currency string with K/M notation
    const formatLargeCurrency = (amount) => {
        if (Math.abs(amount) >= 1000000) return `$${(amount / 1000000).toFixed(2)}M`;
        if (Math.abs(amount) >= 1000) return `$${(amount / 1000).toFixed(0)}K`;
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
    };

    // Formats Y-axis labels for charts
    function formatProjectedChartAxisLabel(value, maxChartValue) {
        if (maxChartValue < 5000000) return `$${(value / 1000).toFixed(0)}K`;
        return `$${(value / 1000000).toFixed(0)}M`;
    }

    // Updates slider value display
    function updateSliderValueDisplay(slider, valueDisplay, unit) {
        const val = parseFloat(slider.value);
        valueDisplay.textContent = `${val.toFixed(slider.step === '0.1' || slider.step === '0.5' ? 1 : 0)}${unit}`;
    }

    // Formats percentage for APY display
    function formatPercentageAPY(rate) {
        const percentage = rate * 100;
        if (percentage % 1 !== 0) return percentage.toFixed(1);
        return percentage.toFixed(0);
    }

    // Firebase Initialization
    const initFirebase = async () => {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            await new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } catch (tokenError) {
                                console.error("Custom token sign-in failed, attempting anonymous:", tokenError);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    } else {
                        userId = user.uid;
                    }
                    unsubscribe();
                    resolve();
                }, (error) => {
                    console.error("Error observing Firebase auth state:", error);
                    unsubscribe();
                    reject(error);
                });
            });

            setupRealtimeListener();
        } catch (error) {
            console.error("Critical error during Firebase initialization or authentication flow:", error);
            throw error;
        }
    };

    // Saves data to Firestore
    async function saveDataToFirestore(data) {
        if (!db || !userId || window.isLoadingFromFirestore) return;
        try {
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
            await setDoc(docRef, data, { merge: true });
        } catch (error) {
            console.error("Error saving data to Firestore:", error);
        }
    }

    // Gathers all current input values from the DOM
    function collectAllCurrentInputs() {
        let collectedData = {};

        for (const key in staticInputs) {
            if (staticInputs[key]) {
                let value = staticInputs[key].type === 'range' ? parseFloat(staticInputs[key].value) : cleanInputNumber(staticInputs[key].value);
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62', 'seventyTwoTInterestRate'].includes(key)) {
                    value = value / 100;
                }
                collectedData[key] = value;
            }
        }

        collectedData.investmentAccounts = [];
        document.querySelectorAll('.investment-row').forEach(row => {
            const name = row.querySelector('.investment-name').value;
            const value = cleanInputNumber(row.querySelector('.investment-value').value);
            collectedData.investmentAccounts.push({ name, value });
        });

        collectedData.homes = [];
        document.querySelectorAll('.home-row').forEach(row => {
            const name = row.querySelector('.home-name').value;
            const value = cleanInputNumber(row.querySelector('.home-value').value);
            collectedData.homes.push({ name, value });
        });

        collectedData.otherStaticAssets = [];
        document.querySelectorAll('.other-static-asset-row').forEach(row => {
            const name = row.querySelector('.static-asset-name').value;
            const value = cleanInputNumber(row.querySelector('.static-asset-value').value);
            collectedData.otherStaticAssets.push({ name, value });
        });

        collectedData.liabilities = [];
        document.querySelectorAll('.liability-row').forEach(row => {
            const name = row.querySelector('.liability-name').value;
            const value = cleanInputNumber(row.querySelector('.liability-value').value);
            collectedData.liabilities.push({ name, value });
        });

        collectedData.otherIncome = [];
        document.querySelectorAll('.other-income-row').forEach(row => {
            const name = row.querySelector('.income-name').value;
            const value = cleanInputNumber(row.querySelector('.income-value').value);
            const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
            collectedData.otherIncome.push({ name, value, escalationRate });
        });

        return collectedData;
    }

    // Sets up real-time listener for Firestore data
    function setupRealtimeListener() {
        if (!db || !userId) return;
        const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
        onSnapshot(docRef, async (docSnap) => {
            window.isLoadingFromFirestore = true;
            if (docSnap.exists()) {
                const data = docSnap.data();
                populateInputsFromFirestore(data);
            } else {
                // Default values if no Firestore data
                investmentAccountsContainer.innerHTML = '';
                homesContainer.innerHTML = '';
                otherStaticAssetsContainer.innerHTML = '';
                liabilitiesContainer.innerHTML = '';
                otherIncomeContainer.innerHTML = '';

                const defaultInvestmentAccounts = [
                    { name: "401K", value: 527030 },
                    { name: "Roth 1", value: 178181 },
                    { name: "Roth 2", value: 157347 },
                    { name: "HSA", value: 23550 },
                    { name: "Gold", value: 6600 }
                ];
                const defaultHomes = [
                    { name: "Personal Home", value: 1017000 }
                ];
                const defaultOtherStaticAssets = [
                    { name: "Suburban", value: 32000 },
                    { name: "Tractor", value: 16000 },
                    { name: "RV", value: 25000 },
                    { name: "Checking", value: 16296 }
                ];
                const defaultLiabilities = [
                    { name: "Home Mortgage", value: 203000 },
                    { name: "Credit Cards", value: 0 }
                ];
                const defaultOtherIncomes = [
                    { name: "Cell Tower Lease", value: 1200, escalationRate: 0.015 },
                    { name: "Rental Income", value: 1300, escalationRate: 0.04 }
                ];

                defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
                defaultHomes.forEach(home => addHomeInput(home));
                defaultOtherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
                defaultLiabilities.forEach(liability => addLiabilityInput(liability));
                defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
                
                if (staticInputs.currentAge) staticInputs.currentAge.value = 38;
                if (staticInputs.baseSalary) staticInputs.baseSalary.value = formatInputNumber(179386);
                if (staticInputs.bonusRate) staticInputs.bonusRate.value = 23;
                if (staticInputs.my401kContributionRate) staticInputs.my401kContributionRate.value = 6;
                if (staticInputs.company401kContributionRate) staticInputs.company401kContributionRate.value = 10;
                if (staticInputs.annualRothContribution) staticInputs.annualRothContribution.value = formatInputNumber(0);
                if (staticInputs.monthlyHSAContribution) staticInputs.monthlyHSAContribution.value = formatInputNumber(600);
                if (staticInputs.annualSalaryRaise) staticInputs.annualSalaryRaise.value = 3.5;
                if (staticInputs.stockAppreciation) staticInputs.stockAppreciation.value = 9;
                if (staticInputs.housingAppreciation) staticInputs.housingAppreciation.value = 4;
                if (staticInputs.inflation) staticInputs.inflation.value = 3;
                if (staticInputs.retirementDrawRatePre62) staticInputs.retirementDrawRatePre62.value = 7;
                if (staticInputs.retirementDrawRatePost62) staticInputs.retirementDrawRatePost62.value = 5;
                if (staticInputs.retirementYear) staticInputs.retirementYear.value = 55;
                if (staticInputs.monthlyPrincipalPayment) staticInputs.monthlyPrincipalPayment.value = formatInputNumber(1514);
                if (staticInputs.socialSecurityStartAge) staticInputs.socialSecurityStartAge.value = 62;
                if (staticInputs.socialSecurityMonthly) staticInputs.socialSecurityMonthly.value = 2800;

                sliderPairs.forEach(pair => {
                    if (pair.slider && pair.valueDisplay) {
                        updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
                    }
                });

                calculateFinancials(true);
                calculate72tDistribution(true);
            }
            window.isLoadingFromFirestore = false;
        }, (error) => {
            console.error("Error listening to Firestore document:", error);
            calculateFinancials(false);
            calculate72tDistribution(false);
            window.isLoadingFromFirestore = false;
        });
    }

    // Populates inputs from Firestore data
    function populateInputsFromFirestore(data) {
        for (const key in staticInputs) {
            if (staticInputs[key] && data[key] !== undefined) {
                let value = data[key];
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62', 'seventyTwoTInterestRate'].includes(key)) {
                    value = parseFloat(value) * 100;
                }
                staticInputs[key].value = staticInputs[key].type === 'range' ? value : formatInputNumber(value);
                const pair = sliderPairs.find(p => p.slider === staticInputs[key]);
                if (pair) updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
            }
        }

        investmentAccountsContainer.innerHTML = '';
        homesContainer.innerHTML = '';
        otherStaticAssetsContainer.innerHTML = '';
        liabilitiesContainer.innerHTML = '';
        otherIncomeContainer.innerHTML = '';

        if (data.investmentAccounts && data.investmentAccounts.length > 0) {
            data.investmentAccounts.forEach(account => addInvestmentAccountInput(account));
        }
        if (data.homes && data.homes.length > 0) {
            data.homes.forEach(home => addHomeInput(home));
        }
        if (data.otherStaticAssets && data.otherStaticAssets.length > 0) {
            data.otherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
        }
        if (data.liabilities && data.liabilities.length > 0) {
            data.liabilities.forEach(liability => addLiabilityInput(liability));
        }
        if (data.otherIncome && data.otherIncome.length > 0) {
            data.otherIncome.forEach(income => addOtherIncomeInput(income));
        }

        calculateFinancials(false);
        calculate72tDistribution(false);
    }

    // Adds a new investment account input row
    function addInvestmentAccountInput(account = { name: '', value: 0 }) {
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('investment-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
        rowDiv.innerHTML = `
            <input type="text" placeholder="Account Name" value="${account.name}" class="input-field investment-name flex-1 min-w-[120px]">
            <input type="text" placeholder="Value ($)" value="${formatInputNumber(account.value)}" class="input-field investment-value flex-1 min-w-[100px]">
            <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
        `;
        investmentAccountsContainer.appendChild(rowDiv);

        rowDiv.querySelector('.investment-value').addEventListener('blur', (event) => {
            event.target.value = formatInputNumber(event.target.value);
            calculateFinancials(true);
            calculate72tDistribution(true);
        });
        rowDiv.querySelector('.investment-name').addEventListener('blur', () => { calculateFinancials(true); calculate72tDistribution(true); });

        rowDiv.querySelector('.delete-item-btn').addEventListener('click', () => {
            rowDiv.remove();
            calculateFinancials(true);
            calculate72tDistribution(true);
        });
    }

    // Adds a new home input row
    function addHomeInput(home = { name: '', value: 0 }) {
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('home-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
        rowDiv.innerHTML = `
            <input type="text" placeholder="Home Name" value="${home.name}" class="input-field home-name flex-1 min-w-[120px]">
            <input type="text" placeholder="Value ($)" value="${formatInputNumber(home.value)}" class="input-field home-value flex-1 min-w-[100px]">
            <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
        `;
        homesContainer.appendChild(rowDiv);

        rowDiv.querySelector('.home-value').addEventListener('blur', (event) => {
            event.target.value = formatInputNumber(event.target.value);
            calculateFinancials(true);
        });
        rowDiv.querySelector('.home-name').addEventListener('blur', () => calculateFinancials(true));

        rowDiv.querySelector('.delete-item-btn').addEventListener('click', () => {
            rowDiv.remove();
            calculateFinancials(true);
        });
    }

    // Adds a new other static asset input row
    function addOtherStaticAssetInput(asset = { name: '', value: 0 }) {
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('other-static-asset-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
        rowDiv.innerHTML = `
            <input type="text" placeholder="Asset Name" value="${asset.name}" class="input-field static-asset-name flex-1 min-w-[120px]">
            <input type="text" placeholder="Value ($)" value="${formatInputNumber(asset.value)}" class="input-field static-asset-value flex-1 min-w-[100px]">
            <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
        `;
        otherStaticAssetsContainer.appendChild(rowDiv);

        rowDiv.querySelector('.static-asset-value').addEventListener('blur', (event) => {
            event.target.value = formatInputNumber(event.target.value);
            calculateFinancials(true);
        });
        rowDiv.querySelector('.static-asset-name').addEventListener('blur', () => calculateFinancials(true));

        rowDiv.querySelector('.delete-item-btn').addEventListener('click', () => {
            rowDiv.remove();
            calculateFinancials(true);
        });
    }

    // Adds a new liability input row
    function addLiabilityInput(liability = { name: '', value: 0 }) {
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('liability-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
        rowDiv.innerHTML = `
            <input type="text" placeholder="Liability Name" value="${liability.name}" class="input-field liability-name flex-1 min-w-[120px]">
            <input type="text" placeholder="Value ($)" value="${formatInputNumber(liability.value)}" class="input-field liability-value flex-1 min-w-[100px]">
            <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
        `;
        liabilitiesContainer.appendChild(rowDiv);

        rowDiv.querySelector('.liability-value').addEventListener('blur', (event) => {
            event.target.value = formatInputNumber(event.target.value);
            calculateFinancials(true);
        });
        rowDiv.querySelector('.liability-name').addEventListener('blur', () => calculateFinancials(true));

        rowDiv.querySelector('.delete-item-btn').addEventListener('click', () => {
            rowDiv.remove();
            calculateFinancials(true);
        });
    }

    // Adds a new other income input row
    function addOtherIncomeInput(income = { name: '', value: 0, escalationRate: 0 }) {
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('other-income-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
        rowDiv.innerHTML = `
            <input type="text" placeholder="Income Source" value="${income.name}" class="input-field income-name flex-1 min-w-[120px]">
            <input type="text" placeholder="Monthly Value ($)" value="${formatInputNumber(income.value)}" class="input-field income-value flex-1 min-w-[100px]">
            <div class="flex items-center">
                <input type="number" placeholder="Escalation Rate" value="${(income.escalationRate * 100).toFixed(1)}" step="0.1" min="0" max="10" class="input-field income-escalation-rate w-24">
                <span class="ml-1 text-gray-700">%</span>
            </div>
            <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
        `;
        otherIncomeContainer.appendChild(rowDiv);

        rowDiv.querySelectorAll('input').forEach(input => {
            if (input.classList.contains('income-value')) {
                input.addEventListener('blur', (event) => {
                    event.target.value = formatInputNumber(event.target.value);
                    calculateFinancials(true);
                });
            } else if (input.classList.contains('income-name')) {
                input.addEventListener('blur', () => calculateFinancials(true));
            } else if (input.classList.contains('income-escalation-rate')) {
                input.addEventListener('input', () => calculateFinancials(true));
            }
        });

        rowDiv.querySelector('.delete-item-btn').addEventListener('click', () => {
            rowDiv.remove();
            calculateFinancials(true);
        });
    }

    // Main financial calculation function
    function calculateFinancials(shouldSaveData = true) {
        let totalInvestments = 0;
        let totalHomes = 0;
        let totalOtherStaticAssets = 0;
        let totalLiabilities = 0;
        let currentMortgageValue = 0;

        let currentFinancials = collectAllCurrentInputs();

        currentFinancials.investmentAccounts.forEach(account => totalInvestments += account.value);
        currentFinancials.homes.forEach(home => totalHomes += home.value);
        currentFinancials.otherStaticAssets.forEach(asset => totalOtherStaticAssets += asset.value);
        currentFinancials.liabilities.forEach(liability => {
            totalLiabilities += liability.value;
            if (liability.name.toLowerCase() === "home mortgage") {
                currentMortgageValue = liability.value;
            }
        });

        const currentAge = currentFinancials.currentAge;
        const baseSalary = currentFinancials.baseSalary;
        const bonusRate = currentFinancials.bonusRate;
        const my401kContributionRate = currentFinancials.my401kContributionRate;
        const company401kContributionRate = currentFinancials.company401kContributionRate;
        const annualRothContribution = currentFinancials.annualRothContribution;
        const monthlyHSAContribution = currentFinancials.monthlyHSAContribution;
        const annualSalaryRaise = currentFinancials.annualSalaryRaise;
        const stockAppreciation = currentFinancials.stockAppreciation;
        const housingAppreciation = currentFinancials.housingAppreciation;
        const inflation = currentFinancials.inflation;
        const retirementDrawRatePre62 = currentFinancials.retirementDrawRatePre62;
        const retirementDrawRatePost62 = currentFinancials.retirementDrawRatePost62;
        const retirementYear = currentFinancials.retirementYear;
        const monthlyPrincipalPayment = currentFinancials.monthlyPrincipalPayment;
        const socialSecurityStartAge = currentFinancials.socialSecurityStartAge;
        const socialSecurityMonthly = currentFinancials.socialSecurityMonthly;
        const annualPrincipalPayment = monthlyPrincipalPayment * 12;

        staticInputs.retirementYear.min = currentAge;
        if (retirementYear < currentAge) {
            staticInputs.retirementYear.value = currentAge;
        }

        sliderPairs.forEach(pair => {
            if (pair.slider && pair.valueDisplay) {
                updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
            }
        });

        dynamicRetirementDrawLabel.textContent = `${retirementYear} YO Draw (Today's $):`;
        dynamicRetirementDrawLabelSticky.textContent = `${retirementYear} YO Draw (Today's $):`;

        socialSecurityMonthlyLabel.textContent = `Social Security at ${socialSecurityStartAge} ($)`;
        ssStartAgeDrawLabel.textContent = `${socialSecurityStartAge} YO Draw (Today's $):`;

        const currentTotalAssets = totalInvestments + totalHomes + totalOtherStaticAssets;
        const currentNetWorth = currentTotalAssets - totalLiabilities;
        const currentNetInvestments = totalInvestments;

        const annualBonusIncome = baseSalary * bonusRate;
        let totalOtherAnnualIncome = 0;
        currentFinancials.otherIncome.forEach(income => {
             totalOtherAnnualIncome += income.value * 12;
        });
        const totalAnnualIncome = baseSalary + annualBonusIncome + totalOtherAnnualIncome;

        const totalAnnualSavings =
            (baseSalary * my401kContributionRate) +
            (baseSalary * company401kContributionRate) +
            (monthlyHSAContribution * 12) +
            annualRothContribution;

        currentNetWorthDisplay.textContent = formatLargeCurrency(currentNetWorth);
        currentNetInvestmentsDisplay.textContent = formatLargeCurrency(currentNetInvestments);
        annualIncomeDisplay.textContent = formatLargeCurrency(totalAnnualIncome);
        annualSavingsDisplay.textContent = formatLargeCurrency(totalAnnualSavings);

        totalInvestmentsSummary.textContent = `(${formatLargeCurrency(totalInvestments)}) ${formatPercentageAPY(stockAppreciation)}% APY`;
        totalHomesSummary.textContent = `(${formatLargeCurrency(totalHomes)}) ${formatPercentageAPY(housingAppreciation)}% APY`;
        totalOtherStaticAssetsSummary.textContent = `(${formatLargeCurrency(totalOtherStaticAssets)})`;
        totalLiabilitiesSummary.textContent = `(${formatLargeCurrency(totalLiabilities)})`;

        let initial401kBalance = 0;
        let initialOtherInvestmentsBalance = 0;
        currentFinancials.investmentAccounts.forEach(account => {
            if (account.name.toLowerCase().includes("401")) {
                initial401kBalance += account.value;
            } else {
                initialOtherInvestmentsBalance += account.value;
            }
        });

        projectGrowth(initial401kBalance, initialOtherInvestmentsBalance, currentNetWorth,
                        totalHomes, totalOtherStaticAssets,
                        totalLiabilities, currentMortgageValue, baseSalary,
                        bonusRate, my401kContributionRate, company401kContributionRate,
                        annualRothContribution,
                        monthlyHSAContribution,
                        annualSalaryRaise, stockAppreciation,
                        housingAppreciation, inflation, annualPrincipalPayment,
                        currentFinancials.otherIncome,
                        currentAge,
                        retirementDrawRatePre62, retirementDrawRatePost62,
                        todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay,
                        retirementYear,
                        dynamicRetirementDrawValueSticky,
                        socialSecurityStartAge,
                        socialSecurityMonthly
                        );

        if (shouldSaveData && !window.isLoadingFromFirestore) {
            saveDataToFirestore(currentFinancials);
        }
    }

    // Projects financial growth over time
    function projectGrowth(initial401kBalance, initialOtherInvestmentsBalance, initialNetWorth,
                           initialHomesValue, initialOtherStaticAssetsValue,
                           initialTotalLiabilities, initialMortgageValue, initialBaseSalary,
                           bonusRate, my401kContributionRate, company401kContributionRate,
                           annualRothContribution,
                           monthlyHSAContribution,
                           annualSalaryRaise, stockAppreciation,
                           housingAppreciation, inflation, annualPrincipalPayment,
                           currentOtherIncomesStateForProjection,
                           initialAge,
                           retirementDrawRatePre62, retirementDrawRatePost62,
                           todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay,
                           retirementYearInput, dynamicRetirementDrawValueSticky,
                           socialSecurityStartAge,
                           socialSecurityMonthly
                           ) {

        projectionTableBody.innerHTML = '';
        chartContainer.innerHTML = '';

        let current401kBalance = initial401kBalance;
        let currentOtherInvestmentsBalance = initialOtherInvestmentsBalance;
        let currentHomesValue = initialHomesValue;
        let currentOtherStaticAssetsValue = initialOtherStaticAssetsValue;
        let currentMortgage = initialMortgageValue;
        let currentOtherLiabilitiesTotal = initialTotalLiabilities - initialMortgageValue;
        let currentBaseSalary = initialBaseSalary;
        
        const startYear = new Date().getFullYear();
        const inflationRate = inflation;

        const chartData = [];

        let initialTotalOtherAnnualIncomeSnapshot = 0;
        currentOtherIncomesStateForProjection.forEach(income => {
            initialTotalOtherAnnualIncomeSnapshot += income.value * 12;
        });
        const todaysDrawValue = (initial401kBalance * retirementDrawRatePre62) + (initialOtherInvestmentsBalance * retirementDrawRatePre62) + initialTotalOtherAnnualIncomeSnapshot;
        todaysDrawDisplay.textContent = formatLargeCurrency(todaysDrawValue);

        // Calculate fixed 72(t) distribution ONCE at the start of projection
        const seventyTwoTStartAge = staticInputs.seventyTwoTStartAge ? parseFloat(staticInputs.seventyTwoTStartAge.value) : initialAge;
        const seventyTwoTInterestRate = staticInputs.seventyTwoTInterestRate ? parseFloat(staticInputs.seventyTwoTInterestRate.value) / 100 : 0.04;
        const lifeExpectancyAt72tStart = irsLifeExpectancyTable[Math.floor(seventyTwoTStartAge)];

        let fixedAnnual72tDistribution = 0;
        if (lifeExpectancyAt72tStart && seventyTwoTInterestRate > 0) {
            const annuityFactor = (1 - Math.pow((1 + seventyTwoTInterestRate), -lifeExpectancyAt72tStart)) / seventyTwoTInterestRate;
            fixedAnnual72tDistribution = initial401kBalance / annuityFactor;
            fixedAnnual72tDistribution = Math.round(fixedAnnual72tDistribution * 100) / 100;
        }

        // First data point represents the current state (Age, Year, Investments, Net Worth, Net Worth in Today's Dollars)
        chartData.push({
            age: initialAge,
            investments: initial401kBalance + initialOtherInvestmentsBalance,
            netWorth: initialNetWorth,
            netWorthTodaysDollars: initialNetWorth
        });

        // Loop for projecting future years
        for (let i = 1; initialAge + i <= 80; i++) {
            const year = startYear + i;
            const age = initialAge + i;

            let annualContributionsTo401k = 0;
            let annualContributionsToOtherInvestments = 0;

            if (age < retirementYearInput) {
                annualContributionsTo401k =
                    (currentBaseSalary * my401kContributionRate) +
                    (currentBaseSalary * company401kContributionRate);
                annualContributionsToOtherInvestments =
                    (monthlyHSAContribution * 12) +
                    annualRothContribution;
            }

            // Apply contributions
            current401kBalance += annualContributionsTo401k;
            currentOtherInvestmentsBalance += annualContributionsToOtherInvestments;

            // Apply investment growth before draws
            current401kBalance *= (1 + stockAppreciation);
            currentOtherInvestmentsBalance *= (1 + stockAppreciation);

            let annualDrawFrom401k = 0;
            let annualDrawFromOtherInvestments = 0;

            // Apply draws based on age and retirement status
            if (age >= retirementYearInput) {
                if (age < 60) { // Specific age 60 for 72(t) fixed draw
                    annualDrawFrom401k = fixedAnnual72tDistribution;
                } else {
                    const effectiveRate = (age < socialSecurityStartAge) ? retirementDrawRatePre62 : retirementDrawRatePost62;
                    annualDrawFrom401k = current401kBalance * effectiveRate;
                }

                const effectiveRateOther = (age < socialSecurityStartAge) ? retirementDrawRatePre62 : retirementDrawRatePost62;
                annualDrawFromOtherInvestments = currentOtherInvestmentsBalance * effectiveRateOther;

            } else if (age >= seventyTwoTStartAge && age < 60) { // For ages between 72(t) start and 60
                annualDrawFrom401k = fixedAnnual72tDistribution;
                annualDrawFromOtherInvestments = currentOtherInvestmentsBalance * retirementDrawRatePre62;
            }
            // Before retirement (and before 72t start age), no draws from investments


            // Ensure draws don't make balance negative
            current401kBalance = Math.max(0, current401kBalance - annualDrawFrom401k);
            currentOtherInvestmentsBalance = Math.max(0, currentOtherInvestmentsBalance - annualDrawFromOtherInvestments);


            let currentAnnualOtherIncomeForYear = 0;
            let tempProjectedOtherIncomes = JSON.parse(JSON.stringify(currentOtherIncomesStateForProjection));
            tempProjectedOtherIncomes.forEach(income => {
                let escalatedValue = income.value * Math.pow((1 + income.escalationRate), i);
                 if (income.name.toLowerCase().includes("rental") && income.escalationRate > 0) {
                    escalatedValue = Math.floor(escalatedValue / 100) * 100;
                }
                currentAnnualOtherIncomeForYear += escalatedValue * 12;
            });

            currentHomesValue *= (1 + housingAppreciation);
            
            currentMortgage = Math.max(0, currentMortgage - annualPrincipalPayment);

            let totalProjectedInvestments = current401kBalance + currentOtherInvestmentsBalance;
            let totalProjectedAssets = totalProjectedInvestments + currentHomesValue + currentOtherStaticAssetsValue;
            const currentTotalLiabilitiesInProjection = currentMortgage + currentOtherLiabilitiesTotal;
            let currentNetWorth = totalProjectedAssets - currentTotalLiabilitiesInProjection;

            const netWorthInTodaysDollars = currentNetWorth / Math.pow((1 + inflationRate), i);

            chartData.push({
                age: age,
                investments: totalProjectedInvestments,
                netWorth: currentNetWorth,
                netWorthTodaysDollars: netWorthInTodaysDollars
            });

            const row = projectionTableBody.insertRow();
            row.classList.add('hover:bg-blue-50');

            if (age % 5 === 0) {
                row.classList.add('bg-blue-100');
            }

            row.insertCell().textContent = age;
            row.insertCell().textContent = year;
            row.insertCell().textContent = formatTableCurrency(totalProjectedInvestments);
            row.insertCell().textContent = formatTableCurrency(currentNetWorth);
            row.insertCell().textContent = formatTableCurrency(netWorthInTodaysDollars);

            if (age < retirementYearInput) {
                currentBaseSalary *= (1 + annualSalaryRaise);
            }
        }
        renderChart(chartData);
    }

    // D3.js Chart Rendering Functions (renderChart and render72tChart)
    function renderChart(data) {
        d3.select(chartContainer).select("svg").remove();

        const parentWidth = chartContainer.offsetWidth;
        const margin = { top: 40, right: 60, bottom: 50, left: 80 };
        const width = parentWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select(chartContainer).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "chart-svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.age))
            .range([0, width]);

        const yMax = d3.max(data, d => Math.max(d.investments, d.netWorth, d.netWorthTodaysDollars));
        const yMin = d3.min(data, d => Math.min(d.investments, d.netWorth, d.netWorthTodaysDollars));

        const yScale = d3.scaleLinear()
            .domain([yMin * 0.95, yMax * 1.05])
            .range([height, 0]);

        const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
        const yAxisLeft = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));
        const yAxisRight = d3.axisRight(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis-left")
            .call(yAxisLeft);

        svg.append("g")
            .attr("class", "y axis-right")
            .attr("transform", `translate(${width}, 0)`)
            .call(yAxisRight);

        svg.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScale)
                .tickSize(-width)
                .tickFormat("")
            );

        const lineInvestments = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.investments));

        const lineNetWorth = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.netWorth));
        
        const lineNetWorthTodaysDollars = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.netWorthTodaysDollars));

        svg.append("path")
            .datum(data)
            .attr("class", "line line-investments")
            .attr("fill", "none")
            .attr("d", lineInvestments);

        svg.append("path")
            .datum(data)
            .attr("class", "line line-networth")
            .attr("fill", "none")
            .attr("d", lineNetWorth);
        
        svg.append("path")
            .datum(data)
            .attr("class", "line line-networth-todays-dollars")
            .attr("fill", "none")
            .attr("d", lineNetWorthTodaysDollars);

        svg.append("text")
            .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Age");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 20)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("transform", "rotate(90)")
            .attr("y", width + margin.right - 20)
            .attr("x", height / 2)
            .attr("dy", "-1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .attr("font-size", "1.2rem")
            .attr("font-weight", "bold")
            .text("Projected Investments & Net Worth");

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute");

        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mouseover", function() { focusInvestment.style("display", null); focusNetWorth.style("display", null); focusNetWorthTodaysDollars.style("display", null); tooltip.style("opacity", 1); })
            .on("mouseout", function() { focusInvestment.style("display", "none"); focusNetWorth.style("display", "none"); focusNetWorthTodaysDollars.style("display", "none"); tooltip.style("opacity", 0); })
            .on("mousemove", mousemove);

        const focusInvestment = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusInvestment.append("circle")
            .attr("r", 5)
            .attr("fill", "#2563eb");

        const focusNetWorth = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusNetWorth.append("circle")
            .attr("r", 5)
            .attr("fill", "#10b981");
        
        const focusNetWorthTodaysDollars = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusNetWorthTodaysDollars.append("circle")
            .attr("r", 5)
            .attr("fill", "#800080");

        function mousemove(event) {
            const x0 = xScale.invert(d3.pointer(event)[0]);
            const bisect = d3.bisector(d => d.age).left;
            const i = bisect(data, x0, 1);
            const d0 = data[i - 1];
            const d1 = data[i];
            const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

            focusInvestment.attr("transform", `translate(${xScale(d.age)},${yScale(d.investments)})`);
            focusNetWorth.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorth)})`);
            focusNetWorthTodaysDollars.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorthTodaysDollars)})`);

            tooltip.html(`Age: ${d.age}<br>Investments: ${formatTableCurrency(d.investments)}<br>Net Worth: ${formatTableCurrency(d.netWorth)}<br>Net Worth (Today's $): ${formatTableCurrency(d.netWorthTodaysDollars)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
        }
        chartContainer.__chartData__ = data;
    }

    function render72tChart(data) {
        d3.select(seventyTwoTChartContainer).select("svg").remove();

        const parentWidth = seventyTwoTChartContainer.offsetWidth;
        const margin = { top: 40, right: 60, bottom: 50, left: 80 };
        const width = parentWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select(seventyTwoTChartContainer).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "chart-svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.age))
            .range([0, width]);

        const yMaxBalance = d3.max(data, d => d.balance);
        const yMaxDistribution = d3.max(data, d => d.distribution);
        const yMax = Math.max(yMaxBalance, yMaxDistribution) * 1.05;
        const yMin = 0;

        const yScale = d3.scaleLinear()
            .domain([yMin, yMax])
            .range([height, 0]);

        const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
        const yAxisLeft = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));
        const yAxisRight = d3.axisRight(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis-left")
            .call(yAxisLeft);

        svg.append("g")
            .attr("class", "y axis-right")
            .attr("transform", `translate(${width}, 0)`)
            .call(yAxisRight);

        svg.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScale)
                .tickSize(-width)
                .tickFormat("")
            );

        const lineBalance = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.balance));

        const lineDistribution = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.distribution));

        svg.append("path")
            .datum(data)
            .attr("class", "line line-balance")
            .attr("fill", "none")
            .attr("d", lineBalance);

        svg.append("path")
            .datum(data)
            .attr("class", "line line-distribution")
            .attr("fill", "none")
            .attr("d", lineDistribution);

        svg.append("text")
            .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Age");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 20)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("transform", "rotate(90)")
            .attr("y", width + margin.right - 20)
            .attr("x", height / 2)
            .attr("dy", "-1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .attr("font-size", "1.2rem")
            .attr("font-weight", "bold")
            .text("72(t) Fixed Distribution Projection");

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute");

        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mouseover", function() { focusBalance.style("display", null); focusDistribution.style("display", null); tooltip.style("opacity", 1); })
            .on("mouseout", function() { focusBalance.style("display", "none"); focusDistribution.style("display", "none"); tooltip.style("opacity", 0); })
            .on("mousemove", mousemove72t);

        const focusBalance = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusBalance.append("circle")
            .attr("r", 5)
            .attr("fill", "#2563eb");

        const focusDistribution = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusDistribution.append("circle")
            .attr("r", 5)
            .attr("fill", "#f97316");

        function mousemove72t(event) {
            const x0 = xScale.invert(d3.pointer(event)[0]);
            const bisect = d3.bisector(d => d.age).left;
            const i = bisect(data, x0, 1);
            const d0 = data[i - 1];
            const d1 = data[i];
            const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

            focusBalance.attr("transform", `translate(${xScale(d.age)},${yScale(d.balance)})`);
            focusDistribution.attr("transform", `translate(${xScale(d.age)},${yScale(d.distribution)})`);

            tooltip.html(`Age: ${d.age}<br>Balance: ${formatTableCurrency(d.balance)}<br>Distribution: ${formatTableCurrency(d.distribution)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
        }
        seventyTwoTChartContainer.__chartData__ = data;
    }

    // 72(t) Distribution Calculation (Amortization Method)
    function calculate72tDistribution() {
        seventyTwoTTableBody.innerHTML = '';
        seventyTwoTChartContainer.innerHTML = '';

        const currentFinancials = collectAllCurrentInputs();
        const seventyTwoTStartAge = currentFinancials.seventyTwoTStartAge;
        const stockAppreciation = currentFinancials.stockAppreciation;
        const seventyTwoTInterestRate = currentFinancials.seventyTwoTInterestRate;

        let initial401kBalance = 0;
        const found401k = currentFinancials.investmentAccounts.find(account =>
            account.name.toLowerCase().includes("401")
        );

        if (found401k) {
            initial401kBalance = found401k.value;
        } else {
            console.warn("No '401k' account found. 72(t) calculation uses 0 balance.");
        }

        let current401kBalance = initial401kBalance;
        const chartData = [];

        const lifeExpectancyAtStart = irsLifeExpectancyTable[Math.floor(seventyTwoTStartAge)];
        
        let fixedAnnualDistribution = 0;
        if (lifeExpectancyAtStart && seventyTwoTInterestRate > 0) {
            const annuityFactor = (1 - Math.pow((1 + seventyTwoTInterestRate), -lifeExpectancyAtStart)) / seventyTwoTInterestRate;
            fixedAnnualDistribution = initial401kBalance / annuityFactor;
            fixedAnnualDistribution = Math.round(fixedAnnualDistribution * 100) / 100;
        } else {
            console.warn(`Cannot calculate 72(t) fixed distribution for age ${seventyTwoTStartAge} or interest rate. Distribution will be 0.`);
        }

        for (let age = seventyTwoTStartAge; age <= 120; age += 0.5) {
            if (current401kBalance < 0.01 && age > seventyTwoTStartAge) break;

            current401kBalance *= (1 + stockAppreciation);

            let distributionTaken = fixedAnnualDistribution;
            if (current401kBalance < fixedAnnualDistribution) {
                distributionTaken = current401kBalance;
            }
            current401kBalance -= distributionTaken;
            current401kBalance = Math.max(0, current401kBalance);

            chartData.push({
                age: age,
                balance: current401kBalance,
                distribution: distributionTaken
            });

            const row = seventyTwoTTableBody.insertRow();
            row.classList.add('hover:bg-blue-50');

            if (Math.floor(age) % 5 === 0 && age % 1 === 0) {
                row.classList.add('bg-orange-100');
            }

            row.insertCell().textContent = age;
            row.insertCell().textContent = formatTableCurrency(distributionTaken);
            row.insertCell().textContent = formatTableCurrency(current401kBalance);
        }

        if (chartData.length > 0) {
            render72tChart(chartData);
        }
    }

    // Event listeners for static inputs
    for (const key in staticInputs) {
        if (staticInputs[key]) {
            if (staticInputs[key].type === 'range') {
                staticInputs[key].addEventListener('input', () => updateSliderValueDisplay(staticInputs[key], sliderPairs.find(p => p.slider === staticInputs[key]).valueDisplay, sliderPairs.find(p => p.slider === staticInputs[key]).unit));
                staticInputs[key].addEventListener('change', () => {
                    calculateFinancials(true);
                    if (['seventyTwoTStartAge', 'stockAppreciation', 'currentAge', 'seventyTwoTInterestRate'].includes(key)) {
                        calculate72tDistribution(true);
                    }
                });
            } else {
                staticInputs[key].addEventListener('blur', (event) => {
                    event.target.value = formatInputNumber(event.target.value);
                    calculateFinancials(true);
                });
            }
        }
    }

    // Event listeners for dynamic input buttons
    addInvestmentBtn.addEventListener('click', () => { addInvestmentAccountInput(); calculateFinancials(true); calculate72tDistribution(true); });
    // This listener is crucial for detecting changes to the 401K balance specifically
    investmentAccountsContainer.addEventListener('blur', (event) => {
        if (event.target.classList.contains('investment-value') || event.target.classList.contains('investment-name')) {
            calculate72tDistribution(true);
        }
    }, true);

    addHomeBtn.addEventListener('click', () => { addHomeInput(); calculateFinancials(true); });
    addOtherStaticAssetBtn.addEventListener('click', () => { addOtherStaticAssetInput(); calculateFinancials(true); });
    addLiabilityBtn.addEventListener('click', () => { addLiabilityInput(); calculateFinancials(true); });
    addOtherIncomeBtn.addEventListener('click', () => { addOtherIncomeInput(); calculateFinancials(true); });

    // Event listeners for slider value display and saving
    sliderPairs.forEach(pair => {
        if (pair.slider && pair.valueDisplay) {
            pair.slider.addEventListener('input', () => updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit));
            pair.slider.addEventListener('change', () => {
                calculateFinancials(true);
                if (['seventyTwoTStartAge', 'stockAppreciation', 'currentAge', 'seventyTwoTInterestRate'].includes(pair.slider.id)) {
                    calculate72tDistribution(true);
                }
            });
        }
    });

    // Handles sticky header on scroll for mobile
    function handleMobileStickyHeader() {
        const stickyElement = document.getElementById('dynamicRetirementDrawSticky');
        const leftStickyBanner = document.getElementById('leftStickyBanner');
        if (window.innerWidth < 1024 && stickyElement && leftStickyBanner) {
            const bannerBottom = leftStickyBanner.offsetHeight;
            if (window.scrollY > bannerBottom) {
                stickyElement.classList.remove('hidden');
                stickyElement.classList.add('mobile-sticky-draw');
            } else {
                stickyElement.classList.add('hidden');
                stickyElement.classList.remove('mobile-sticky-draw');
            }
        } else if (stickyElement) {
            stickyElement.classList.add('hidden');
            stickyElement.classList.remove('mobile-sticky-draw');
        }
    }

    // Initial setup on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (appRevisionDisplay) {
            appRevisionDisplay.textContent = `v${appRevision}`;
        }

        initFirebase().then(() => {
            // Data population and 72(t) calc handled by onSnapshot
        }).catch(() => {
            console.warn("Firebase initialization failed, initializing dynamic inputs with local defaults.");
            
            const fallbackInvestmentAccounts = [
                { name: "401K", value: 527030 },
                { name: "Roth 1", value: 178181 },
                { name: "Roth 2", value: 157347 },
                { name: "HSA", value: 23550 },
                { name: "Gold", value: 6600 }
            ];
            const fallbackHomes = [
                { name: "Personal Home", value: 1017000 }
            ];
            const fallbackOtherStaticAssets = [
                { name: "Suburban", value: 32000 },
                { name: "Tractor", value: 16000 },
                { name: "RV", value: 25000 },
                { name: "Checking", value: 16296 }
            ];
            const fallbackLiabilities = [
                { name: "Home Mortgage", value: 203000 },
                { name: "Credit Cards", value: 0 }
            ];
            const fallbackOtherIncomes = [
                { name: "Cell Tower Lease", value: 1200, escalationRate: 0.015 },
                { name: "Rental Income", value: 1300, escalationRate: 0.04 }
            ];

            investmentAccountsContainer.innerHTML = '';
            homesContainer.innerHTML = '';
            otherStaticAssetsContainer.innerHTML = '';
            liabilitiesContainer.innerHTML = '';
            otherIncomeContainer.innerHTML = '';

            fallbackInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
            fallbackHomes.forEach(home => addHomeInput(home));
            fallbackOtherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
            fallbackLiabilities.forEach(liability => addLiabilityInput(liability));
            fallbackOtherIncomes.forEach(income => addOtherIncomeInput(income));

            if (staticInputs.currentAge) staticInputs.currentAge.value = 38;
            if (staticInputs.baseSalary) staticInputs.baseSalary.value = formatInputNumber(179386);
            if (staticInputs.bonusRate) staticInputs.bonusRate.value = 23;
            if (staticInputs.my401kContributionRate) staticInputs.my401kContributionRate.value = 6;
            if (staticInputs.company401kContributionRate) staticInputs.company401kContributionRate.value = 10;
            if (staticInputs.annualRothContribution) staticInputs.annualRothContribution.value = formatInputNumber(0);
            if (staticInputs.monthlyHSAContribution) staticInputs.monthlyHSAContribution.value = formatInputNumber(600);
            if (staticInputs.annualSalaryRaise) staticInputs.annualSalaryRaise.value = 3.5;
            if (staticInputs.stockAppreciation) staticInputs.stockAppreciation.value = 9;
            if (staticInputs.housingAppreciation) staticInputs.housingAppreciation.value = 4;
            if (staticInputs.inflation) staticInputs.inflation.value = 3;
            if (staticInputs.retirementDrawRatePre62) staticInputs.retirementDrawRatePre62.value = 7;
            if (staticInputs.retirementDrawRatePost62) staticInputs.retirementDrawRatePost62.value = 5;
            if (staticInputs.retirementYear) staticInputs.retirementYear.value = 55;
            if (staticInputs.monthlyPrincipalPayment) staticInputs.monthlyPrincipalPayment.value = formatInputNumber(1514);
            if (staticInputs.socialSecurityStartAge) staticInputs.socialSecurityStartAge.value = 62;
            if (staticInputs.socialSecurityMonthly) staticInputs.socialSecurityMonthly.value = 2800;

            sliderPairs.forEach(pair => {
                if (pair.slider && pair.valueDisplay) {
                    updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
                }
            });

            calculateFinancials(false);
            calculate72tDistribution(false);
        });

        window.addEventListener('resize', () => {
            const projectedData = chartContainer.__chartData__;
            if (projectedData) renderChart(projectedData);
            const seventyTwoTChartData = seventyTwoTChartContainer.__chartData__;
            if (seventyTwoTChartData) render72tChart(seventyTwoTChartData);
            handleMobileStickyHeader();
        });

        window.addEventListener('scroll', handleMobileStickyHeader);
    });
</script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8;
        color: #334155;
    }
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: #d1d5db;
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
        border-radius: 4px;
        margin: 0;
    }
    input[type="range"]:hover {
        opacity: 1;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #2563eb;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 2;
    }
    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #2563eb;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 2;
    }

    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .rounded-lg {
        border-radius: 0.75rem;
    }
    .input-field {
        @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline;
    }
    .label-style {
        @apply block text-gray-700 text-sm font-bold mb-1;
    }
    tbody tr:hover {
        background-color: #e0f2fe;
    }

    .slider-input-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .slider-value-display {
        position: static;
        width: 60px;
        text-align: right;
        margin-right: 8px;
        color: #334155;
        font-size: 0.9rem;
        font-weight: bold;
        white-space: nowrap;
        flex-shrink: 0;
    }
    .slider-input-wrapper input[type="range"] {
        flex-grow: 1;
        width: auto;
        margin: 0;
    }

    .chart-svg {
        display: block;
        margin: auto;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .line {
        fill: none;
        stroke-width: 3px;
    }
    .line-investments {
        stroke: #2563eb;
    }
    .line-networth {
        stroke: #10b981;
    }
    .line-networth-todays-dollars {
        stroke: #800080;
    }
    .line-balance {
        stroke: #2563eb;
    }
    .line-distribution {
        stroke: #f97316;
    }
    .axis text {
        font-size: 0.8rem;
        fill: #6b7280;
    }
    .axis path, .axis line {
        stroke: #d1d5db;
        stroke-width: 1px;
    }
    .grid line {
        stroke: #e5e7eb;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
    }
    .tooltip {
        position: absolute;
        text-align: center;
        padding: 8px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        pointer-events: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-size: 0.9rem;
        color: #333;
    }

    @media (max-width: 1023px) {
        #leftStickyBanner {
            width: 100%;
            height: auto;
            position: relative;
            top: auto;
            left: auto;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #leftStickyBanner h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            width: 100%;
        }
        #leftStickyBanner .summary-item {
            flex: 1 1 auto;
            min-width: 100px;
            margin-bottom: 0.5rem;
            padding: 0 0.5rem;
        }
        #leftStickyBanner .summary-item p {
            font-size: 0.8rem;
        }
        #leftStickyBanner .summary-item p:last-child {
            font-size: 1.1rem;
        }
        .flex-1.p-4.md\:p-8.lg\:ml-64 {
            margin-top: 0;
        }
        .mobile-sticky-draw {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #1e3a8a;
            color: white;
            text-align: center;
            padding: 0.5rem 0;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    }
    .container.mx-auto {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    @media (min-width: 1024px) {
        #leftStickyBanner {
            width: 16rem;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #leftStickyBanner h2 {
            font-size: 1.875rem;
            margin-bottom: 2rem;
            width: auto;
        }
        #leftStickyBanner .summary-item {
            flex: none;
            width: auto;
            margin-bottom: 1rem;
            padding: 0;
        }
        #leftStickyBanner .summary-item p {
            font-size: 1.125rem;
        }
        #leftStickyBanner .summary-item p:last-child {
            font-size: 1.875rem;
        }
        .flex-1.p-4.md\:p-8.lg\:ml-64 {
            margin-left: 16rem;
            margin-top: 0;
        }
    }
</style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="leftStickyBanner" class="
        relative w-full h-auto bg-blue-800 text-white p-4 shadow-xl flex flex-row flex-wrap justify-center items-start z-50
        lg:fixed lg:top-0 lg:left-0 lg:h-screen lg:w-64 lg:flex-col lg:items-center lg:justify-start lg:p-6 lg:shadow-2xl lg:overflow-y-auto
    ">
        <h2 class="text-xl font-extrabold mb-4 text-center text-white w-full lg:text-3xl lg:mb-8">Your Snapshot</h2>
        <span id="appRevisionDisplay" class="text-xs text-blue-200 font-semibold mb-4 lg:mb-6">v1.41</span>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Worth:</p>
            <p id="currentNetWorth" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Investments:</p>
            <p id="currentNetInvestments" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Income:</p>
            <p id="annualIncomeDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Savings:</p>
            <p id="annualSavingsDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Today's Draw:</p>
            <p id="todaysDraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg" id="dynamicRetirementDrawLabel">Retirement Draw (Today's $):</p>
            <p id="dynamicRetirementDrawValue" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg" id="ssStartAgeDrawLabel">62 YO Draw (Today's $):</p>
            <p id="ssStartAgeDraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
    </div>

    <div id="dynamicRetirementDrawSticky" class="hidden text-center mb-2 w-full bg-blue-800 text-white p-2">
        <p class="text-sm font-bold text-blue-200" id="dynamicRetirementDrawLabelSticky">Retirement Draw (Today's $):</p>
        <p id="dynamicRetirementDrawValueSticky" class="text-xl font-semibold text-white">$0</p>
    </div>

    <div class="flex-1 p-4 md:p-8 lg:ml-64">
        <div class="w-full bg-white rounded-lg shadow-xl p-4 md:p-8">
            <h1 class="text-4xl font-extrabold mb-4 text-center text-blue-800">Retirement Plan Calculator</h1>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-6 text-blue-700">1. Assets, Investments, and Liabilities</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Investments <span class="font-bold text-green-600" id="totalInvestmentsSummary"></span></h3>
                            <div id="investmentAccountsContainer" class="mb-4 space-y-4">
                                </div>
                            <button id="addInvestmentBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Investment Account
                            </button>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Homes <span class="font-bold text-green-600" id="totalHomesSummary"></span></h3>
                            <div id="homesContainer" class="mb-4 space-y-4">
                                </div>
                            <button id="addHomeBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Home
                            </button>
                        </div>
                    </div>

                    <div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Other Assets <span class="font-bold text-green-600" id="totalOtherStaticAssetsSummary"></span></h3>
                            <div id="otherStaticAssetsContainer" class="mb-4 space-y-4">
                                </div>
                            <button id="addOtherStaticAssetBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Asset
                            </button>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Liabilities <span class="font-bold text-red-600" id="totalLiabilitiesSummary"></span></h3>
                            <div id="liabilitiesContainer" class="mb-4 space-y-4">
                                </div>
                            <button id="addLiabilityBtn" type="button" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Liability
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-6 text-blue-700">2. Income, Savings, and Assumptions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Income & Contribution Assumptions</h3>
                        <div class="mb-2"> <label for="currentAge" class="label-style">Current Age</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="currentAgeValue"></span>
                                <input type="range" id="currentAge" min="18" max="100" value="38" step="1" class="w-full">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="baseSalary" class="label-style">Base Salary ($)</label>
                            <input type="text" id="baseSalary" value="179386" class="input-field">
                        </div>

                        <div class="mb-2">
                            <label for="bonusRate" class="label-style">Bonus Rate (% of Base Salary)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="bonusRateValue"></span>
                                <input type="range" id="bonusRate" min="0" max="50" value="23" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="my401kContributionRate" class="label-style">My 401K Contribution Rate (% of Base Salary)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="my401kContributionRateValue"></span>
                                <input type="range" id="my401kContributionRate" min="0" max="20" value="6" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="company401kContributionRate" class="label-style">Company 401K Contribution Rate (% of Base Salary)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="company401kContributionRateValue"></span>
                                <input type="range" id="company401kContributionRate" min="0" max="20" value="10" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="monthlyHSAContribution" class="label-style">Monthly HSA Contribution ($)</label>
                            <input type="text" id="monthlyHSAContribution" value="600" class="input-field">
                        </div>

                        <div class="mb-4">
                            <label for="annualRothContribution" class="label-style">Other Annual Savings Contribution ($)</label>
                            <input type="text" id="annualRothContribution" value="0" class="input-field">
                        </div>
                        <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Other Income (Continues Post-Retirement)</h3>
                        <div class="flex items-center text-sm font-semibold mb-2 ml-2">
                            <div class="flex-1 min-w-[120px]">Income Description</div>
                            <div class="flex-1 min-w-[100px]">Monthly Amount</div>
                            <div class="w-24 ml-1">Annual Escalation</div>
                            <div class="w-6"></div> </div>
                        <div id="otherIncomeContainer" class="mb-4 space-y-4">
                            </div>
                        <button id="addOtherIncomeBtn" type="button" class="mt-4 bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                            + Add Other Income
                        </button>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Growth & Expense Assumptions</h3>
                        <div class="mb-2">
                            <label for="annualSalaryRaise" class="label-style">Annual Salary Raise (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="annualSalaryRaiseValue"></span>
                                <input type="range" id="annualSalaryRaise" min="0" max="10" value="4" step="0.1" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="stockAppreciation" class="label-style">Stock Appreciation (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="stockAppreciationValue"></span>
                                <input type="range" id="stockAppreciation" min="0" max="15" value="9" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="housingAppreciation" class="label-style">Housing Appreciation (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="housingAppreciationValue"></span>
                                <input type="range" id="housingAppreciation" min="0" max="10" value="4" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="inflation" class="label-style">Inflation (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="inflationValue"></span>
                                <input type="range" id="inflation" min="0" max="10" value="3" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="retirementDrawRatePre62" class="label-style">Pre-62 YO Draw (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="retirementDrawRatePre62Value"></span>
                                <input type="range" id="retirementDrawRatePre62" min="0" max="10" value="6" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="retirementDrawRatePost62" class="label-style">Post-62 YO Draw (%)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="retirementDrawRatePost62Value"></span>
                                <input type="range" id="retirementDrawRatePost62" min="0" max="5" value="5" step="0.5" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="socialSecurityStartAge" class="label-style">Social Security Start Age</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="socialSecurityStartAgeValue"></span>
                                <input type="range" id="socialSecurityStartAge" min="62" max="70" value="62" step="1" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="socialSecurityMonthly" class="label-style" id="socialSecurityMonthlyLabel">Social Security at 62 ($)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="socialSecurityMonthlyValue"></span>
                                <input type="range" id="socialSecurityMonthly" min="0" max="5000" value="2800" step="100" class="w-full">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="retirementYear" class="label-style">Retirement Year (Age)</label>
                            <div class="slider-input-wrapper">
                                <span class="slider-value-display" id="retirementYearValue"></span>
                                <input type="range" id="retirementYear" min="38" max="80" value="55" step="1" class="w-full">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="monthlyPrincipalPayment" class="label-style">Monthly Principal Payment ($)</label>
                            <input type="text" id="monthlyPrincipalPayment" value="1428" class="input-field">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">3. Projected Growth Chart</h2>
                <div id="chart-container" class="w-full overflow-x-auto">
                    </div>
                <div class="flex justify-center mt-4 space-x-6 text-gray-700 font-semibold">
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #2563eb;"></span>
                        Net Investments
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #10b981;"></span>
                        Net Worth
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #800080;"></span>
                        Net Worth (Today's $)
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">4. Projected Growth Table</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-blue-600 text-white uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Age</th>
                                <th class="py-3 px-6 text-left">Year</th>
                                <th class="py-3 px-6 text-left">Investments</th>
                                <th class="py-3 px-6 text-left">Net Worth</th>
                                <th class="py-3 px-6 text-left">Net Worth (Today's $)</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTableBody" class="text-gray-700 text-sm font-light divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-orange-50 p-6 rounded-lg shadow-md border border-orange-200 mt-8">
                <h2 class="text-2xl font-bold mb-4 text-orange-700">5. 72(t) Fixed Distribution Projection</h2>
                <p class="text-sm text-gray-600 mb-4">
                    This projection calculates **fixed annual distributions** from a 401K account using the Amortization Method (based on IRS Uniform Lifetime Table and a user-defined interest rate). The 401K balance within this projection will grow by your main "Stock Appreciation" rate. The amounts shown here are *only* for this 72(t) account and do not factor into your main retirement projections.
                </p>
                <div class="mb-2">
                    <label for="seventyTwoTStartAge" class="label-style">72(t) Starting Age</label>
                    <div class="slider-input-wrapper">
                        <span class="slider-value-display" id="seventyTwoTStartAgeValue"></span>
                        <input type="range" id="seventyTwoTStartAge" min="38" max="70" value="59.5" step="0.5" class="w-full">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="seventyTwoTInterestRate" class="label-style">72(t) Calculation Interest Rate (%)</label>
                    <div class="slider-input-wrapper">
                        <span class="slider-value-display" id="seventyTwoTInterestRateValue"></span>
                        <input type="range" id="seventyTwoTInterestRate" min="0.1" max="10" value="4.0" step="0.1" class="w-full">
                    </div>
                </div>

                <h3 class="text-xl font-semibold mb-4 text-gray-800">Projected 72(t) Distributions</h3>
                <div id="seventyTwoTChartContainer" class="w-full overflow-x-auto mb-8">
                    </div>
                 <div class="flex justify-center mt-4 space-x-6 text-gray-700 font-semibold">
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #2563eb;"></span>
                        Account Balance
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #f97316;"></span>
                        Annual Distribution
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mt-4">
                    <table class="min-w-full bg-white">
                        <thead class="bg-orange-600 text-white uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Age</th>
                                <th class="py-3 px-6 text-left">Annual Distribution</th>
                                <th class="py-3 px-6 text-left">Remaining Balance</th>
                            </tr>
                        </thead>
                        <tbody id="seventyTwoTTableBody" class="text-gray-700 text-sm font-light divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
