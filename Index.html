<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your actual web app's Firebase configuration (obtained from Firebase Console)
    const firebaseConfig = {
        apiKey: "AIzaSyCC1UKUPFRUnWyQ09hGFkJxVEVBBkZ7X40",
        authDomain: "investment-calculator-931f2.firebaseapp.com",
        databaseURL: "https://investment-calculator-931f2-default-rtdb.firebaseio.com",
        projectId: "investment-calculator-931f2",
        storageBucket: "investment-calculator-931f2.firebasestorage.app",
        messagingSenderId: "943895110805",
        appId: "1:943895110805:web:ba6e1e6177ae31d7af279c",
        measurementId: "G-F0CRPKLS7G"
    };

    // Use the actual appId from your firebaseConfig when hosting on GitHub Pages
    const appId = firebaseConfig.appId;
    // initialAuthToken is only provided in Canvas, so it will be null here, leading to anonymous sign-in
    const initialAuthToken = null;


    // Global Firebase vars
    let app;
    let db;
    let auth;
    let userId; // Will store the authenticated user ID

    // Firestore Paths - Using a public collection for shared data
    // The appId ensures that data is scoped to this specific application instance
    const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/retirement_calculator`;
    const SHARED_DOC_ID = 'shared_inputs'; // A single document for all shared inputs

    // Revision Level
    const appRevision = "1.31"; // Updated predefined values from the image.

    // Predefined default values for dynamic sections
    const defaultInvestmentAccounts = [
        { name: "401K", value: 527030 },
        { name: "Roth 1", value: 178181 },
        { name: "Roth 2", value: 157347 },
        { name: "529", value: 55836 },
        { name: "HSA", value: 25340 },
        { name: "Gold", value: 6600 }
    ];

    const defaultHomes = [
        { name: "Personal Home", value: 599000 },
        { name: "Rental Home", value: 199000 },
        { name: "Lake Home", value: 181000 }
    ];

    const defaultOtherStaticAssets = [
        { name: "Suburban", value: 32000 },
        { name: "Tractor", value: 16000 },
        { name: "RV", value: 25000 },
        { name: "Checking", value: 17522 }
    ];

    const defaultLiabilities = [
        { name: "Home Mortgage", value: 202212 },
        { name: "Credit Cards", value: 0 }
    ];

    // ADDED: Default Other Incomes based on your information
    const defaultOtherIncomes = [
        { name: "Cell Tower Lease", value: 1200, escalationRate: 0.015 },
        { name: "Rental Income", value: 1300, escalationRate: 0.04 }
    ];

        // Flag to prevent saving when data is being loaded from Firestore
        window.isLoadingFromFirestore = false;

        // Helper functions for number formatting in input fields
        function formatInputNumber(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // Ensure value is treated as a number before formatting, removing existing commas
            let num = Number(String(value).replace(/,/g, ''));
            if (isNaN(num)) {
                return '';
            }
            return new Intl.NumberFormat('en-US').format(num);
        }

        function cleanInputNumber(stringValue) {
            if (stringValue === null || stringValue === undefined || stringValue === '') {
                return 0;
            }
            // Remove all non-digit characters except for a potential leading minus sign and decimal
            const cleaned = stringValue.replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // Get references to all static input elements
        const staticInputs = {
            currentAge: document.getElementById('currentAge'),
            baseSalary: document.getElementById('baseSalary'),
            bonusRate: document.getElementById('bonusRate'),
            my401kContributionRate: document.getElementById('my401kContributionRate'),
            company401kContributionRate: document.getElementById('company401kContributionRate'),
            annualRothContribution: document.getElementById('annualRothContribution'),
            monthlyHSAContribution: document.getElementById('monthlyHSAContribution'),
            annualSalaryRaise: document.getElementById('annualSalaryRaise'),
            stockAppreciation: document.getElementById('stockAppreciation'),
            housingAppreciation: document.getElementById('housingAppreciation'),
            inflation: document.getElementById('inflation'),
            retirementDrawRatePre62: document.getElementById('retirementDrawRatePre62'),
            retirementDrawRatePost62: document.getElementById('retirementDrawRatePost62'),
            retirementYear: document.getElementById('retirementYear'),
            monthlyPrincipalPayment: document.getElementById('monthlyPrincipalPayment'),
            socialSecurityStartAge: document.getElementById('socialSecurityStartAge'),
            socialSecurityMonthly: document.getElementById('socialSecurityMonthly')
        };

        // Get references to display elements
        const currentNetWorthDisplay = document.getElementById('currentNetWorth');
        const currentNetInvestmentsDisplay = document.getElementById('currentNetInvestments');
        const annualIncomeDisplay = document.getElementById('annualIncomeDisplay');
        const annualSavingsDisplay = document.getElementById('annualSavingsDisplay');
        const todaysDrawDisplay = document.getElementById('todaysDraw');
        const dynamicRetirementDrawLabel = document.getElementById('dynamicRetirementDrawLabel');
        const dynamicRetirementDrawValue = document.getElementById('dynamicRetirementDrawValue');
        const ssStartAgeDrawDisplay = document.getElementById('ssStartAgeDraw'); // Changed ID from sixtyTwoYODraw
        const dynamicRetirementDrawLabelSticky = document.getElementById('dynamicRetirementDrawLabelSticky');
        const dynamicRetirementDrawValueSticky = document.getElementById('dynamicRetirementDrawValueSticky');
        const projectionTableBody = document.getElementById('projectionTableBody');
        const investmentAccountsContainer = document.getElementById('investmentAccountsContainer');
        const addInvestmentBtn = document.getElementById('addInvestmentBtn');
        const homesContainer = document.getElementById('homesContainer'); // New container for homes
        const addHomeBtn = document.getElementById('addHomeBtn'); // New button for homes
        const otherStaticAssetsContainer = document.getElementById('otherStaticAssetsContainer'); // Renamed for static assets
        const addOtherStaticAssetBtn = document.getElementById('addOtherStaticAssetBtn'); // Renamed for static assets
        const liabilitiesContainer = document.getElementById('liabilitiesContainer');
        const addLiabilityBtn = document.getElementById('addLiabilityBtn');
        const otherIncomeContainer = document.getElementById('otherIncomeContainer');
        const addOtherIncomeBtn = document.getElementById('addOtherIncomeBtn');
        const chartContainer = document.getElementById('chart-container');
        const appRevisionDisplay = document.getElementById('appRevisionDisplay');

        // References for the summary spans
        const totalInvestmentsSummary = document.getElementById('totalInvestmentsSummary');
        const totalHomesSummary = document.getElementById('totalHomesSummary'); // New summary for homes
        const totalOtherStaticAssetsSummary = document.getElementById('totalOtherStaticAssetsSummary'); // New summary for static assets
        const totalLiabilitiesSummary = document.getElementById('totalLiabilitiesSummary');

        // New references for labels
        const socialSecurityMonthlyLabel = document.getElementById('socialSecurityMonthlyLabel');
        const ssStartAgeDrawLabel = document.getElementById('ssStartAgeDrawLabel');


        // Get references to slider input and value display pairs
        const sliderPairs = [
            { slider: staticInputs.currentAge, valueDisplay: document.getElementById('currentAgeValue'), unit: '' },
            { slider: staticInputs.bonusRate, valueDisplay: document.getElementById('bonusRateValue'), unit: '%' },
            { slider: staticInputs.my401kContributionRate, valueDisplay: document.getElementById('my401kContributionRateValue'), unit: '%' },
            { slider: staticInputs.company401kContributionRate, valueDisplay: document.getElementById('company401kContributionRateValue'), unit: '%' },
            { slider: staticInputs.annualSalaryRaise, valueDisplay: document.getElementById('annualSalaryRaiseValue'), unit: '%' },
            { slider: staticInputs.stockAppreciation, valueDisplay: document.getElementById('stockAppreciationValue'), unit: '%' },
            { slider: staticInputs.housingAppreciation, valueDisplay: document.getElementById('housingAppreciationValue'), unit: '%' },
            { slider: staticInputs.inflation, valueDisplay: document.getElementById('inflationValue'), unit: '%' },
            { slider: staticInputs.retirementDrawRatePre62, valueDisplay: document.getElementById('retirementDrawRatePre62Value'), unit: '%' },
            { slider: staticInputs.retirementDrawRatePost62, valueDisplay: document.getElementById('retirementDrawRatePost62Value'), unit: '%' },
            { slider: staticInputs.retirementYear, valueDisplay: document.getElementById('retirementYearValue'), unit: '' },
            { slider: staticInputs.socialSecurityStartAge, valueDisplay: document.getElementById('socialSecurityStartAgeValue'), unit: '' },
            { slider: staticInputs.socialSecurityMonthly, valueDisplay: document.getElementById('socialSecurityMonthlyValue'), unit: '' }
        ];

        // Function to format numbers as currency, rounded to nearest thousand, without K/M (for table)
        const formatTableCurrency = (amount) => {
            const roundedAmount = Math.round(amount / 1000) * 1000;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(roundedAmount);
        };

        // Function to format numbers as currency with K/M and specified decimal places (for summary displays)
        const formatLargeCurrency = (amount) => {
            if (Math.abs(amount) >= 1000000) {
                return `$${(amount / 1000000).toFixed(2)}M`;
            }
            if (Math.abs(amount) >= 1000) {
                return `$${(amount / 1000).toFixed(0)}K`;
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Function to format Y-axis labels dynamically based on max value in the chart
        function formatProjectedChartAxisLabel(value, maxChartValue) {
            if (maxChartValue < 5000000) { // If max value is under 5 million, show in thousands
                return `$${(value / 1000).toFixed(0)}K`; // No decimals for K
            } else { // Otherwise, show in millions
                return `$${(value / 1000000).toFixed(0)}M`; // No decimals for M
            }
        }

        // Function to update slider value display
        function updateSliderValueDisplay(slider, valueDisplay, unit) {
            const val = parseFloat(slider.value);
            valueDisplay.textContent = `${val.toFixed(slider.step === '0.1' || slider.step === '0.5' ? 1 : 0)}${unit}`;
        }

        // NEW: Helper function to format percentage for APY display
        function formatPercentageAPY(rate) {
            const percentage = rate * 100;
            // Show one decimal place if there is a fractional part (e.g., 9.5%), otherwise show as whole number (e.g., 10%)
            if (percentage % 1 !== 0) {
                return percentage.toFixed(1);
            } else {
                return percentage.toFixed(0);
            }
        }

        // Firebase Initialization
        const initFirebase = async () => {
            console.log("Initializing Firebase...");
            try {
                // Ensure firebaseConfig is logged to confirm it's available
                console.log("Firebase Config:", firebaseConfig);

                // Initialize app and get services directly
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Get auth instance immediately

                // Use onAuthStateChanged to manage the authentication state.
                // This ensures we react to Firebase's internal auth state readiness.
                // For GitHub Pages, we'll primarily rely on anonymous sign-in.
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // If no user is signed in, attempt anonymous sign-in
                            console.log("Attempting anonymous sign-in...");
                            try {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Firebase authenticated anonymously. User ID:", userId);
                            } catch (anonError) {
                                console.error("Anonymous sign-in failed:", anonError);
                                unsubscribe(); // Unsubscribe even on failure
                                reject(anonError); // Reject the promise if anonymous fails
                                return; // Exit to prevent further execution in this branch
                            }
                        } else {
                            // User is already signed in (e.g., from a previous anonymous session)
                            userId = user.uid;
                            console.log("Firebase auth state detected existing user:", userId);
                        }
                        unsubscribe(); // Unsubscribe after the first relevant state change
                        resolve(); // Resolve the promise once auth state is settled
                    }, (error) => {
                        // Error during initial auth state observation
                        console.error("Error observing Firebase auth state:", error);
                        unsubscribe();
                        reject(error);
                    });
                });

                // Only proceed to setupRealtimeListener once authentication is confirmed
                setupRealtimeListener();
            } catch (error) {
                console.error("Critical error during Firebase initialization or authentication flow:", error);
                throw error; // Re-throw to be caught by the DOMContentLoaded catch block
            }
        };

        // Function to save data to Firestore
        async function saveDataToFirestore(data) {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Data not saved.");
                return;
            }
            // Prevent saving if the update came from Firestore itself
            if (window.isLoadingFromFirestore) {
                console.log("Skipping save: Data currently being loaded from Firestore.");
                return;
            }
            console.log("Attempting to save data to Firestore:", data);
            try {
                const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
                await setDoc(docRef, data, { merge: true }); // Merge to update specific fields
                console.log("Data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        /**
         * Gathers all current input values (static and dynamic) from the DOM.
         * This function is used to create a snapshot of the current UI state to save to Firestore.
         * @returns {Object} An object containing all current financial input data.
         */
        function collectAllCurrentInputs() {
            let collectedData = {};

            // Collect static input values
            for (const key in staticInputs) {
                // Ensure the element actually exists before trying to access its value
                if (staticInputs[key]) {
                    let value;
                    // For range inputs, parse directly
                    if (staticInputs[key].type === 'range') {
                        value = parseFloat(staticInputs[key].value);
                    } else { // For text inputs, clean the formatted string
                        value = cleanInputNumber(staticInputs[key].value);
                    }
                    // Convert percentages to decimal for internal calculations and storage
                    if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62'].includes(key)) {
                        value = value / 100;
                    }
                    collectedData[key] = value;
                }
            }

            // Collect dynamic investment account values
            collectedData.investmentAccounts = [];
            document.querySelectorAll('.investment-row').forEach(row => {
                const name = row.querySelector('.investment-name').value;
                const value = cleanInputNumber(row.querySelector('.investment-value').value);
                collectedData.investmentAccounts.push({ name, value });
            });

            // Collect dynamic homes values
            collectedData.homes = [];
            document.querySelectorAll('.home-row').forEach(row => {
                const name = row.querySelector('.home-name').value;
                const value = cleanInputNumber(row.querySelector('.home-value').value);
                collectedData.homes.push({ name, value });
            });

            // Collect dynamic other static asset values
            collectedData.otherStaticAssets = [];
            document.querySelectorAll('.other-static-asset-row').forEach(row => {
                const name = row.querySelector('.static-asset-name').value;
                const value = cleanInputNumber(row.querySelector('.static-asset-value').value);
                collectedData.otherStaticAssets.push({ name, value });
            });

            // Collect dynamic liability values
            collectedData.liabilities = [];
            document.querySelectorAll('.liability-row').forEach(row => {
                const name = row.querySelector('.liability-name').value;
                const value = cleanInputNumber(row.querySelector('.liability-value').value);
                collectedData.liabilities.push({ name, value });
            });

            // Collect dynamic other income values
            collectedData.otherIncome = [];
            document.querySelectorAll('.other-income-row').forEach(row => {
                const name = row.querySelector('.income-name').value;
                const value = cleanInputNumber(row.querySelector('.income-value').value);
                const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
                collectedData.otherIncome.push({ name, value, escalationRate });
            });

            return collectedData;
        }


        // Function to set up real-time listener for data
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Cannot set up listener.");
                return;
            }
            console.log("Setting up real-time Firestore listener.");
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
            onSnapshot(docRef, async (docSnap) => {
                window.isLoadingFromFirestore = true;
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Data loaded from Firestore:", data);
                    populateInputsFromFirestore(data);
                } else {
                    console.log("No shared data found in Firestore. Initializing with provided values and saving this state.");
                    // Explicitly clear dynamic inputs
                    investmentAccountsContainer.innerHTML = '';
                    homesContainer.innerHTML = '';
                    otherStaticAssetsContainer.innerHTML = '';
                    liabilitiesContainer.innerHTML = '';
                    otherIncomeContainer.innerHTML = '';

                    // Add dynamic rows with user-provided default values
                    defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
                    defaultHomes.forEach(home => addHomeInput(home));
                    defaultOtherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
                    defaultLiabilities.forEach(liability => addLiabilityInput(liability));
                    defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
                    
                    // Call calculateFinancials to update display and save the initial state with defaults
                    calculateFinancials(true);
                }
                window.isLoadingFromFirestore = false;
            }, (error) => {
                console.error("Error listening to Firestore document:", error);
                calculateFinancials(false); // Fallback to local calculation
                window.isLoadingFromFirestore = false;
            });
        }

        // Function to populate inputs from Firestore data
        function populateInputsFromFirestore(data) {
            // Update static inputs
            for (const key in staticInputs) {
                // Ensure the target element exists before trying to set its value
                if (staticInputs[key] && data[key] !== undefined) {
                    let value = data[key];
                    // Special handling for percentage sliders to convert back to 0-100 range for display
                    if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62'].includes(key)) {
                        value = parseFloat(value) * 100; // Convert decimal back to percentage for UI
                    }

                    if (staticInputs[key].type === 'range') {
                        staticInputs[key].value = value;
                    } else {
                        staticInputs[key].value = formatInputNumber(value);
                    }
                    // Update the visual display for sliders
                    const pair = sliderPairs.find(p => p.slider === staticInputs[key]);
                    if (pair) {
                        updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
                    }
                }
            }

            // Update dynamic inputs (investments, homes, other static assets, liabilities, other income)
            // Clear existing dynamic rows first to avoid duplicates
            investmentAccountsContainer.innerHTML = '';
            homesContainer.innerHTML = '';
            otherStaticAssetsContainer.innerHTML = '';
            liabilitiesContainer.innerHTML = '';
            otherIncomeContainer.innerHTML = '';

            // Handle Investment Accounts
            if (data.investmentAccounts && data.investmentAccounts.length > 0) {
                data.investmentAccounts.forEach(account => addInvestmentAccountInput(account));
            } else {
                defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
            }

            // Handle Homes
            if (data.homes && data.homes.length > 0) {
                data.homes.forEach(home => addHomeInput(home));
            } else {
                defaultHomes.forEach(home => addHomeInput(home));
            }

            // Handle Other Static Assets
            if (data.otherStaticAssets && data.otherStaticAssets.length > 0) {
                data.otherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
            } else {
                defaultOtherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
            }

            // Handle Liabilities
            if (data.liabilities && data.liabilities.length > 0) {
                data.liabilities.forEach(liability => addLiabilityInput(liability));
            } else {
                defaultLiabilities.forEach(liability => addLiabilityInput(liability));
            }

            // Handle Other Income
            if (data.otherIncome && data.otherIncome.length > 0) {
                data.otherIncome.forEach(income => addOtherIncomeInput(income));
            } else {
                defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
            }

            // After populating, recalculate to update summaries and chart (but don't save yet)
            calculateFinancials(false);
        }

        // Function to add a new investment account input row
        function addInvestmentAccountInput(account = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('investment-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Account Name" value="${account.name}" class="input-field investment-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(account.value)}" class="input-field investment-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            investmentAccountsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.investment-value');
            valueInput.addEventListener('input', (event) => {
                // Allow typing freely, no formatting on input
            });
            valueInput.addEventListener('blur', (event) => {
                event.target.value = formatInputNumber(event.target.value); // Format on blur
                calculateFinancials(true); // Trigger save on blur
            });
            const nameInput = rowDiv.querySelector('.investment-name');
            nameInput.addEventListener('blur', () => calculateFinancials(true)); // Trigger save on blur

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // NEW: Function to add a new home input row
        function addHomeInput(home = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('home-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Home Name" value="${home.name}" class="input-field home-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(home.value)}" class="input-field home-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            homesContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.home-value');
            valueInput.addEventListener('input', (event) => {
                // Allow typing freely, no formatting on input
            });
            valueInput.addEventListener('blur', (event) => {
                event.target.value = formatInputNumber(event.target.value); // Format on blur
                calculateFinancials(true); // Trigger save on blur
            });
            const nameInput = rowDiv.querySelector('.home-name');
            nameInput.addEventListener('blur', () => calculateFinancials(true)); // Trigger save on blur

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // NEW: Function to add a new other static asset input row
        function addOtherStaticAssetInput(asset = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-static-asset-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Asset Name" value="${asset.name}" class="input-field static-asset-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(asset.value)}" class="input-field static-asset-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherStaticAssetsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.static-asset-value');
            valueInput.addEventListener('input', (event) => {
                // Allow typing freely, no formatting on input
            });
            valueInput.addEventListener('blur', (event) => {
                event.target.value = formatInputNumber(event.target.value); // Format on blur
                calculateFinancials(true); // Trigger save on blur
            });
            const nameInput = rowDiv.querySelector('.static-asset-name');
            nameInput.addEventListener('blur', () => calculateFinancials(true)); // Trigger save on blur

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }


        // Function to add a new liability input row
        function addLiabilityInput(liability = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('liability-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Liability Name" value="${liability.name}" class="input-field liability-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(liability.value)}" class="input-field liability-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            liabilitiesContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.liability-value');
            valueInput.addEventListener('input', (event) => {
                // Allow typing freely, no formatting on input
            });
            valueInput.addEventListener('blur', (event) => {
                event.target.value = formatInputNumber(event.target.value); // Format on blur
                calculateFinancials(true); // Trigger save on blur
            });
            const nameInput = rowDiv.querySelector('.liability-name');
            nameInput.addEventListener('blur', () => calculateFinancials(true)); // Trigger save on blur

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new other income input row
        function addOtherIncomeInput(income = { name: '', value: 0, escalationRate: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-income-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Income Source" value="${income.name}" class="input-field income-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Monthly Value ($)" value="${formatInputNumber(income.value)}" class="input-field income-value flex-1 min-w-[100px]">
                <div class="flex items-center">
                    <input type="number" placeholder="Escalation Rate" value="${(income.escalationRate * 100).toFixed(1)}" step="0.1" min="0" max="10" class="input-field income-escalation-rate w-24">
                    <span class="ml-1 text-gray-700">%</span>
                </div>
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherIncomeContainer.appendChild(rowDiv);

            // Attach event listeners for value and escalation rate, and for name changes
            rowDiv.querySelectorAll('input').forEach(input => {
                if (input.classList.contains('income-value')) {
                    input.addEventListener('input', (event) => {
                        // Allow typing freely, no formatting on input
                    });
                    input.addEventListener('blur', (event) => {
                        event.target.value = formatInputNumber(event.target.value); // Format on blur
                        calculateFinancials(true); // Trigger save on blur
                    });
                } else if (input.classList.contains('income-name')) {
                    input.addEventListener('blur', () => calculateFinancials(true)); // Trigger save on blur
                } else if (input.classList.contains('income-escalation-rate')) {
                    input.addEventListener('input', () => calculateFinancials(true)); // Still trigger on input for immediate feedback on escalation rate
                }
            });

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Main calculation function (now accepts a shouldSave flag)
        function calculateFinancials(shouldSaveData = true) {
            let totalInvestments = 0;
            let totalHomes = 0; // New variable for total homes value
            let totalOtherStaticAssets = 0; // New variable for total static assets
            let totalLiabilities = 0;
            let currentMortgageValue = 0; // Specific mortgage value for reduction logic

            let currentFinancials = {}; // Object to store all inputs for saving

            // Collect static input values
            for (const key in staticInputs) {
                // Check if the element exists before trying to access its value
                if (staticInputs[key]) {
                    let value;
                    if (staticInputs[key].type === 'range') {
                        value = parseFloat(staticInputs[key].value);
                    } else { // Text inputs
                        value = cleanInputNumber(staticInputs[key].value);
                    }
                    // Convert percentages to decimal for internal calculations and storage
                    if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62'].includes(key)) {
                        value = value / 100;
                    }
                    currentFinancials[key] = value;
                }
            }

            // Read dynamic investment account values
            currentFinancials.investmentAccounts = [];
            document.querySelectorAll('.investment-row').forEach(row => {
                const name = row.querySelector('.investment-name').value;
                const value = cleanInputNumber(row.querySelector('.investment-value').value);
                totalInvestments += value;
                currentFinancials.investmentAccounts.push({ name, value });
            });

            // Read dynamic homes values
            currentFinancials.homes = [];
            document.querySelectorAll('.home-row').forEach(row => {
                const name = row.querySelector('.home-name').value;
                const value = cleanInputNumber(row.querySelector('.home-value').value);
                totalHomes += value;
                currentFinancials.homes.push({ name, value });
            });

            // Read dynamic other static asset values
            currentFinancials.otherStaticAssets = [];
            document.querySelectorAll('.other-static-asset-row').forEach(row => {
                const name = row.querySelector('.static-asset-name').value;
                const value = cleanInputNumber(row.querySelector('.static-asset-value').value);
                totalOtherStaticAssets += value;
                currentFinancials.otherStaticAssets.push({ name, value });
            });

            // Read dynamic liability values
            currentFinancials.liabilities = [];
            document.querySelectorAll('.liability-row').forEach(row => {
                const nameInput = row.querySelector('.liability-name');
                const valueInput = row.querySelector('.liability-value');
                const name = nameInput.value;
                const value = cleanInputNumber(valueInput.value);
                totalLiabilities += value;
                currentFinancials.liabilities.push({ name, value });

                if (name.toLowerCase() === "home mortgage") { // Ensure exact match for mortgage
                    currentMortgageValue = value;
                }
            });

            // Read dynamic other income values
            currentFinancials.otherIncome = [];
            let totalOtherMonthlyIncome = 0;
            document.querySelectorAll('.other-income-row').forEach(row => {
                const name = row.querySelector('.income-name').value;
                const value = cleanInputNumber(row.querySelector('.income-value').value);
                const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
                currentFinancials.otherIncome.push({ name, value, escalationRate });
                totalOtherMonthlyIncome += value;
            });

            // Re-read values from currentFinancials for calculations to ensure consistency with what's being saved
            const currentAge = currentFinancials.currentAge;
            const baseSalary = currentFinancials.baseSalary;
            const bonusRate = currentFinancials.bonusRate;
            const my401kContributionRate = currentFinancials.my401kContributionRate;
            const company401kContributionRate = currentFinancials.company401kContributionRate;
            const annualRothContribution = currentFinancials.annualRothContribution;
            const monthlyHSAContribution = currentFinancials.monthlyHSAContribution;
            const annualSalaryRaise = currentFinancials.annualSalaryRaise;
            const stockAppreciation = currentFinancials.stockAppreciation;
            const housingAppreciation = currentFinancials.housingAppreciation;
            const inflation = currentFinancials.inflation;
            const retirementDrawRatePre62 = currentFinancials.retirementDrawRatePre62;
            const retirementDrawRatePost62 = currentFinancials.retirementDrawRatePost62;
            const retirementYear = currentFinancials.retirementYear;
            const monthlyPrincipalPayment = currentFinancials.monthlyPrincipalPayment;
            const socialSecurityStartAge = currentFinancials.socialSecurityStartAge;
            const socialSecurityMonthly = currentFinancials.socialSecurityMonthly;
            const annualPrincipalPayment = monthlyPrincipalPayment * 12;

            // Update min for retirementYear slider dynamically based on currentAge
            staticInputs.retirementYear.min = currentAge;
            if (retirementYear < currentAge) {
                staticInputs.retirementYear.value = currentAge;
            }

            // Update slider value displays (already done in populateInputsFromFirestore or event listeners)
            sliderPairs.forEach(pair => {
                // Ensure the slider and display elements exist before updating
                if (pair.slider && pair.valueDisplay) {
                    updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
                }
            });

            // Update dynamic retirement draw labels based on slider value
            dynamicRetirementDrawLabel.textContent = `${retirementYear} YO Draw (Today's $):`;
            dynamicRetirementDrawLabelSticky.textContent = `${retirementYear} YO Draw (Today's $):`;

            // Dynamically update the Social Security Monthly slider label
            socialSecurityMonthlyLabel.textContent = `Social Security at ${socialSecurityStartAge} ($)`;
            // Dynamically update the SS Start Age Draw snapshot label
            ssStartAgeDrawLabel.textContent = `${socialSecurityStartAge} YO Draw (Today's $):`;


            // Calculate Net Worth and Net Investments
            const currentTotalAssets = totalInvestments + totalHomes + totalOtherStaticAssets;
            const currentNetWorth = currentTotalAssets - totalLiabilities;
            const currentNetInvestments = totalInvestments; // Net Investments is still just investment accounts

            // Calculate Annual Income (for display only in Snapshot)
            const annualBonusIncome = baseSalary * bonusRate;
            const totalAnnualOtherIncome = totalOtherMonthlyIncome * 12;
            const totalAnnualIncome = baseSalary + annualBonusIncome + totalAnnualOtherIncome;

            // Calculate Total Annual Savings (only those explicitly going into investments)
            const totalAnnualSavings =
                (baseSalary * my401kContributionRate) +
                (baseSalary * company401kContributionRate) +
                (monthlyHSAContribution * 12) +
                annualRothContribution;

            // Display current values using new formatting
            currentNetWorthDisplay.textContent = formatLargeCurrency(currentNetWorth);
            currentNetInvestmentsDisplay.textContent = formatLargeCurrency(currentNetInvestments);
            annualIncomeDisplay.textContent = formatLargeCurrency(totalAnnualIncome);
            annualSavingsDisplay.textContent = formatLargeCurrency(totalAnnualSavings); // Display only investment-related savings

            // Update the summary spans
            totalInvestmentsSummary.textContent = `(${formatLargeCurrency(totalInvestments)}) ${formatPercentageAPY(stockAppreciation)}% APY`;
            totalHomesSummary.textContent = `(${formatLargeCurrency(totalHomes)}) ${formatPercentageAPY(housingAppreciation)}% APY`;
            totalOtherStaticAssetsSummary.textContent = `(${formatLargeCurrency(totalOtherStaticAssets)})`; // No APY for static assets
            totalLiabilitiesSummary.textContent = `(${formatLargeCurrency(totalLiabilities)})`;

            // Project growth over years
            projectGrowth(currentNetInvestments, currentNetWorth,
                            totalHomes, totalOtherStaticAssets, // Pass new totals for homes and static assets
                            totalLiabilities, currentMortgageValue, baseSalary,
                            bonusRate, my401kContributionRate, company401kContributionRate,
                            annualRothContribution,
                            monthlyHSAContribution,
                            annualSalaryRaise, stockAppreciation,
                            housingAppreciation, inflation, annualPrincipalPayment,
                            currentFinancials.otherIncome,
                            currentAge,
                            retirementDrawRatePre62, retirementDrawRatePost62,
                            todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay, // Use new ID
                            retirementYear,
                            dynamicRetirementDrawValueSticky,
                            socialSecurityStartAge,
                            socialSecurityMonthly
                            );

            // Trigger saving if flag is true AND it's not from a Firestore load
            if (shouldSaveData && !window.isLoadingFromFirestore) {
                saveDataToFirestore(currentFinancials);
            }
        }


        function projectGrowth(initialNetInvestments, initialNetWorth,
                               initialHomesValue, initialOtherStaticAssetsValue, // New initial values for homes and static assets
                               initialTotalLiabilities, initialMortgageValue, initialBaseSalary,
                               bonusRate, my401kContributionRate, company401kContributionRate,
                               annualRothContribution,
                               monthlyHSAContribution,
                               annualSalaryRaise, stockAppreciation,
                               housingAppreciation, inflation, annualPrincipalPayment,
                               currentOtherIncomesStateForProjection,
                               initialAge,
                               retirementDrawRatePre62, retirementDrawRatePost62,
                               todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay,
                               retirementYearInput, dynamicRetirementDrawValueSticky,
                               socialSecurityStartAge,
                               socialSecurityMonthly
                               ) {

            projectionTableBody.innerHTML = '';
            chartContainer.innerHTML = '';

            let currentInvestments = initialNetInvestments;
            let currentHomesValue = initialHomesValue; // Use the initial total for homes
            let currentOtherStaticAssetsValue = initialOtherStaticAssetsValue; // Use the initial total for static assets
            let currentMortgage = initialMortgageValue;
            let currentOtherLiabilitiesTotal = initialTotalLiabilities - initialMortgageValue;
            let currentBaseSalary = initialBaseSalary;
            
            const startYear = new Date().getFullYear();
            let currentProjectedAge = initialAge;

            let projectedOtherIncomes = JSON.parse(JSON.stringify(currentOtherIncomesStateForProjection));
            const inflationRate = inflation;

            const chartData = [];

            // Calculate "Today's Draw" for snapshot display:
            // This is current investments * Pre-62 rate (from slider) + current total annual other income (from dynamic list)
            // Social Security is NOT included here as it only starts at the chosen SS age
            let initialTotalOtherAnnualIncomeSnapshot = 0;
            currentOtherIncomesStateForProjection.forEach(income => {
                initialTotalOtherAnnualIncomeSnapshot += income.value * 12;
            });
            const todaysDrawValue = (initialNetInvestments * retirementDrawRatePre62) + initialTotalOtherAnnualIncomeSnapshot;
            todaysDrawDisplay.textContent = formatLargeCurrency(todaysDrawValue);

            chartData.push({
                age: initialAge,
                investments: initialNetInvestments,
                netWorth: initialNetWorth, // Keep original net worth in future dollars for this line
                netWorthTodaysDollars: initialNetWorth / Math.pow((1 + inflationRate), 0) // Net worth in today's dollars
            });

            for (let i = 1; currentProjectedAge <= 80; i++) {
                const year = startYear + i;
                const age = currentProjectedAge;

                let annualContributionsToInvestments = 0;
                let currentAnnualOtherIncomeForYear = 0; // This is income for spending, not for investment growth

                // Calculate contributions only if not retired (explicit contributions)
                // Contributions stop once current age reaches or exceeds the retirement year input
                if (age < retirementYearInput) {
                    annualContributionsToInvestments =
                        (currentBaseSalary * my401kContributionRate) +
                        (currentBaseSalary * company401kContributionRate) +
                        (monthlyHSAContribution * 12) +
                        annualRothContribution;
                }

                // Update projected other incomes for the current year (always escalates for total income available for spending)
                projectedOtherIncomes.forEach(income => {
                    income.value *= (1 + income.escalationRate);
                    // Round down rental income to nearest $100 if escalation applies
                    if (income.name.toLowerCase().includes("rental") && income.escalationRate > 0) {
                        income.value = Math.floor(income.value / 100) * 100;
                    }
                    currentAnnualOtherIncomeForYear += income.value * 12; // Sum up for available income (e.g., rental, cell tower)
                });

                // Add explicit contributions to investments
                currentInvestments += annualContributionsToInvestments;

                // Apply investment growth
                currentInvestments *= (1 + stockAppreciation);

                // Apply housing appreciation to homes
                currentHomesValue *= (1 + housingAppreciation);

                // Other static assets remain static (no change needed here)

                let annualDrawFromInvestments = 0;
                let effectiveDrawRateForYear = 0;
                let annualSocialSecurityBenefit = 0;

                // Determine effective draw rate based on age relative to retirementYearInput and socialSecurityStartAge
                if (age >= retirementYearInput) {
                    if (age < socialSecurityStartAge) {
                        effectiveDrawRateForYear = retirementDrawRatePre62;
                    } else {
                        effectiveDrawRateForYear = retirementDrawRatePost62;
                        annualSocialSecurityBenefit = socialSecurityMonthly * 12; // Social Security starts at the chosen age
                    }
                    annualDrawFromInvestments = currentInvestments * effectiveDrawRateForYear;
                    currentInvestments -= annualDrawFromInvestments;
                }

                // Calculate total income available for spending (investment draw + other incomes + Social Security)
                const totalAnnualIncomeAvailable = annualDrawFromInvestments + currentAnnualOtherIncomeForYear + annualSocialSecurityBenefit;


                // Update the dynamic retirement draw value when the specific retirement year is reached
                if (age === retirementYearInput) {
                    const drawValueInTodaysDollars = totalAnnualIncomeAvailable / Math.pow((1 + inflationRate), i);
                    dynamicRetirementDrawValue.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                    dynamicRetirementDrawValueSticky.textContent = formatLargeCurrency(drawValueInTodaysDollars); // Update sticky value
                }

                // Update the SS Start Age Draw display (label is now dynamic)
                if (age === socialSecurityStartAge) {
                    const drawAtSSStartAge = (currentInvestments * retirementDrawRatePost62) + currentAnnualOtherIncomeForYear + (socialSecurityMonthly * 12);
                    const drawValueInTodaysDollarsAtSSStartAge = drawAtSSStartAge / Math.pow((1 + inflationRate), i);
                    ssStartAgeDrawDisplay.textContent = formatLargeCurrency(drawValueInTodaysDollarsAtSSStartAge); // Update new ID
                }
                
                // Reduce mortgage if it exists
                currentMortgage = Math.max(0, currentMortgage - annualPrincipalPayment);

                // Calculate total projected assets for net worth
                // Sum of current investments, current homes value, and current other static assets value
                let totalProjectedAssets = currentInvestments + currentHomesValue + currentOtherStaticAssetsValue;

                // Re-calculating net worth based on projected investments, projected total assets, and projected liabilities
                const currentTotalLiabilitiesInProjection = currentMortgage + currentOtherLiabilitiesTotal;
                let currentNetWorth = totalProjectedAssets - currentTotalLiabilitiesInProjection;

                const netWorthInTodaysDollars = currentNetWorth / Math.pow((1 + inflationRate), i);

                chartData.push({
                    age: age,
                    investments: currentInvestments,
                    netWorth: currentNetWorth, // Full net worth in future dollars
                    netWorthTodaysDollars: netWorthInTodaysDollars // Net worth in today's dollars
                });

                const row = projectionTableBody.insertRow();
                row.classList.add('hover:bg-blue-50');

                if (age % 5 === 0) {
                    row.classList.add('bg-blue-100');
                }

                row.insertCell().textContent = age;
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatTableCurrency(currentInvestments);
                row.insertCell().textContent = formatTableCurrency(currentNetWorth);
                row.insertCell().textContent = formatTableCurrency(netWorthInTodaysDollars);

                if (age < retirementYearInput) {
                    currentBaseSalary *= (1 + annualSalaryRaise);
                }
                
                currentProjectedAge++;
            }
            renderChart(chartData);
        }

        // D3.js Chart Rendering Function for Projected Growth
        function renderChart(data) {
            d3.select(chartContainer).select("svg").remove();

            const parentWidth = chartContainer.offsetWidth;
            const margin = { top: 40, right: 60, bottom: 50, left: 80 };
            const width = parentWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(chartContainer).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("class", "chart-svg")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.age))
                .range([0, width]);

            // Adjust yMax and yMin to account for the new netWorthTodaysDollars line
            const yMax = d3.max(data, d => Math.max(d.investments, d.netWorth, d.netWorthTodaysDollars));
            const yMin = d3.min(data, d => Math.min(d.investments, d.netWorth, d.netWorthTodaysDollars));

            const yScale = d3.scaleLinear()
                .domain([yMin * 0.95, yMax * 1.05])
                .range([height, 0]);

            const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
            const yAxisLeft = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));
            const yAxisRight = d3.axisRight(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax)); // Right axis

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis-left") // Left axis
                .call(yAxisLeft);

            svg.append("g")
                .attr("class", "y axis-right") // Right axis
                .attr("transform", `translate(${width}, 0)`) // Move to the right
                .call(yAxisRight);

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                );

            const lineInvestments = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.investments));

            const lineNetWorth = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.netWorth));
            
            // NEW: Line generator for Net Worth (Today's $)
            const lineNetWorthTodaysDollars = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.netWorthTodaysDollars));

            svg.append("path")
                .datum(data)
                .attr("class", "line line-investments")
                .attr("fill", "none")
                .attr("d", lineInvestments);

            svg.append("path")
                .datum(data)
                .attr("class", "line line-networth")
                .attr("fill", "none")
                .attr("d", lineNetWorth);
            
            // NEW: Append path for Net Worth (Today's $)
            svg.append("path")
                .datum(data)
                .attr("class", "line line-networth-todays-dollars")
                .attr("fill", "none")
                .attr("d", lineNetWorthTodaysDollars);

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Age");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 20)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Value ($)");

            svg.append("text")
                .attr("transform", "rotate(90)")
                .attr("y", width + margin.right - 20) /* Position to the right */
                .attr("x", height / 2) /* Center vertically */
                .attr("dy", "-1em") /* Adjust text position */
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Value ($)");

            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .text("Projected Investments & Net Worth");

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute");

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .on("mouseover", function() { focusInvestment.style("display", null); focusNetWorth.style("display", null); focusNetWorthTodaysDollars.style("display", null); tooltip.style("opacity", 1); })
                .on("mouseout", function() { focusInvestment.style("display", "none"); focusNetWorth.style("display", "none"); focusNetWorthTodaysDollars.style("display", "none"); tooltip.style("opacity", 0); })
                .on("mousemove", mousemove);

            const focusInvestment = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusInvestment.append("circle")
                .attr("r", 5)
                .attr("fill", "#2563eb");

            const focusNetWorth = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusNetWorth.append("circle")
                .attr("r", 5)
                .attr("fill", "#10b981");
            
            // NEW: Focus for Net Worth (Today's $)
            const focusNetWorthTodaysDollars = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusNetWorthTodaysDollars.append("circle")
                .attr("r", 5)
                .attr("fill", "#800080"); // Purple color

            function mousemove(event) {
                const x0 = xScale.invert(d3.pointer(event)[0]);
                const bisect = d3.bisector(d => d.age).left;
                const i = bisect(data, x0, 1);
                const d0 = data[i - 1];
                const d1 = data[i];
                const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

                focusInvestment.attr("transform", `translate(${xScale(d.age)},${yScale(d.investments)})`);
                focusNetWorth.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorth)})`);
                focusNetWorthTodaysDollars.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorthTodaysDollars)})`);

                tooltip.html(`Age: ${d.age}<br>Investments: ${formatTableCurrency(d.investments)}<br>Net Worth: ${formatTableCurrency(d.netWorth)}<br>Net Worth (Today's $): ${formatTableCurrency(d.netWorthTodaysDollars)}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            }
            chartContainer.__chartData__ = data; // Store data for resize handling
        }


        // Add event listeners to all static input fields
        for (const key in staticInputs) {
            // Ensure the element exists before adding event listeners
            if (staticInputs[key]) {
                // Slider inputs still trigger on 'input' to update their visual display value
                if (staticInputs[key].type === 'range') {
                    staticInputs[key].addEventListener('input', () => updateSliderValueDisplay(staticInputs[key], sliderPairs.find(p => p.slider === staticInputs[key]).valueDisplay, sliderPairs.find(p => p.slider === staticInputs[key]).unit));
                    staticInputs[key].addEventListener('change', () => calculateFinancials(true)); // Trigger save on 'change' (when slider is released)
                } else { // Text inputs
                    // Allow typing freely, no formatting on input
                    staticInputs[key].addEventListener('input', (event) => { /* no-op */ });
                    // Trigger formatting and calculation on blur
                    staticInputs[key].addEventListener('blur', (event) => {
                        event.target.value = formatInputNumber(event.target.value); // Format on blur
                        calculateFinancials(true); // Trigger save on blur
                    });
                }
            }
        }

        // Add event listener for adding new investment accounts
        addInvestmentBtn.addEventListener('click', () => { addInvestmentAccountInput(); calculateFinancials(true); });
        // NEW: Add event listener for adding new home accounts
        addHomeBtn.addEventListener('click', () => { addHomeInput(); calculateFinancials(true); });
        // NEW: Add event listener for adding new other static asset accounts
        addOtherStaticAssetBtn.addEventListener('click', () => { addOtherStaticAssetInput(); calculateFinancials(true); });
        // Add event listener for adding new liability accounts
        addLiabilityBtn.addEventListener('click', () => { addLiabilityInput(); calculateFinancials(true); });
        // Add event listener for adding new other income accounts
        addOtherIncomeBtn.addEventListener('click', () => { addOtherIncomeInput(); calculateFinancials(true); });

        // Attach event listeners for slider value display updates and trigger save
        sliderPairs.forEach(pair => {
            // Ensure the slider and display elements exist before attaching listeners
            if (pair.slider && pair.valueDisplay) {
                pair.slider.addEventListener('input', () => updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit));
                pair.slider.addEventListener('change', () => calculateFinancials(true)); // Change also triggers save
                // Initial display update handled by populateInputsFromFirestore
            }
        });

        // Function to handle sticky header on scroll for mobile
        function handleMobileStickyHeader() {
            const stickyElement = document.getElementById('dynamicRetirementDrawSticky');
            const leftStickyBanner = document.getElementById('leftStickyBanner');
            // Only apply on mobile (less than 1024px width, which is the 'lg' breakpoint in Tailwind)
            if (window.innerWidth < 1024 && stickyElement && leftStickyBanner) {
                // Get the bottom of the initial banner
                const bannerBottom = leftStickyBanner.offsetHeight;
                // If the user has scrolled past the banner, make it sticky
                if (window.scrollY > bannerBottom) {
                    stickyElement.classList.remove('hidden'); // Show the sticky element
                    stickyElement.classList.add('mobile-sticky-draw');
                } else {
                    stickyElement.classList.add('hidden'); // Hide the sticky element
                    stickyElement.classList.remove('mobile-sticky-draw');
                }
            } else if (stickyElement) {
                // Ensure it's not sticky and hidden on desktop
                stickyElement.classList.add('hidden');
                stickyElement.classList.remove('mobile-sticky-draw');
            }
        }


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Display the current application revision
            if (appRevisionDisplay) {
                appRevisionDisplay.textContent = `v${appRevision}`;
            }

            // Attempt Firebase initialization
            initFirebase().then(() => {
                // Firebase init successful and listener set up, data should be populated by onSnapshot
                // No need to manually add initial rows here if Firestore will handle it.
            }).catch(() => {
                // Firebase init failed or auth failed, explicitly add one blank row for each dynamic section
                // so the 'Add' buttons are functional for manual input.
                console.warn("Firebase initialization failed, initializing dynamic inputs with blank rows for local use.");
                investmentAccountsContainer.innerHTML = ''; // Clear existing
                homesContainer.innerHTML = ''; // Clear existing
                otherStaticAssetsContainer.innerHTML = ''; // Clear existing
                liabilitiesContainer.innerHTML = '';
                otherIncomeContainer.innerHTML = '';

                // If Firebase fails, use all defaults for dynamic sections
                defaultInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
                defaultHomes.forEach(home => addHomeInput(home));
                defaultOtherStaticAssets.forEach(asset => addOtherStaticAssetInput(asset));
                defaultLiabilities.forEach(liability => addLiabilityInput(liability));
                defaultOtherIncomes.forEach(income => addOtherIncomeInput(income));
                
                calculateFinancials(false); // Calculate based on initial blank inputs, don't save.
            });

            // Re-render charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                const projectedData = chartContainer.__chartData__;
                if (projectedData) {
                    renderChart(projectedData);
                }
                handleMobileStickyHeader(); // Adjust sticky header on resize
            });

            // Add scroll listener for sticky header on mobile
            window.addEventListener('scroll', handleMobileStickyHeader);
        });
    </script>
    <style>
        /* Custom styles for the Inter font and overall aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Dark slate gray for text */
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px; /* Track height */
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
            margin: 0;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; /* Standard thumb size */
            height: 20px; /* Standard thumb size */
            border-radius: 50%;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2; /* Ensure thumb is above track */
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; /* Standard thumb size */
            height: 20px; /* Standard thumb size */
            border-radius: 50%;
            background: #2563eb; /* Blue thumb */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2; /* Ensure thumb is above track */
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .rounded-lg {
            border-radius: 0.75rem;
        }
        /* Custom styling for inputs */
        .input-field {
            @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline;
        }
        .label-style {
            @apply block text-gray-700 text-sm font-bold mb-1; /* Reduced mb for labels */
        }
        /* Table row hover effect */
        tbody tr:hover {
            background-color: #e0f2fe; /* Light blue on hover */
        }

        /* Slider value display wrapper */
        .slider-input-wrapper {
            display: flex; /* Use flexbox for horizontal alignment */
            align-items: center; /* Vertically center center items */
            margin-bottom: 0.5rem; /* Space between slider groups */
            /* No fixed height needed as content flows horizontally */
            /* Removed padding-top as value is no longer above thumb */
        }

        /* Value display to the left of the slider */
        .slider-value-display {
            /* No longer absolute positioning */
            position: static;
            width: 60px; /* Fixed width to accommodate values like "88.8%" */
            text-align: right; /* Align text to the right */
            margin-right: 8px; /* Space between value and slider */
            color: #334155; /* Text color to match body */
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0; /* Prevent it from shrinking */
        }
        /* Make the slider take up remaining space */
        .slider-input-wrapper input[type="range"] {
            flex-grow: 1;
            width: auto; /* Override w-full from Tailwind */
            margin: 0; /* Reset margins */
        }


        /* D3 Chart Specific Styles */
        .chart-svg {
            display: block;
            margin: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .line {
            fill: none;
            stroke-width: 3px;
        }
        .line-investments {
            stroke: #2563eb; /* Blue for investments */
        }
        .line-networth {
            stroke: #10b981; /* Green for net worth */
        }
        .line-networth-todays-dollars {
            stroke: #800080; /* Purple for Net Worth (Today's $) */
        }
        .axis text {
            font-size: 0.8rem;
            fill: #6b7280; /* Gray text for axes */
        }
        .axis path, .axis line {
            stroke: #d1d5db; /* Light gray for axis lines */
            stroke-width: 1px;
        }
        .grid line {
            stroke: #e5e7eb; /* Even lighter gray for grid lines */
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            color: #333;
        }

        /* Responsive adjustments for the sticky banner and main content */
        @media (max-width: 1023px) { /* Adjust for screens smaller than 'lg' breakpoint (1024px) */
            #leftStickyBanner {
                width: 100%;
                height: auto;
                position: relative; /* Not sticky on mobile */
                top: auto;
                left: auto;
                flex-direction: row; /* Horizontal layout for mobile */
                flex-wrap: wrap; /* Allow items to wrap */
                justify-content: center; /* Center items horizontally */
                align-items: flex-start; /* Align items to the top */
                padding: 1rem; /* Smaller padding for mobile */
                box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Add shadow to top banner */
            }
            #leftStickyBanner h2 {
                font-size: 1.5rem; /* Smaller title on mobile */
                margin-bottom: 0.5rem;
                width: 100%; /* Take full width for title */
            }
            #leftStickyBanner .summary-item {
                flex: 1 1 auto; /* Allow items to grow and shrink, wrap as needed */
                min-width: 100px; /* Minimum width for each item to prevent too much squishing */
                margin-bottom: 0.5rem;
                padding: 0 0.5rem; /* Add horizontal padding to items */
            }
            #leftStickyBanner .summary-item p {
                font-size: 0.8rem; /* Smaller text for mobile */
            }
            #leftStickyBanner .summary-item p:last-child {
                font-size: 1.1rem; /* Smaller value for mobile */
            }
            /* main-content-wrapper no longer needs specific margin-top on mobile */
            .flex-1.p-4.md\:p-8.lg\:ml-64 {
                margin-top: 0;
            }

            /* Mobile-only sticky dynamic retirement draw */
            .mobile-sticky-draw {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: #1e3a8a; /* Darker blue for sticky header */
                color: white;
                text-align: center;
                padding: 0.5rem 0;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
        }
        /* Make the main container full width on mobile */
        .container.mx-auto {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* For lg and up (desktop) */
        @media (min-width: 1024px) {
            #leftStickyBanner {
                width: 16rem; /* Tailwind's w-64 */
                height: 100vh; /* Full viewport height */
                position: fixed; /* Sticky on desktop */
                top: 0;
                left: 0;
                flex-direction: column; /* Vertical layout for desktop */
                justify-content: flex-start; /* Align items to the top */
                align-items: center;
                padding: 1.5rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Original shadow */
            }
            #leftStickyBanner h2 {
                font-size: 1.875rem; /* Tailwind text-3xl */
                margin-bottom: 2rem; /* Tailwind mb-8 */
                width: auto;
            }
            #leftStickyBanner .summary-item {
                flex: none; /* Don't allow items to grow/shrink based on space */
                width: auto; /* Take natural width */
                margin-bottom: 1rem; /* Tailwind mb-4 */
                padding: 0;
            }
            #leftStickyBanner .summary-item p {
                font-size: 1.125rem; /* Tailwind text-xl */
            }
            #leftStickyBanner .summary-item p:last-child {
                font-size: 1.875rem; /* Tailwind text-3xl */
            }
            .flex-1.p-4.md\:p-8.lg\:ml-64 { /* Corrected class for main content wrapper */
                margin-left: 16rem; /* Tailwind's ml-64 */
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="leftStickyBanner" class="
        relative w-full h-auto bg-blue-800 text-white p-4 shadow-xl flex flex-row flex-wrap justify-center items-start z-50
        lg:fixed lg:top-0 lg:left-0 lg:h-screen lg:w-64 lg:flex-col lg:items-center lg:justify-start lg:p-6 lg:shadow-2xl lg:overflow-y-auto
    ">
        <h2 class="text-xl font-extrabold mb-4 text-center text-white w-full lg:text-3xl lg:mb-8">Your Snapshot</h2>
        <span id="appRevisionDisplay" class="text-xs text-blue-200 font-semibold mb-4 lg:mb-6">v1.31</span>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Worth:</p>
            <p id="currentNetWorth" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Net Investments:</p>
            <p id="currentNetInvestments" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Income:</p>
            <p id="annualIncomeDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Annual Savings:</p>
            <p id="annualSavingsDisplay" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg">Today's Draw:</p>
            <p id="todaysDraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg" id="dynamicRetirementDrawLabel">Retirement Draw (Today's $):</p>
            <p id="dynamicRetirementDrawValue" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
        <div class="text-center mb-2 summary-item w-1/2 sm:w-1/3 md:w-1/4 lg:w-auto lg:text-center px-1">
            <p class="text-sm font-bold text-blue-200 lg:text-lg" id="ssStartAgeDrawLabel">62 YO Draw (Today's $):</p>
            <p id="ssStartAgeDraw" class="text-xl font-semibold text-white mt-1 lg:text-3xl">$0</p>
        </div>
    </div>

    <div id="dynamicRetirementDrawSticky" class="hidden text-center mb-2 w-full bg-blue-800 text-white p-2">
        <p class="text-sm font-bold text-blue-200" id="dynamicRetirementDrawLabelSticky">Retirement Draw (Today's $):</p>
        <p id="dynamicRetirementDrawValueSticky" class="text-xl font-semibold text-white">$0</p>
    </div>

    <div class="flex-1 p-4 md:p-8 lg:ml-64">
        <div class="w-full bg-white rounded-lg shadow-xl p-4 md:p-8">
            <h1 class="text-4xl font-extrabold mb-4 text-center text-blue-800">Retirement Plan Calculator</h1>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <details open>
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        1. Assets, Investments, and Liabilities
                    </summary>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div>
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">Investments <span class="font-bold text-green-600" id="totalInvestmentsSummary"></span></h3>
                                <div id="investmentAccountsContainer" class="mb-4 space-y-4">
                                    </div>
                                <button id="addInvestmentBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                    + Add Investment Account
                                </button>
                            </div>

                            <div class="mt-8">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">Homes <span class="font-bold text-green-600" id="totalHomesSummary"></span></h3>
                                <div id="homesContainer" class="mb-4 space-y-4">
                                    </div>
                                <button id="addHomeBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                    + Add Home
                                </button>
                            </div>
                        </div>

                        <div>
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">Other Assets <span class="font-bold text-green-600" id="totalOtherStaticAssetsSummary"></span></h3>
                                <div id="otherStaticAssetsContainer" class="mb-4 space-y-4">
                                    </div>
                                <button id="addOtherStaticAssetBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                    + Add Other Asset
                                </button>
                            </div>

                            <div class="mt-8">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">Liabilities <span class="font-bold text-red-600" id="totalLiabilitiesSummary"></span></h3>
                                <div id="liabilitiesContainer" class="mb-4 space-y-4">
                                    </div>
                                <button id="addLiabilityBtn" type="button" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                    + Add Liability
                                </button>
                            </div>
                        </div>
                    </div>
                </details>

                <details open class="mt-8">
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        2. Income, Savings, and Assumptions
                    </summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Income & Contribution Assumptions</h3>
                            <div class="mb-2"> <label for="currentAge" class="label-style">Current Age</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="currentAgeValue"></span>
                                    <input type="range" id="currentAge" min="18" max="100" value="38" step="1" class="w-full">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="baseSalary" class="label-style">Base Salary ($)</label>
                                <input type="text" id="baseSalary" value="179386" class="input-field">
                            </div>

                            <div class="mb-2">
                                <label for="bonusRate" class="label-style">Bonus Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="bonusRateValue"></span>
                                    <input type="range" id="bonusRate" min="0" max="50" value="23" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="my401kContributionRate" class="label-style">My 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="my401kContributionRateValue"></span>
                                    <input type="range" id="my401kContributionRate" min="0" max="20" value="6" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="company401kContributionRate" class="label-style">Company 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="company401kContributionRateValue"></span>
                                    <input type="range" id="company401kContributionRate" min="0" max="20" value="10" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthlyHSAContribution" class="label-style">Monthly HSA Contribution ($)</label>
                                <input type="text" id="monthlyHSAContribution" value="600" class="input-field">
                            </div>

                            <div class="mb-4">
                                <label for="annualRothContribution" class="label-style">Other Annual Savings Contribution ($)</label>
                                <input type="text" id="annualRothContribution" value="0" class="input-field">
                            </div>
                            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Other Income (Continues Post-Retirement)</h3>
                            <div class="flex items-center text-sm font-semibold mb-2 ml-2">
                                <div class="flex-1 min-w-[120px]">Income Description</div>
                                <div class="flex-1 min-w-[100px]">Monthly Amount</div>
                                <div class="w-24 ml-1">Annual Escalation</div>
                                <div class="w-6"></div> </div>
                            <div id="otherIncomeContainer" class="mb-4 space-y-4">
                                </div>
                            <button id="addOtherIncomeBtn" type="button" class="mt-4 bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Income
                            </button>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Growth & Expense Assumptions</h3>
                            <div class="mb-2">
                                <label for="annualSalaryRaise" class="label-style">Annual Salary Raise (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="annualSalaryRaiseValue"></span>
                                    <input type="range" id="annualSalaryRaise" min="0" max="10" value="4" step="0.1" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="stockAppreciation" class="label-style">Stock Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="stockAppreciationValue"></span>
                                    <input type="range" id="stockAppreciation" min="0" max="15" value="9" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="housingAppreciation" class="label-style">Housing Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="housingAppreciationValue"></span>
                                    <input type="range" id="housingAppreciation" min="0" max="10" value="4" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="inflation" class="label-style">Inflation (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="inflationValue"></span>
                                    <input type="range" id="inflation" min="0" max="10" value="3" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="retirementDrawRatePre62" class="label-style">Pre-62 YO Draw (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="retirementDrawRatePre62Value"></span>
                                    <input type="range" id="retirementDrawRatePre62" min="0" max="10" value="6" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="retirementDrawRatePost62" class="label-style">Post-62 YO Draw (%)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="retirementDrawRatePost62Value"></span>
                                    <input type="range" id="retirementDrawRatePost62" min="0" max="5" value="5" step="0.5" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="socialSecurityStartAge" class="label-style">Social Security Start Age</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="socialSecurityStartAgeValue"></span>
                                    <input type="range" id="socialSecurityStartAge" min="62" max="70" value="62" step="1" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="socialSecurityMonthly" class="label-style" id="socialSecurityMonthlyLabel">Social Security at 62 ($)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="socialSecurityMonthlyValue"></span>
                                    <input type="range" id="socialSecurityMonthly" min="0" max="5000" value="2800" step="100" class="w-full">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="retirementYear" class="label-style">Retirement Year (Age)</label>
                                <div class="slider-input-wrapper">
                                    <span class="slider-value-display" id="retirementYearValue"></span>
                                    <input type="range" id="retirementYear" min="38" max="80" value="55" step="1" class="w-full">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthlyPrincipalPayment" class="label-style">Monthly Principal Payment ($)</label>
                                <input type="text" id="monthlyPrincipalPayment" value="1428" class="input-field">
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">3. Projected Growth Chart</h2>
                <div id="chart-container" class="w-full overflow-x-auto">
                    </div>
                <div class="flex justify-center mt-4 space-x-6 text-gray-700 font-semibold">
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #2563eb;"></span>
                        Net Investments
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #10b981;"></span>
                        Net Worth
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #800080;"></span>
                        Net Worth (Today's $)
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">4. Projected Growth Table</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-blue-600 text-white uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Age</th>
                                <th class="py-3 px-6 text-left">Year</th>
                                <th class="py-3 px-6 text-left">Investments</th>
                                <th class="py-3 px-6 text-left">Net Worth</th>
                                <th class="py-3 px-6 text-left">Net Worth (Today's $)</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTableBody" class="text-gray-700 text-sm font-light divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
