<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your actual web app's Firebase configuration (obtained from Firebase Console)
    const firebaseConfig = {
        apiKey: "AIzaSyCC1UKUPFRUnWyQ09hGFkJxVEVBBkZ7X40",
        authDomain: "investment-calculator-931f2.firebaseapp.com",
        databaseURL: "https://investment-calculator-931f2-default-rtdb.firebaseio.com",
        projectId: "investment-calculator-931f2",
        storageBucket: "investment-calculator-931f2.firebasestorage.app",
        messagingSenderId: "943895110805",
        appId: "1:943895110805:web:ba6e1e6177ae31d7af279c",
        measurementId: "G-F0CRPKLS7G"
    };

    // Use the actual appId from your firebaseConfig when hosting on GitHub Pages
    const appId = firebaseConfig.appId;
    // initialAuthToken is only provided in Canvas, so it will be null here, leading to anonymous sign-in
    const initialAuthToken = null;


    // Global Firebase vars
    let app;
    let db;
    let auth;
    let userId; // Will store the authenticated user ID

    // Firestore Paths - Using a public collection for shared data
    // The appId ensures that data is scoped to this specific application instance
    const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/retirement_calculator`;
    const SHARED_DOC_ID = 'shared_inputs'; // A single document for all shared inputs

    // Revision Level
    const appRevision = "1.39"; // Fixed ReferenceError: initFirebase is not defined by calling it directly within the module scope.

    // Predefined default values for dynamic sections
    const defaultInvestmentAccounts = [
        { name: "401K", value: 527030 },
        { name: "Roth 1", value: 178181 },
        { name: "Roth 2", value: 157347 },
        { name: "529", value: 55836 },
        { name: "HSA", value: 25340 },
        { name: "Gold", value: 6600 }
    ];

    const defaultHomes = [
        { name: "Personal Home", value: 599000 },
        { name: "Rental Home", value: 199000 },
        { name: "Lake Home", value: 181000 }
    ];

    const defaultOtherStaticAssets = [
        { name: "Suburban", value: 32000 },
        { name: "Tractor", value: 16000 },
        { name: "RV", value: 25000 },
        { name: "Checking", value: 17522 }
    ];

    const defaultLiabilities = [
        { name: "Home Mortgage", value: 202212 },
        { name: "Credit Cards", value: 0 }
    ];

    const defaultOtherIncomes = []; // Initializing as empty, will add dynamically if needed

    // Uniform Lifetime Table (Simplified for ages relevant to 72(t) starting points)
    // Source: IRS Publication 590-B, Appendix B, Table III (Uniform Lifetime Table) for 2023
    // Note: This table is subject to change by the IRS. For official calculations, always refer to the latest IRS publications.
    const uniformLifetimeTable = {
        1: 61.1, 2: 60.1, 3: 59.1, 4: 58.1, 5: 57.1, 6: 56.1, 7: 55.1, 8: 54.1, 9: 53.1, 10: 52.2,
        11: 51.2, 12: 50.2, 13: 49.2, 14: 48.3, 15: 47.3, 16: 46.4, 17: 45.4, 18: 44.5, 19: 43.5, 20: 42.6,
        21: 41.7, 22: 40.7, 23: 39.8, 24: 38.9, 25: 38.0, 26: 37.1, 27: 36.2, 28: 35.3, 29: 34.4, 30: 33.5,
        31: 32.6, 32: 31.7, 33: 30.8, 34: 29.9, 35: 29.1, 36: 28.2, 37: 27.4, 38: 26.5, 39: 25.6, 40: 24.7,
        41: 23.8, 42: 22.9, 43: 22.0, 44: 21.2, 45: 20.3, 46: 19.5, 47: 18.7, 48: 17.9, 49: 17.1, 50: 16.3,
        51: 15.5, 52: 14.8, 53: 14.0, 54: 13.3, 55: 12.6, 56: 11.9, 57: 11.2, 58: 10.5, 59: 9.9, 60: 9.3,
        61: 8.7, 62: 8.2, 63: 7.7, 64: 7.2, 65: 6.7, 66: 6.3, 67: 5.9, 68: 5.5, 69: 5.1, 70: 4.7,
        71: 4.4, 72: 4.1, 73: 3.8, 74: 3.6, 75: 3.3, 76: 3.1, 77: 2.9, 78: 2.7, 79: 2.5, 80: 2.4,
        81: 2.2, 82: 2.1, 83: 1.9, 84: 1.8, 85: 1.7, 86: 1.6, 87: 1.5, 88: 1.4, 89: 1.3, 90: 1.2,
        91: 1.1, 92: 1.1, 93: 1.0, 94: 1.0, 95: 0.9, 96: 0.9, 97: 0.8, 98: 0.8, 99: 0.7, 100: 0.7,
        101: 0.6, 102: 0.6, 103: 0.5, 104: 0.5, 105: 0.5, 106: 0.4, 107: 0.4, 108: 0.4, 109: 0.3, 110: 0.3,
        111: 0.3, 112: 0.2, 113: 0.2, 114: 0.2, 115: 0.2, 116: 0.1, 117: 0.1, 118: 0.1, 119: 0.1, 120: 0.1
    };


    // Flag to prevent saving when data is being loaded from Firestore
    window.isLoadingFromFirestore = false;

    // Get references to all static input elements (declared once globally)
    const staticInputs = {
        currentAge: document.getElementById('currentAge'),
        baseSalary: document.getElementById('baseSalary'),
        bonusRate: document.getElementById('bonusRate'),
        my401kContributionRate: document.getElementById('my401kContributionRate'),
        company401kContributionRate: document.getElementById('company401kContributionRate'),
        annualRothContribution: document.getElementById('annualRothContribution'),
        monthlyHSAContribution: document.getElementById('monthlyHSAContribution'),
        annualSalaryRaise: document.getElementById('annualSalaryRaise'),
        stockAppreciation: document.getElementById('stockAppreciation'),
        housingAppreciation: document.getElementById('housingAppreciation'),
        inflation: document.getElementById('inflation'),
        retirementDrawRatePre62: document.getElementById('retirementDrawRatePre62'),
        retirementDrawRatePost62: document.getElementById('retirementDrawRatePost62'),
        retirementYear: document.getElementById('retirementYear'),
        monthlyPrincipalPayment: document.getElementById('monthlyPrincipalPayment'),
        socialSecurityStartAge: document.getElementById('socialSecurityStartAge'),
        socialSecurityMonthly: document.getElementById('socialSecurityMonthly'),
        // New 72(t) inputs
        seventyTwoTAccountBalance: document.getElementById('seventyTwoTAccountBalance'),
        seventyTwoTStartAge: document.getElementById('seventyTwoTStartAge'),
        seventyTwoTInterestRate: document.getElementById('seventyTwoTInterestRate')
    };

    // Get references to display elements (declared once globally)
    const currentNetWorthDisplay = document.getElementById('currentNetWorth');
    const currentNetInvestmentsDisplay = document.getElementById('currentNetInvestments');
    const annualIncomeDisplay = document.getElementById('annualIncomeDisplay');
    const annualSavingsDisplay = document.getElementById('annualSavingsDisplay');
    const todaysDrawDisplay = document.getElementById('todaysDraw');
    const dynamicRetirementDrawLabel = document.getElementById('dynamicRetirementDrawLabel');
    const dynamicRetirementDrawValue = document.getElementById('dynamicRetirementDrawValue');
    const ssStartAgeDrawDisplay = document.getElementById('ssStartAgeDraw');
    const dynamicRetirementDrawLabelSticky = document.getElementById('dynamicRetirementDrawLabelSticky');
    const dynamicRetirementDrawValueSticky = document.getElementById('dynamicRetirementDrawValueSticky');
    const projectionTableBody = document.getElementById('projectionTableBody');
    const investmentAccountsContainer = document.getElementById('investmentAccountsContainer');
    const addInvestmentBtn = document.getElementById('addInvestmentBtn');
    const homesContainer = document.getElementById('homesContainer');
    const addHomeBtn = document.getElementById('addHomeBtn');
    const otherStaticAssetsContainer = document.getElementById('otherStaticAssetsContainer');
    const addOtherStaticAssetBtn = document.getElementById('addOtherStaticAssetBtn');
    const liabilitiesContainer = document.getElementById('liabilitiesContainer');
    const addLiabilityBtn = document.getElementById('addLiabilityBtn');
    const otherIncomeContainer = document.getElementById('otherIncomeContainer');
    const addOtherIncomeBtn = document.getElementById('addOtherIncomeBtn');
    const chartContainer = document.getElementById('chart-container');
    const appRevisionDisplay = document.getElementById('appRevisionDisplay');

    // References for the summary spans (declared once globally)
    const totalInvestmentsSummary = document.getElementById('totalInvestmentsSummary');
    const totalHomesSummary = document.getElementById('totalHomesSummary');
    const totalOtherStaticAssetsSummary = document.getElementById('totalOtherStaticAssetsSummary');
    const totalLiabilitiesSummary = document.getElementById('totalLiabilitiesSummary');

    // New references for labels (declared once globally)
    const socialSecurityMonthlyLabel = document.getElementById('socialSecurityMonthlyLabel');
    const ssStartAgeDrawLabel = document.getElementById('ssStartAgeDrawLabel');

    // 72(t) Result Displays (declared once globally)
    const rmdAnnualDisplay = document.getElementById('rmdAnnual');
    const rmdMonthlyDisplay = document.getElementById('rmdMonthly');
    const amortizationAnnualDisplay = document.getElementById('amortizationAnnual');
    const amortizationMonthlyDisplay = document.getElementById('amortizationMonthly');
    const annuitizationAnnualDisplay = document.getElementById('annuitizationAnnual');
    const annuitizationMonthlyDisplay = document.getElementById('annuitizationMonthly');
    const lifeExpectancyUsedDisplay = document.getElementById('lifeExpectancyUsed');
    const seventyTwoTProjectionTableBody = document.getElementById('seventyTwoTProjectionTableBody');
    const seventyTwoTChartContainer = document.getElementById('seventyTwoTChartContainer');


    // Get references to slider input and value display pairs (declared once globally)
    const sliderPairs = [
        { slider: staticInputs.currentAge, valueDisplay: document.getElementById('currentAgeValue'), unit: '' },
        { slider: staticInputs.bonusRate, valueDisplay: document.getElementById('bonusRateValue'), unit: '%' },
        { slider: staticInputs.my401kContributionRate, valueDisplay: document.getElementById('my401kContributionRateValue'), unit: '%' },
        { slider: staticInputs.company401kContributionRate, valueDisplay: document.getElementById('company401kContributionRateValue'), unit: '%' },
        { slider: staticInputs.annualSalaryRaise, valueDisplay: document.getElementById('annualSalaryRaiseValue'), unit: '%' },
        { slider: staticInputs.stockAppreciation, valueDisplay: document.getElementById('stockAppreciationValue'), unit: '%' },
        { slider: staticInputs.housingAppreciation, valueDisplay: document.getElementById('housingAppreciationValue'), unit: '%' },
        { slider: staticInputs.inflation, valueDisplay: document.getElementById('inflationValue'), unit: '%' },
        { slider: staticInputs.retirementDrawRatePre62, valueDisplay: document.getElementById('retirementDrawRatePre62Value'), unit: '%' },
        { slider: staticInputs.retirementDrawRatePost62, valueDisplay: document.getElementById('retirementDrawRatePost62Value'), unit: '%' },
        { slider: staticInputs.retirementYear, valueDisplay: document.getElementById('retirementYearValue'), unit: '' },
        { slider: staticInputs.socialSecurityStartAge, valueDisplay: document.getElementById('socialSecurityStartAgeValue'), unit: '' },
        { slider: staticInputs.socialSecurityMonthly, valueDisplay: document.getElementById('socialSecurityMonthlyValue'), unit: '' },
        // New 72(t) slider pairs
        { slider: staticInputs.seventyTwoTStartAge, valueDisplay: document.getElementById('seventyTwoTStartAgeValue'), unit: '' },
        { slider: staticInputs.seventyTwoTInterestRate, valueDisplay: document.getElementById('seventyTwoTInterestRateValue'), unit: '%' }
    ];


    // Helper functions for number formatting in input fields
    function formatInputNumber(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        // Ensure value is treated as a number before formatting, removing existing commas
        let num = Number(String(value).replace(/,/g, ''));
        if (isNaN(num)) {
            return '';
        }
        return new Intl.NumberFormat('en-US').format(num);
    }

    function cleanInputNumber(stringValue) {
        if (stringValue === null || stringValue === undefined || stringValue === '') {
            return 0;
        }
        // Remove all non-digit characters except for a potential leading minus sign and decimal
        const cleaned = stringValue.replace(/[^\d.-]/g, '');
        return parseFloat(cleaned) || 0;
    }

    // Function to format numbers as currency, rounded to nearest thousand, without K/M (for table)
    const formatTableCurrency = (amount) => {
        const roundedAmount = Math.round(amount / 1000) * 1000;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(roundedAmount);
    };

    // Function to format numbers as currency with K/M and specified decimal places (for summary displays)
    const formatLargeCurrency = (amount) => {
        if (Math.abs(amount) >= 1000000) {
            return `$${(amount / 1000000).toFixed(2)}M`;
        }
        if (Math.abs(amount) >= 1000) {
            return `$${(amount / 1000).toFixed(0)}K`;
        }
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    };

    // Function to format Y-axis labels dynamically based on max value in the chart
    function formatProjectedChartAxisLabel(value, maxChartValue) {
        if (maxChartValue < 5000000) { // If max value is under 5 million, show in thousands
            return `$${(value / 1000).toFixed(0)}K`; // No decimals for K
        } else { // Otherwise, show in millions
            return `$${(value / 1000000).toFixed(0)}M`; // No decimals for M
        }
    }

    // Function to update slider value display
    function updateSliderValueDisplay(slider, valueDisplay, unit) {
        const val = parseFloat(slider.value);
        valueDisplay.textContent = `${val.toFixed(slider.step === '0.1' || slider.step === '0.5' ? 1 : 0)}${unit}`;
    }

    // Helper function to format percentage for APY display
    function formatPercentageAPY(rate) {
        const percentage = rate * 100;
        // Show one decimal place if there is a fractional part (e.g., 9.5%), otherwise show as whole number (e.g., 10%)
        if (percentage % 1 !== 0) {
            return percentage.toFixed(1);
        } else {
            return percentage.toFixed(0);
        }
    }

    /**
     * Projects the balance of a specific 401K account to a target age.
     * For 72(t) calculations, this function is called with zero contributions
     * to reflect only the growth of the existing balance.
     */
    function project401kBalanceToAge(startAge, targetAge, initial401kBalance, baseSalary, my401kRate, company401kRate, annualSalaryRaise, stockAppreciation) {
        let current401k = initial401kBalance;
        let currentSalary = baseSalary; // This will be used for future contribution calculations

        for (let age = startAge; age < targetAge; age++) {
            const myContribution = currentSalary * my401kRate;
            const companyContribution = currentSalary * company401kRate;
            current401k += myContribution + companyContribution; // Add contributions (will be 0 if rates/salary are 0)
            current401k *= (1 + stockAppreciation); // Apply growth after contributions
            currentSalary *= (1 + annualSalaryRaise); // Increase salary (will not increase if annualSalaryRaise is 0)
        }
        return current401k;
    }

    // Function to calculate 72(t) distributions
    function calculate72tDistributions(accountBalance, age, interestRate) {
        const lifeExpectancy = uniformLifetimeTable[age];
        if (!lifeExpectancy) {
            console.error(`Life expectancy not found for age ${age}.`);
            lifeExpectancyUsedDisplay.textContent = `N/A (Age ${age} not in table)`;
            return { rmdAnnual: 0, rmdMonthly: 0, amortizationAnnual: 0, amortizationMonthly: 0, annuitizationAnnual: 0, annuitizationMonthly: 0 };
        }

        lifeExpectancyUsedDisplay.textContent = `${lifeExpectancy} years`;

        // 1. Required Minimum Distribution (RMD) Method
        const rmdAnnual = accountBalance / lifeExpectancy;
        const rmdMonthly = rmdAnnual / 12;

        // 2. Fixed Amortization Method
        // IRS defines max interest rate as 120% of the federal mid-term rate or 5%, whichever is greater.
        // For this calculator, we'll use the user-defined interestRate, assuming it's within IRS limits.
        const monthlyInterestRate = interestRate / 12;
        const numberOfMonths = lifeExpectancy * 12;
        let amortizationMonthly = 0;
        if (monthlyInterestRate > 0) {
            amortizationMonthly = accountBalance * (monthlyInterestRate / (1 - Math.pow(1 + monthlyInterestRate, -numberOfMonths)));
        } else { // Handle 0 interest rate for fixed amortization
            amortizationMonthly = accountBalance / numberOfMonths;
        }
        const amortizationAnnual = amortizationMonthly * 12;

        // 3. Fixed Annuitization Method
        // This is a complex actuarial calculation based on IRS tables.
        // A common approximation uses the annual interest rate and life expectancy.
        // Using a simple annuity formula: PMT = PV * [ i / (1 - (1 + i)^-n) ]
        // Where i = annual interest rate, n = life expectancy.
        // Note: This is an approximation and might not match official IRS annuity factors precisely.
        let annuitizationAnnual = 0;
        if (interestRate > 0) {
            annuitizationAnnual = accountBalance * (interestRate / (1 - Math.pow(1 + interestRate, -lifeExpectancy)));
        } else { // Handle 0 interest rate for fixed annuitization
            annuitizationAnnual = accountBalance / lifeExpectancy;
        }
        const annuitizationMonthly = annuitizationAnnual / 12;

        return { rmdAnnual, rmdMonthly, amortizationAnnual, amortizationMonthly, annuitizationAnnual, annuitizationMonthly };
    }

    /**
     * Projects the 72(t) account value over time, deducting distributions.
     * The account grows at the main stock appreciation rate.
     * @param {number} startAge The age at which 72(t) distributions begin.
     * @param {number} initialBalance The starting balance of the 72(t) account.
     * @param {number} growthRate The annual growth rate of the account (from main stockAppreciation).
     * @param {number} annualDistribution The fixed annual distribution amount (e.g., from Amortization method).
     */
    function project72tAccountGrowth(startAge, initialBalance, growthRate, annualDistribution) {
        seventyTwoTProjectionTableBody.innerHTML = '';
        seventyTwoTChartContainer.innerHTML = ''; // Clear previous chart

        let currentAccountValue = initialBalance;
        const chartData = [];
        const currentAge = staticInputs.currentAge.value; // Get current age from UI
        const startYear = new Date().getFullYear() + (startAge - currentAge); // Calculate start year for 72t projection

        // Add initial point for chart and table
        chartData.push({
            age: startAge,
            accountValue: initialBalance,
            annualDistribution: annualDistribution
        });

        // The 72(t) distributions must continue for 5 years OR until age 59 1/2, whichever is longer.
        // For simplicity in projection, we'll project until account runs out or age 90.
        const projectionEndAge = 90; // Project further to show long-term impact

        for (let age = startAge + 1; age <= projectionEndAge; age++) {
            currentAccountValue *= (1 + growthRate); // Apply growth using stockAppreciation
            currentAccountValue -= annualDistribution; // Deduct distribution

            currentAccountValue = Math.max(0, currentAccountValue); // Account cannot go below zero

            chartData.push({
                age: age,
                accountValue: currentAccountValue,
                annualDistribution: annualDistribution // Distribution remains fixed
            });

            const row = seventyTwoTProjectionTableBody.insertRow();
            row.classList.add('hover:bg-blue-50');
            if (age % 5 === 0) {
                row.classList.add('bg-blue-100');
            }
            row.insertCell().textContent = age;
            row.insertCell().textContent = startYear + (age - startAge);
            row.insertCell().textContent = formatTableCurrency(currentAccountValue);
            row.insertCell().textContent = formatTableCurrency(annualDistribution);

            // Stop projection if account runs out
            if (currentAccountValue <= 0 && annualDistribution > 0) {
                break;
            }
        }
        render72tChart(chartData);
    }

    // D3.js Chart Rendering Function for 72(t) Projection
    function render72tChart(data) {
        d3.select(seventyTwoTChartContainer).select("svg").remove();

        if (!data || data.length === 0) {
            // Display a message if no data to chart
            seventyTwoTChartContainer.innerHTML = '<p class="text-center text-gray-500">No data available for 72(t) projection chart.</p>';
            return;
        }

        const parentWidth = seventyTwoTChartContainer.offsetWidth;
        const margin = { top: 40, right: 60, bottom: 50, left: 80 };
        const width = parentWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select(seventyTwoTChartContainer).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "chart-svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.age))
            .range([0, width]);

        // Left Y-axis scale for Account Value
        const yMaxAccount = d3.max(data, d => d.accountValue);
        const yMinAccount = d3.min(data, d => d.accountValue);
        const yScaleLeft = d3.scaleLinear()
            .domain([yMinAccount * 0.95, yMaxAccount * 1.05])
            .range([height, 0]);

        // Right Y-axis scale for Annual Distribution
        const yMaxDistribution = d3.max(data, d => d.annualDistribution);
        const yMinDistribution = d3.min(data, d => d.annualDistribution);
        // Ensure the domain for the right axis is reasonable even if distribution is zero
        const effectiveYMinDistribution = yMinDistribution > 0 ? yMinDistribution * 0.95 : 0;
        const effectiveYMaxDistribution = yMaxDistribution > 0 ? yMaxDistribution * 1.05 : (effectiveYMinDistribution > 0 ? effectiveYMinDistribution * 2 : 10000); // Default to a small range if all zero
        const yScaleRight = d3.scaleLinear()
            .domain([effectiveYMinDistribution, effectiveYMaxDistribution])
            .range([height, 0]);

        const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
        const yAxisLeft = d3.axisLeft(yScaleLeft).tickFormat(d => formatProjectedChartAxisLabel(d, yMaxAccount));
        const yAxisRight = d3.axisRight(yScaleRight).tickFormat(d => formatProjectedChartAxisLabel(d, yMaxDistribution));

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis-left")
            .call(yAxisLeft);
        
        svg.append("g")
            .attr("class", "y axis-right")
            .attr("transform", `translate(${width}, 0)`)
            .call(yAxisRight);

        svg.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScaleLeft) // Grid lines based on left axis
                .tickSize(-width)
                .tickFormat("")
            );

        const lineAccountValue = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScaleLeft(d.accountValue)); // Use yScaleLeft

        const lineAnnualDistribution = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScaleRight(d.annualDistribution)); // Use yScaleRight
        

        svg.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", "#2563eb") // Blue for account value
            .attr("stroke-width", 3)
            .attr("d", lineAccountValue);

        svg.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", "#f97316") // Orange for annual distribution
            .attr("stroke-width", 3)
            .attr("d", lineAnnualDistribution);

        svg.append("text")
            .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Age");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 20)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Account Value ($)"); // Specific label for left axis

        svg.append("text")
            .attr("transform", "rotate(90)")
            .attr("y", width + margin.right - 20)
            .attr("x", height / 2)
            .attr("dy", "-1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Annual Distribution ($)"); // Specific label for right axis

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .attr("font-size", "1.2rem")
            .attr("font-weight", "bold")
            .text("72(t) Account Projection");

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute");

        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mouseover", function() { focusAccountValue.style("display", null); focusAnnualDistribution.style("display", null); tooltip.style("opacity", 1); })
            .on("mouseout", function() { focusAccountValue.style("display", "none"); focusAnnualDistribution.style("display", "none"); tooltip.style("opacity", 0); })
            .on("mousemove", mousemove72t);

        const focusAccountValue = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusAccountValue.append("circle")
            .attr("r", 5)
            .attr("fill", "#2563eb");

        const focusAnnualDistribution = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusAnnualDistribution.append("circle")
            .attr("r", 5)
            .attr("fill", "#f97316");

        function mousemove72t(event) {
            const x0 = xScale.invert(d3.pointer(event)[0]);
            const bisect = d3.bisector(d => d.age).left;
            const i = bisect(data, x0, 1);
            const d0 = data[i - 1];
            const d1 = data[i];
            const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

            focusAccountValue.attr("transform", `translate(${xScale(d.age)},${yScaleLeft(d.accountValue)})`); // Use yScaleLeft
            focusAnnualDistribution.attr("transform", `translate(${xScale(d.age)},${yScaleRight(d.annualDistribution)})`); // Use yScaleRight

            tooltip.html(`Age: ${d.age}<br>Account Value: ${formatTableCurrency(d.accountValue)}<br>Annual Distribution: ${formatTableCurrency(d.annualDistribution)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
        }
        seventyTwoTChartContainer.__chartData__ = data; // Store data for resize handling
    }

    // Main calculation function (now accepts a shouldSave flag)
    function calculateFinancials(shouldSaveData = true) {
        let totalInvestments = 0;
        let totalHomes = 0; // New variable for total homes value
        let totalOtherStaticAssets = 0; // New variable for total static assets
        let totalLiabilities = 0;
        let currentMortgageValue = 0; // Specific mortgage value for reduction logic

        let currentFinancials = {}; // Object to store all inputs for saving

        // Collect static input values
        for (const key in staticInputs) {
            // Check if the element exists before trying to access its value
            if (staticInputs[key]) {
                let value;
                if (staticInputs[key].type === 'range') {
                    value = parseFloat(staticInputs[key].value);
                } else { // Text inputs
                    value = cleanInputNumber(staticInputs[key].value);
                }
                // Convert percentages to decimal for internal calculations and storage
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRatePre62', 'retirementDrawRatePost62', 'seventyTwoTInterestRate'].includes(key)) {
                    value = value / 100;
                }
                currentFinancials[key] = value;
            }
        }

        // Read dynamic investment account values
        currentFinancials.investmentAccounts = [];
        document.querySelectorAll('.investment-row').forEach(row => {
            const name = row.querySelector('.investment-name').value;
            const value = cleanInputNumber(row.querySelector('.investment-value').value);
            totalInvestments += value;
            currentFinancials.investmentAccounts.push({ name, value });
        });

        // Read dynamic homes values
        currentFinancials.homes = [];
        document.querySelectorAll('.home-row').forEach(row => {
            const name = row.querySelector('.home-name').value;
            const value = cleanInputNumber(row.querySelector('.home-value').value);
            totalHomes += value;
            currentFinancials.homes.push({ name, value });
        });

        // Read dynamic other static asset values
        currentFinancials.otherStaticAssets = [];
        document.querySelectorAll('.other-static-asset-row').forEach(row => {
            const name = row.querySelector('.static-asset-name').value;
            const value = cleanInputNumber(row.querySelector('.static-asset-value').value);
            totalOtherStaticAssets += value;
            currentFinancials.otherStaticAssets.push({ name, value });
        });

        // Read dynamic liability values
        currentFinancials.liabilities = [];
        document.querySelectorAll('.liability-row').forEach(row => {
            const name = row.querySelector('.liability-name').value;
            const value = cleanInputNumber(row.querySelector('.liability-value').value);
            collectedData.liabilities.push({ name, value });
        });

        // Read dynamic other income values
        currentFinancials.otherIncome = [];
        let totalOtherMonthlyIncome = 0;
        document.querySelectorAll('.other-income-row').forEach(row => {
            const name = row.querySelector('.income-name').value;
            const value = cleanInputNumber(row.querySelector('.income-value').value);
            const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
            currentFinancials.otherIncome.push({ name, value, escalationRate });
            totalOtherMonthlyIncome += value;
        });

        // Re-read values from currentFinancials for calculations to ensure consistency with what's being saved
        const currentAge = currentFinancials.currentAge;
        const baseSalary = currentFinancials.baseSalary;
        const bonusRate = currentFinancials.bonusRate;
        const my401kContributionRate = currentFinancials.my401kContributionRate;
        const company401kContributionRate = currentFinancials.company401kContributionRate;
        const annualRothContribution = currentFinancials.annualRothContribution;
        const monthlyHSAContribution = currentFinancials.monthlyHSAContribution;
        const annualSalaryRaise = currentFinancials.annualSalaryRaise;
        const stockAppreciation = currentFinancials.stockAppreciation;
        const housingAppreciation = currentFinancials.housingAppreciation;
        const inflation = currentFinancials.inflation;
        const retirementDrawRatePre62 = currentFinancials.retirementDrawRatePre62;
        const retirementDrawRatePost62 = currentFinancials.retirementDrawRatePost62;
        const retirementYear = currentFinancials.retirementYear;
        const monthlyPrincipalPayment = currentFinancials.monthlyPrincipalPayment;
        const socialSecurityStartAge = currentFinancials.socialSecurityStartAge;
        const socialSecurityMonthly = currentFinancials.socialSecurityMonthly;
        const annualPrincipalPayment = monthlyPrincipalPayment * 12;

        const seventyTwoTStartAge = currentFinancials.seventyTwoTStartAge;
        const seventyTwoTInterestRate = currentFinancials.seventyTwoTInterestRate;

        // Update min for retirementYear slider dynamically based on currentAge
        staticInputs.retirementYear.min = currentAge;
        if (retirementYear < currentAge) {
            staticInputs.retirementYear.value = currentAge;
        }

        // Update slider value displays (already done in populateInputsFromFirestore or event listeners)
        sliderPairs.forEach(pair => {
            // Ensure the slider and display elements exist before updating
            if (pair.slider && pair.valueDisplay) {
                updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
            }
        });

        // Update dynamic retirement draw labels based on slider value
        dynamicRetirementDrawLabel.textContent = `${retirementYear} YO Draw (Today's $):`;
        dynamicRetirementDrawLabelSticky.textContent = `${retirementYear} YO Draw (Today's $):`;

        // Dynamically update the Social Security Monthly slider label
        socialSecurityMonthlyLabel.textContent = `Social Security at ${socialSecurityStartAge} ($)`;
        // Dynamically update the SS Start Age Draw snapshot label
        ssStartAgeDrawLabel.textContent = `${socialSecurityStartAge} YO Draw (Today's $):`;


        // Calculate Net Worth and Net Investments
        const currentTotalAssets = totalInvestments + totalHomes + totalOtherStaticAssets;
        const currentNetWorth = currentTotalAssets - totalLiabilities;
        const currentNetInvestments = totalInvestments; // Net Investments is still just investment accounts

        // Calculate Annual Income (for display only in Snapshot)
        const annualBonusIncome = baseSalary * bonusRate;
        const totalAnnualOtherIncome = totalOtherMonthlyIncome * 12;
        const totalAnnualIncome = baseSalary + annualBonusIncome + totalAnnualOtherIncome;

        // Calculate Total Annual Savings (only those explicitly going into investments)
        const totalAnnualSavings =
            (baseSalary * my401kContributionRate) +
            (baseSalary * company401kContributionRate) +
            (monthlyHSAContribution * 12) +
            annualRothContribution;

        // Display current values using new formatting
        currentNetWorthDisplay.textContent = formatLargeCurrency(currentNetWorth);
        currentNetInvestmentsDisplay.textContent = formatLargeCurrency(currentNetInvestments);
        annualIncomeDisplay.textContent = formatLargeCurrency(totalAnnualIncome);
        annualSavingsDisplay.textContent = formatLargeCurrency(totalAnnualSavings); // Display only investment-related savings

        // Update the summary spans
        totalInvestmentsSummary.textContent = `(${formatLargeCurrency(totalInvestments)}) ${formatPercentageAPY(stockAppreciation)}% APY`;
        totalHomesSummary.textContent = `(${formatLargeCurrency(totalHomes)}) ${formatPercentageAPY(housingAppreciation)}% APY`;
        totalOtherStaticAssetsSummary.textContent = `(${formatLargeCurrency(totalOtherStaticAssets)})`; // No APY for static assets
        totalLiabilitiesSummary.textContent = `(${formatLargeCurrency(totalLiabilities)})`;

        // Project growth over years
        projectGrowth(currentNetInvestments, currentNetWorth,
                        totalHomes, totalOtherStaticAssets, // Pass new totals for homes and static assets
                        totalLiabilities, currentMortgageValue, baseSalary,
                        bonusRate, my401kContributionRate, company401kContributionRate,
                        annualRothContribution,
                        monthlyHSAContribution,
                        annualSalaryRaise, stockAppreciation,
                        housingAppreciation, inflation, annualPrincipalPayment,
                        currentFinancials.otherIncome,
                        currentAge,
                        retirementDrawRatePre62, retirementDrawRatePost62,
                        todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay, // Use new ID
                        retirementYear,
                        dynamicRetirementDrawValueSticky,
                        socialSecurityStartAge,
                        socialSecurityMonthly
                        );
        
        // Calculate and display 72(t) distributions
        // Find the 401K balance, robustly checking for case and parentheses
        const initial401kBalance = currentFinancials.investmentAccounts.find(acc => 
            acc.name.toLowerCase().includes("401k")
        )?.value || 0;

        // Project 401K balance to 72(t) start age *without* adding new contributions (only growth)
        const projected401kBalanceAt72tStart = project401kBalanceToAge(
            currentAge,
            seventyTwoTStartAge,
            initial401kBalance,
            0, // baseSalary for 72(t) calculation should be 0 to ignore new contributions
            0, // my401kRate for 72(t) calculation should be 0 to ignore new contributions
            0, // company401kRate for 72(t) calculation should be 0 to ignore new contributions
            0, // annualSalaryRaise for 72(t) calculation should be 0 to ignore new contributions
            stockAppreciation // Use the general stock appreciation for 401k growth
        );
        staticInputs.seventyTwoTAccountBalance.value = formatInputNumber(projected401kBalanceAt72tStart);

        const seventyTwoTCalculations = calculate72tDistributions(
            projected401kBalanceAt72tStart,
            seventyTwoTStartAge,
            seventyTwoTInterestRate
        );

        rmdAnnualDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.rmdAnnual);
        rmdMonthlyDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.rmdMonthly);
        amortizationAnnualDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.amortizationAnnual);
        amortizationMonthlyDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.amortizationMonthly);
        annuitizationAnnualDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.annuitizationAnnual);
        annuitizationMonthlyDisplay.textContent = formatLargeCurrency(seventyTwoTCalculations.annuitizationMonthly);

        // Project 72(t) account growth for chart and table
        project72tAccountGrowth(
            seventyTwoTStartAge,
            projected401kBalanceAt72tStart,
            stockAppreciation, // Use stock appreciation for the account growth in the projection
            seventyTwoTCalculations.amortizationAnnual // Use Fixed Amortization for projection as it's common
        );


        // Trigger saving if flag is true AND it's not from a Firestore load
        if (shouldSaveData && !window.isLoadingFromFirestore) {
            saveDataToFirestore(currentFinancials);
        }
    }


    function projectGrowth(initialNetInvestments, initialNetWorth,
                           initialHomesValue, initialOtherStaticAssetsValue, // New initial values for homes and static assets
                           initialTotalLiabilities, initialMortgageValue, initialBaseSalary,
                           bonusRate, my401kContributionRate, company401kContributionRate,
                           annualRothContribution,
                           monthlyHSAContribution,
                           annualSalaryRaise, stockAppreciation,
                           housingAppreciation, inflation, annualPrincipalPayment,
                           currentOtherIncomesStateForProjection,
                           initialAge,
                           retirementDrawRatePre62, retirementDrawRatePost62,
                           todaysDrawDisplay, dynamicRetirementDrawValue, ssStartAgeDrawDisplay,
                           retirementYearInput, dynamicRetirementDrawValueSticky,
                           socialSecurityStartAge,
                           socialSecurityMonthly
                           ) {

        projectionTableBody.innerHTML = '';
        chartContainer.innerHTML = '';

        let currentInvestments = initialNetInvestments;
        let currentHomesValue = initialHomesValue; // Use the initial total for homes
        let currentOtherStaticAssetsValue = initialOtherStaticAssetsValue; // Use the initial total for static assets
        let currentMortgage = initialMortgageValue;
        let currentOtherLiabilitiesTotal = initialTotalLiabilities - initialMortgageValue;
        let currentBaseSalary = initialBaseSalary;
        
        const startYear = new Date().getFullYear();
        let currentProjectedAge = initialAge;

        let projectedOtherIncomes = JSON.parse(JSON.stringify(currentOtherIncomesStateForProjection));
        const inflationRate = inflation;

        const chartData = [];

        // Calculate "Today's Draw" for snapshot display:
        // This is current investments * Pre-62 rate (from slider) + current total annual other income (from dynamic list)
        // Social Security is NOT included here as it only starts at the chosen SS age
        let initialTotalOtherAnnualIncomeSnapshot = 0;
        currentOtherIncomesStateForProjection.forEach(income => {
            initialTotalOtherAnnualIncomeSnapshot += income.value * 12;
        });
        const todaysDrawValue = (initialNetInvestments * retirementDrawRatePre62) + initialTotalOtherAnnualIncomeSnapshot;
        todaysDrawDisplay.textContent = formatLargeCurrency(todaysDrawValue);

        chartData.push({
            age: initialAge,
            investments: initialNetInvestments,
            netWorth: initialNetWorth, // Keep original net worth in future dollars for this line
            netWorthTodaysDollars: initialNetWorth / Math.pow((1 + inflationRate), 0) // Net worth in today's dollars
        });

        for (let i = 1; currentProjectedAge <= 80; i++) {
            const year = startYear + i;
            const age = currentProjectedAge;

            let annualContributionsToInvestments = 0;
            let currentAnnualOtherIncomeForYear = 0; // This is income for spending, not for investment growth

            // Calculate contributions only if not retired (explicit contributions)
            // Contributions stop once current age reaches or exceeds the retirement year input
            if (age < retirementYearInput) {
                annualContributionsToInvestments =
                    (currentBaseSalary * my401kContributionRate) +
                    (currentBaseSalary * company401kContributionRate) +
                    (monthlyHSAContribution * 12) +
                    annualRothContribution;
            }

            // Update projected other incomes for the current year (always escalates for total income available for spending)
            projectedOtherIncomes.forEach(income => {
                income.value *= (1 + income.escalationRate);
                // Round down rental income to nearest $100 if escalation applies
                if (income.name.toLowerCase().includes("rental") && income.escalationRate > 0) {
                    income.value = Math.floor(income.value / 100) * 100;
                }
                currentAnnualOtherIncomeForYear += income.value * 12; // Sum up for available income (e.g., rental, cell tower)
            });

            // Add explicit contributions to investments
            currentInvestments += annualContributionsToInvestments;

            // Apply investment growth
            currentInvestments *= (1 + stockAppreciation);

            // Apply housing appreciation to homes
            currentHomesValue *= (1 + housingAppreciation);

            // Other static assets remain static (no change needed here)

            let annualDrawFromInvestments = 0;
            let effectiveDrawRateForYear = 0;
            let annualSocialSecurityBenefit = 0;

            // Determine effective draw rate based on age relative to retirementYearInput and socialSecurityStartAge
            if (age >= retirementYearInput) {
                if (age < socialSecurityStartAge) {
                    effectiveDrawRateForYear = retirementDrawRatePre62;
                } else {
                    effectiveDrawRateForYear = retirementDrawRatePost62;
                    annualSocialSecurityBenefit = socialSecurityMonthly * 12; // Social Security starts at the chosen age
                }
                annualDrawFromInvestments = currentInvestments * effectiveDrawRateForYear;
                currentInvestments -= annualDrawFromInvestments;
            }

            // Calculate total income available for spending (investment draw + other incomes + Social Security)
            const totalAnnualIncomeAvailable = annualDrawFromInvestments + currentAnnualOtherIncomeForYear + annualSocialSecurityBenefit;


            // Update the dynamic retirement draw value when the specific retirement year is reached
            if (age === retirementYearInput) {
                const drawValueInTodaysDollars = totalAnnualIncomeAvailable / Math.pow((1 + inflationRate), i);
                dynamicRetirementDrawValue.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                dynamicRetirementDrawValueSticky.textContent = formatLargeCurrency(drawValueInTodaysDollars); // Update sticky value
            }

            // Update the SS Start Age Draw display (label is now dynamic)
            if (age === socialSecurityStartAge) {
                const drawAtSSStartAge = (currentInvestments * retirementDrawRatePost62) + currentAnnualOtherIncomeForYear + (socialSecurityMonthly * 12);
                const drawValueInTodaysDollarsAtSSStartAge = drawAtSSStartAge / Math.pow((1 + inflationRate), i);
                ssStartAgeDrawDisplay.textContent = formatLargeCurrency(drawValueInTodaysDollarsAtSSStartAge); // Update new ID
            }
            
            // Reduce mortgage if it exists
            currentMortgage = Math.max(0, currentMortgage - annualPrincipalPayment);

            // Calculate total projected assets for net worth
            // Sum of current investments, current homes value, and current other static assets value
            let totalProjectedAssets = currentInvestments + currentHomesValue + currentOtherStaticAssetsValue;

            // Re-calculating net worth based on projected investments, projected total assets, and projected liabilities
            const currentTotalLiabilitiesInProjection = currentMortgage + currentOtherLiabilitiesTotal;
            let currentNetWorth = totalProjectedAssets - currentTotalLiabilitiesInProjection;

            const netWorthInTodaysDollars = currentNetWorth / Math.pow((1 + inflationRate), i);

            chartData.push({
                age: age,
                investments: currentInvestments,
                netWorth: currentNetWorth, // Full net worth in future dollars
                netWorthTodaysDollars: netWorthInTodaysDollars // Net worth in today's dollars
            });

            const row = projectionTableBody.insertRow();
            row.classList.add('hover:bg-blue-50');

            if (age % 5 === 0) {
                row.classList.add('bg-blue-100');
            }

            row.insertCell().textContent = age;
            row.insertCell().textContent = year;
            row.insertCell().textContent = formatTableCurrency(currentInvestments);
            row.insertCell().textContent = formatTableCurrency(currentNetWorth);
            row.insertCell().textContent = formatTableCurrency(netWorthInTodaysDollars);

            if (age < retirementYearInput) {
                currentBaseSalary *= (1 + annualSalaryRaise);
            }
            
            currentProjectedAge++;
        }
        renderChart(chartData);
    }

    // D3.js Chart Rendering Function for Projected Growth
    function renderChart(data) {
        d3.select(chartContainer).select("svg").remove();

        const parentWidth = chartContainer.offsetWidth;
        const margin = { top: 40, right: 60, bottom: 50, left: 80 };
        const width = parentWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select(chartContainer).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "chart-svg")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.age))
            .range([0, width]);

        // Adjust yMax and yMin to account for the new netWorthTodaysDollars line
        const yMax = d3.max(data, d => Math.max(d.investments, d.netWorth, d.netWorthTodaysDollars));
        const yMin = d3.min(data, d => Math.min(d.investments, d.netWorth, d.netWorthTodaysDollars));

        const yScale = d3.scaleLinear()
            .domain([yMin * 0.95, yMax * 1.05])
            .range([height, 0]);

        const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
        const yAxisLeft = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));
        const yAxisRight = d3.axisRight(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax)); // Right axis

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis-left") // Left axis
            .call(yAxisLeft);

        svg.append("g")
            .attr("class", "y axis-right") // Right axis
            .attr("transform", `translate(${width}, 0)`) // Move to the right
            .call(yAxisRight);

        svg.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(yScale)
                .tickSize(-width)
                .tickFormat("")
            );

        const lineInvestments = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.investments));

        const lineNetWorth = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.netWorth));
        
        // NEW: Line generator for Net Worth (Today's $)
        const lineNetWorthTodaysDollars = d3.line()
            .x(d => xScale(d.age))
            .y(d => yScale(d.netWorthTodaysDollars));

        svg.append("path")
            .datum(data)
            .attr("class", "line line-investments")
            .attr("fill", "none")
            .attr("d", lineInvestments);

        svg.append("path")
            .datum(data)
            .attr("class", "line line-networth")
            .attr("fill", "none")
            .attr("d", lineNetWorth);
        
        // NEW: Append path for Net Worth (Today's $)
        svg.append("path")
            .datum(data)
            .attr("class", "line line-networth-todays-dollars")
            .attr("fill", "none")
            .attr("d", lineNetWorthTodaysDollars);

        svg.append("text")
            .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Age");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 20)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("transform", "rotate(90)")
            .attr("y", width + margin.right - 20) /* Position to the right */
            .attr("x", height / 2) /* Center vertically */
            .attr("dy", "-1em") /* Adjust text position */
            .style("text-anchor", "middle")
            .attr("font-size", "0.9rem")
            .text("Value ($)");

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .attr("font-size", "1.2rem")
            .attr("font-weight", "bold")
            .text("Projected Investments & Net Worth");

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute");

        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mouseover", function() { focusInvestment.style("display", null); focusNetWorth.style("display", null); focusNetWorthTodaysDollars.style("display", null); tooltip.style("opacity", 1); })
            .on("mouseout", function() { focusInvestment.style("display", "none"); focusNetWorth.style("display", "none"); focusNetWorthTodaysDollars.style("display", "none"); tooltip.style("opacity", 0); })
            .on("mousemove", mousemove);

        const focusInvestment = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusInvestment.append("circle")
            .attr("r", 5)
            .attr("fill", "#2563eb");

        const focusNetWorth = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusNetWorth.append("circle")
            .attr("r", 5)
            .attr("fill", "#10b981");
        
        // NEW: Focus for Net Worth (Today's $)
        const focusNetWorthTodaysDollars = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        focusNetWorthTodaysDollars.append("circle")
            .attr("r", 5)
            .attr("fill", "#800080"); // Purple color

        function mousemove(event) {
            const x0 = xScale.invert(d3.pointer(event)[0]);
            const bisect = d3.bisector(d => d.age).left;
            const i = bisect(data, x0, 1);
            const d0 = data[i - 1];
            const d1 = data[i];
            const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

            focusInvestment.attr("transform", `translate(${xScale(d.age)},${yScale(d.investments)})`);
            focusNetWorth.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorth)})`);
            focusNetWorthTodaysDollars.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorthTodaysDollars)})`);

            tooltip.html(`Age: ${d.age}<br>Investments: ${formatTableCurrency(d.investments)}<br>Net Worth: ${formatTableCurrency(d.netWorth)}<br>Net Worth (Today's $): ${formatTableCurrency(d.netWorthTodaysDollars)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
        }
        chartContainer.__chartData__ = data; // Store data for resize handling
    }

