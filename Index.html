<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global Firebase vars
        let app;
        let db;
        let auth;
        let userId; // Will store the authenticated user ID

        // Firestore Paths - Using a public collection as security is not a concern for this specific use case
        const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/retirement_calculator`;
        const SHARED_DOC_ID = 'shared_inputs'; // A single document for all shared inputs

        // Flag to prevent saving when data is being loaded from Firestore
        window.isLoadingFromFirestore = false;

        // Helper functions for number formatting in input fields
        function formatInputNumber(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // Ensure value is treated as a number before formatting, removing existing commas
            let num = Number(String(value).replace(/,/g, ''));
            if (isNaN(num)) {
                return '';
            }
            return new Intl.NumberFormat('en-US').format(num);
        }

        function cleanInputNumber(stringValue) {
            if (stringValue === null || stringValue === undefined || stringValue === '') {
                return 0;
            }
            // Remove all non-digit characters except for a potential leading minus sign and decimal
            const cleaned = stringValue.replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // Get references to all static input elements
        const staticInputs = {
            currentAge: document.getElementById('currentAge'),
            baseSalary: document.getElementById('baseSalary'),
            bonusRate: document.getElementById('bonusRate'),
            my401kContributionRate: document.getElementById('my401kContributionRate'),
            company401kContributionRate: document.getElementById('company401kContributionRate'),
            annualRothContribution: document.getElementById('annualRothContribution'),
            monthly529Contribution: document.getElementById('monthly529Contribution'),
            monthlyHSAContribution: document.getElementById('monthlyHSAContribution'),
            annualSalaryRaise: document.getElementById('annualSalaryRaise'),
            stockAppreciation: document.getElementById('stockAppreciation'),
            housingAppreciation: document.getElementById('housingAppreciation'),
            inflation: document.getElementById('inflation'),
            retirementDrawRate: document.getElementById('retirementDrawRate'),
            retirementYear: document.getElementById('retirementYear'),
            monthlyPrincipalPayment: document.getElementById('monthlyPrincipalPayment')
        };

        // Get references to display elements
        const currentNetWorthDisplay = document.getElementById('currentNetWorth');
        const currentNetInvestmentsDisplay = document.getElementById('currentNetInvestments');
        const annualIncomeDisplay = document.getElementById('annualIncomeDisplay');
        const annualSavingsDisplay = document.getElementById('annualSavingsDisplay');
        const todaysDrawDisplay = document.getElementById('todaysDraw');
        const fortyFiveYODrawDisplay = document.getElementById('fortyFiveYODraw');
        const sixtyTwoYODrawDisplay = document.getElementById('sixtyTwoYODraw');
        const projectionTableBody = document.getElementById('projectionTableBody');
        const investmentAccountsContainer = document.getElementById('investmentAccountsContainer');
        const addInvestmentBtn = document.getElementById('addInvestmentBtn');
        const otherAssetsContainer = document.getElementById('otherAssetsContainer');
        const addOtherAssetBtn = document.getElementById('addOtherAssetBtn');
        const liabilitiesContainer = document.getElementById('liabilitiesContainer');
        const addLiabilityBtn = document.getElementById('addLiabilityBtn');
        const otherIncomeContainer = document.getElementById('otherIncomeContainer');
        const addOtherIncomeBtn = document.getElementById('addOtherIncomeBtn');
        const chartContainer = document.getElementById('chart-container');

        // References for the summary spans
        const totalInvestmentsSummary = document.getElementById('totalInvestmentsSummary');
        const totalOtherAssetsSummary = document.getElementById('totalOtherAssetsSummary');
        const totalLiabilitiesSummary = document.getElementById('totalLiabilitiesSummary');

        // Get references to slider input and value display pairs
        const sliderPairs = [
            { slider: document.getElementById('currentAge'), valueDisplay: document.getElementById('currentAgeValue'), unit: '' },
            { slider: document.getElementById('bonusRate'), valueDisplay: document.getElementById('bonusRateValue'), unit: '%' },
            { slider: document.getElementById('my401kContributionRate'), valueDisplay: document.getElementById('my401kContributionRateValue'), unit: '%' },
            { slider: document.getElementById('company401kContributionRate'), valueDisplay: document.getElementById('company401kContributionRateValue'), unit: '%' },
            { slider: document.getElementById('annualSalaryRaise'), valueDisplay: document.getElementById('annualSalaryRaiseValue'), unit: '%' },
            { slider: document.getElementById('stockAppreciation'), valueDisplay: document.getElementById('stockAppreciationValue'), unit: '%' },
            { slider: document.getElementById('housingAppreciation'), valueDisplay: document.getElementById('housingAppreciationValue'), unit: '%' },
            { slider: document.getElementById('inflation'), valueDisplay: document.getElementById('inflationValue'), unit: '%' },
            { slider: document.getElementById('retirementDrawRate'), valueDisplay: document.getElementById('retirementDrawRateValue'), unit: '%' },
            { slider: document.getElementById('retirementYear'), valueDisplay: document.getElementById('retirementYearValue'), unit: '' }
        ];

        // Initial investment accounts data (exact values, not rounded) - these are default fallbacks
        const initialInvestmentAccounts = [
            { name: "401K", value: 524620 },
            { name: "Roth 1", value: 177474 },
            { name: "Roth 2", value: 156407 },
            { name: "529", value: 55485 },
            { name: "HSA", value: 25187 },
            { name: "Stocks", value: 0 },
            { name: "Gold", value: 6600 },
            { name: "Silver", value: 0 },
            { name: "Bitcoin", value: 0 }
        ];

        // Initial other assets data - these are default fallbacks
        const initialOtherAssets = [
            { name: "Checking Account", value: 17522 },
            { name: "Home Value", value: 943522 },
            { name: "Other Equity (Car, RV, etc.)", value: 90601 }
        ];

        // Initial liability accounts data (exact values, not rounded) - these are default fallbacks
        const initialLiabilities = [
            { name: "Mortgage", value: 202212 },
            { name: "Credit Cards", value: 0 },
            { name: "HELOC", value: 0 },
            { name: "Car Loan", value: 0 }
        ];

        // Initial other income data - these are default fallbacks
        const initialOtherIncome = [
            { name: "Cell Tower Lease", value: 1200, escalationRate: 0.015 },
            { name: "Rental 1", value: 1300, escalationRate: 0.04 }
        ];

        // Function to format numbers as currency, rounded to nearest thousand, without K/M (for table)
        const formatTableCurrency = (amount) => {
            const roundedAmount = Math.round(amount / 1000) * 1000;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(roundedAmount);
        };

        // Function to format numbers as currency with K/M and specified decimal places (for summary displays)
        const formatLargeCurrency = (amount) => {
            if (Math.abs(amount) >= 1000000) {
                return `$${(amount / 1000000).toFixed(2)}M`;
            }
            if (Math.abs(amount) >= 1000) {
                return `$${(amount / 1000).toFixed(0)}K`;
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Function to format Y-axis labels dynamically based on max value in the chart
        function formatProjectedChartAxisLabel(value, maxChartValue) {
            if (maxChartValue < 5000000) { // If max value is under 5 million, show in thousands
                return `$${(value / 1000).toFixed(0)}K`; // No decimals for K
            } else { // Otherwise, show in millions
                return `$${(value / 1000000).toFixed(0)}M`; // No decimals for M
            }
        }

        // Function to update slider value display position
        function updateSliderValueDisplay(slider, valueDisplay, unit) {
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const val = parseFloat(slider.value);
            const percentage = (val - min) / (max - min);

            const thumbWidth = 24;
            const sliderWidth = slider.offsetWidth;

            const leftPosition = (percentage * (sliderWidth - thumbWidth)) + (thumbWidth / 2);

            valueDisplay.style.left = `${leftPosition}px`;
            valueDisplay.textContent = `${val.toFixed(slider.step === '0.1' || slider.step === '0.5' ? 1 : 0)}${unit}`;
        }

        // Firebase Initialization
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously or with custom token if available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || 'anonymous';
                console.log("Firebase initialized and user authenticated:", userId);

                setupRealtimeListener(); // Start listening for data changes
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                // If Firebase fails, still run calculations with default/current DOM values
                calculateFinancials(false);
            }
        };

        // Function to save data to Firestore
        async function saveDataToFirestore(data) {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Data not saved.");
                return;
            }
            // Prevent saving if the update came from Firestore itself
            if (window.isLoadingFromFirestore) {
                return;
            }
            try {
                const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
                await setDoc(docRef, data, { merge: true }); // Merge to update specific fields
                console.log("Data saved to Firestore.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // Function to set up real-time listener for data
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Cannot set up listener.");
                return;
            }
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, SHARED_DOC_ID);
            onSnapshot(docRef, (docSnap) => {
                window.isLoadingFromFirestore = true; // Set flag when loading from Firestore
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Data loaded from Firestore:", data);
                    populateInputsFromFirestore(data);
                } else {
                    console.log("No shared data found in Firestore. Using default values and saving them.");
                    // If no data, ensure initial calculation runs with current DOM values and save them
                    calculateFinancials(true);
                }
                window.isLoadingFromFirestore = false; // Reset flag after processing
            }, (error) => {
                console.error("Error listening to Firestore document:", error);
                calculateFinancials(false); // Fallback to local calculation
                window.isLoadingFromFirestore = false; // Reset flag on error
            });
        }

        // Function to populate inputs from Firestore data
        function populateInputsFromFirestore(data) {
            // Update static inputs
            for (const key in staticInputs) {
                if (data[key] !== undefined) {
                    let value = data[key];
                    // Special handling for percentage sliders to convert back to 0-100 range for display
                    if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRate'].includes(key)) {
                        value = parseFloat(value) * 100; // Convert decimal back to percentage for UI
                    }

                    if (staticInputs[key].type === 'range') {
                         staticInputs[key].value = value;
                    } else {
                         staticInputs[key].value = formatInputNumber(value);
                    }
                    updateSliderValueDisplay(staticInputs[key], document.getElementById(`${key}Value`), sliderPairs.find(p => p.slider === staticInputs[key])?.unit || '');
                }
            }

            // Update dynamic inputs (investments, other assets, liabilities, other income)
            // Clear existing dynamic rows first
            investmentAccountsContainer.innerHTML = '';
            otherAssetsContainer.innerHTML = '';
            liabilitiesContainer.innerHTML = '';
            otherIncomeContainer.innerHTML = '';

            // Repopulate with data from Firestore or initial defaults if not present
            (data.investmentAccounts || initialInvestmentAccounts).forEach(account => addInvestmentAccountInput(account));
            (data.otherAssets || initialOtherAssets).forEach(asset => addOtherAssetInput(asset));
            (data.liabilities || initialLiabilities).forEach(liability => addLiabilityInput(liability));
            (data.otherIncome || initialOtherIncome).forEach(income => addOtherIncomeInput(income));

            // After populating, recalculate to update summaries and chart (but don't save yet)
            calculateFinancials(false);
        }

        // Function to add a new investment account input row
        function addInvestmentAccountInput(account = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('investment-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Account Name" value="${account.name}" class="input-field investment-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(account.value)}" class="input-field investment-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            investmentAccountsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.investment-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.investment-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new other asset input row
        function addOtherAssetInput(asset = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-asset-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Asset Name" value="${asset.name}" class="input-field asset-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(asset.value)}" class="input-field asset-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherAssetsContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.asset-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.asset-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new liability input row
        function addLiabilityInput(liability = { name: '', value: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('liability-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Liability Name" value="${liability.name}" class="input-field liability-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Value ($)" value="${formatInputNumber(liability.value)}" class="input-field liability-value flex-1 min-w-[100px]">
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            liabilitiesContainer.appendChild(rowDiv);

            const valueInput = rowDiv.querySelector('.liability-value');
            valueInput.addEventListener('input', (event) => {
                const rawValue = event.target.value;
                event.target.value = formatInputNumber(rawValue);
                calculateFinancials(true); // Trigger save
            });
            const nameInput = rowDiv.querySelector('.liability-name');
            nameInput.addEventListener('input', () => calculateFinancials(true)); // Trigger save

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Function to add a new other income input row
        function addOtherIncomeInput(income = { name: '', value: 0, escalationRate: 0 }) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('other-income-row', 'flex', 'flex-wrap', 'items-center', 'mb-4', 'space-y-2', 'md:space-y-0', 'md:space-x-2');
            rowDiv.innerHTML = `
                <input type="text" placeholder="Income Source" value="${income.name}" class="input-field income-name flex-1 min-w-[120px]">
                <input type="text" placeholder="Monthly Value ($)" value="${formatInputNumber(income.value)}" class="input-field income-value flex-1 min-w-[100px]">
                <div class="flex items-center">
                    <input type="number" placeholder="Escalation Rate" value="${(income.escalationRate * 100).toFixed(1)}" step="0.1" min="0" max="10" class="input-field income-escalation-rate w-24">
                    <span class="ml-1 text-gray-700">%</span>
                </div>
                <button type="button" class="delete-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-md transition duration-200 ease-in-out">X</button>
            `;
            otherIncomeContainer.appendChild(rowDiv);

            // Attach event listeners for value and escalation rate, and for name changes
            rowDiv.querySelectorAll('input').forEach(input => {
                if (input.classList.contains('income-value')) {
                    input.addEventListener('input', (event) => {
                        event.target.value = formatInputNumber(event.target.value);
                        calculateFinancials(true); // Trigger save
                    });
                } else {
                    input.addEventListener('input', () => calculateFinancials(true)); // Trigger save for name/escalation
                }
            });

            const deleteBtn = rowDiv.querySelector('.delete-item-btn');
            deleteBtn.addEventListener('click', () => {
                rowDiv.remove();
                calculateFinancials(true); // Trigger save
            });
        }

        // Main calculation function (now accepts a shouldSave flag)
        function calculateFinancials(shouldSaveData = true) {
            let totalInvestments = 0;
            let totalOtherAssets = 0;
            let totalLiabilities = 0;
            let currentMortgageValue = 0;

            let currentFinancials = {}; // Object to store all inputs for saving

            // Collect static input values
            for (const key in staticInputs) {
                let value;
                if (staticInputs[key].type === 'range') {
                    value = parseFloat(staticInputs[key].value);
                } else { // Text inputs
                    value = cleanInputNumber(staticInputs[key].value);
                }
                // Convert percentages to decimal for internal calculations and storage
                if (['bonusRate', 'my401kContributionRate', 'company401kContributionRate', 'annualSalaryRaise', 'stockAppreciation', 'housingAppreciation', 'inflation', 'retirementDrawRate'].includes(key)) {
                    value = value / 100;
                }
                currentFinancials[key] = value;
            }

            // Read dynamic investment account values
            currentFinancials.investmentAccounts = [];
            document.querySelectorAll('.investment-row').forEach(row => {
                const name = row.querySelector('.investment-name').value;
                const value = cleanInputNumber(row.querySelector('.investment-value').value);
                totalInvestments += value;
                currentFinancials.investmentAccounts.push({ name, value });
            });

            // Read dynamic other asset values
            currentFinancials.otherAssets = [];
            document.querySelectorAll('.other-asset-row').forEach(row => {
                const name = row.querySelector('.asset-name').value;
                const value = cleanInputNumber(row.querySelector('.asset-value').value);
                totalOtherAssets += value;
                currentFinancials.otherAssets.push({ name, value });
            });

            // Read dynamic liability values
            currentFinancials.liabilities = [];
            document.querySelectorAll('.liability-row').forEach(row => {
                const nameInput = row.querySelector('.liability-name');
                const valueInput = row.querySelector('.liability-value');
                const name = nameInput.value;
                const value = cleanInputNumber(valueInput.value);
                totalLiabilities += value;
                currentFinancials.liabilities.push({ name, value });

                if (name.toLowerCase() === "mortgage") {
                    currentMortgageValue = value;
                }
            });

            // Read dynamic other income values
            currentFinancials.otherIncome = [];
            let totalOtherMonthlyIncome = 0;
            document.querySelectorAll('.other-income-row').forEach(row => {
                const name = row.querySelector('.income-name').value;
                const value = cleanInputNumber(row.querySelector('.income-value').value);
                const escalationRate = parseFloat(row.querySelector('.income-escalation-rate').value) / 100 || 0;
                currentFinancials.otherIncome.push({ name, value, escalationRate });
                totalOtherMonthlyIncome += value;
            });

            // Re-read values from currentFinancials for calculations to ensure consistency with what's being saved
            const currentAge = currentFinancials.currentAge;
            const baseSalary = currentFinancials.baseSalary;
            const bonusRate = currentFinancials.bonusRate;
            const my401kContributionRate = currentFinancials.my401kContributionRate;
            const company401kContributionRate = currentFinancials.company401kContributionRate;
            const annualRothContribution = currentFinancials.annualRothContribution;
            const monthly529Contribution = currentFinancials.monthly529Contribution;
            const monthlyHSAContribution = currentFinancials.monthlyHSAContribution;
            const annualSalaryRaise = currentFinancials.annualSalaryRaise;
            const stockAppreciation = currentFinancials.stockAppreciation;
            const housingAppreciation = currentFinancials.housingAppreciation;
            const inflation = currentFinancials.inflation;
            const retirementDrawRate = currentFinancials.retirementDrawRate;
            const retirementYear = currentFinancials.retirementYear;
            const monthlyPrincipalPayment = currentFinancials.monthlyPrincipalPayment;
            const annualPrincipalPayment = monthlyPrincipalPayment * 12;

            // Update min for retirementYear slider dynamically based on currentAge
            staticInputs.retirementYear.min = currentAge;
            if (retirementYear < currentAge) {
                staticInputs.retirementYear.value = currentAge;
            }

            // Update slider value displays (already done in populateInputsFromFirestore or event listeners)
            sliderPairs.forEach(pair => {
                updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit);
            });

            // Calculate Net Worth and Net Investments
            const currentTotalAssets = totalInvestments + totalOtherAssets;
            const currentNetWorth = currentTotalAssets - totalLiabilities;
            const currentNetInvestments = totalInvestments;

            // Calculate Annual Income
            const annualBonusIncome = baseSalary * bonusRate;
            const totalAnnualOtherIncome = totalOtherMonthlyIncome * 12;
            const totalAnnualIncome = baseSalary + annualBonusIncome + totalAnnualOtherIncome;

            // Calculate Total Annual Savings
            const totalAnnualSavings =
                (baseSalary * my401kContributionRate) +
                (baseSalary * company401kContributionRate) +
                (monthly529Contribution * 12) +
                (monthlyHSAContribution * 12) +
                annualRothContribution +
                (monthlyPrincipalPayment * 12);

            // Display current values using new formatting
            currentNetWorthDisplay.textContent = formatLargeCurrency(currentNetWorth);
            currentNetInvestmentsDisplay.textContent = formatLargeCurrency(currentNetInvestments);
            annualIncomeDisplay.textContent = formatLargeCurrency(totalAnnualIncome);
            annualSavingsDisplay.textContent = formatLargeCurrency(totalAnnualSavings);

            // Update the summary spans
            totalInvestmentsSummary.textContent = `(${formatLargeCurrency(totalInvestments)})`;
            totalOtherAssetsSummary.textContent = `(${formatLargeCurrency(totalOtherAssets)})`;
            totalLiabilitiesSummary.textContent = `(${formatLargeCurrency(totalLiabilities)})`;

            // Project growth over years
            projectGrowth(currentNetInvestments, currentNetWorth,
                          currentFinancials.otherAssets.find(asset => asset.name === "Home Value")?.value || 0,
                          totalLiabilities, currentMortgageValue, baseSalary,
                          bonusRate, my401kContributionRate, company401kContributionRate,
                          annualRothContribution, monthly529Contribution, monthlyHSAContribution,
                          annualSalaryRaise, stockAppreciation,
                          housingAppreciation, inflation, annualPrincipalPayment,
                          currentFinancials.otherIncome, // Pass the collected current other income state
                          currentFinancials.otherAssets.find(asset => asset.name === "Other Equity (Car, RV, etc.)")?.value || 0,
                          currentAge,
                          retirementDrawRate, todaysDrawDisplay, fortyFiveYODrawDisplay, sixtyTwoYODrawDisplay,
                          retirementYear, totalAnnualOtherIncome);

            // Trigger saving if flag is true AND it's not from a Firestore load
            if (shouldSaveData && !window.isLoadingFromFirestore) {
                saveDataToFirestore(currentFinancials);
            }
        }


        function projectGrowth(initialNetInvestments, initialNetWorth, initialHomeValue, initialTotalLiabilities, initialMortgageValue, initialBaseSalary,
                               bonusRate, my401kContributionRate, company401kContributionRate,
                               annualRothContribution, monthly529Contribution, monthlyHSAContribution,
                               annualSalaryRaise, stockAppreciation,
                               housingAppreciation, inflation, annualPrincipalPayment,
                               currentOtherIncomesStateForProjection, // Changed to reflect current, not initial
                               otherEquityValueFromInitialAssets,
                               initialAge,
                               retirementDrawRate, todaysDrawDisplay, fortyFiveYODrawDisplay, sixtyTwoYODrawDisplay,
                               retirementYearInput, initialTotalOtherAnnualIncome) {

            projectionTableBody.innerHTML = '';
            chartContainer.innerHTML = '';

            let currentInvestments = initialNetInvestments;
            let currentHomeValue = initialHomeValue;
            let currentMortgage = initialMortgageValue;
            let currentOtherLiabilitiesTotal = initialTotalLiabilities - initialMortgageValue;
            let currentBaseSalary = initialBaseSalary;
            let currentOtherEquity = otherEquityValueFromInitialAssets;

            const startYear = new Date().getFullYear();
            let currentProjectedAge = initialAge;

            let projectedOtherIncomes = JSON.parse(JSON.stringify(currentOtherIncomesStateForProjection)); // Use current state
            const inflationRate = inflation;

            const chartData = [];

            // Calculate and display today's draw including other income
            // Note: This is now just a display value, actual projection starts from year 1 below
            const todaysDrawValue = (initialNetInvestments * retirementDrawRate) + initialTotalOtherAnnualIncome;
            todaysDrawDisplay.textContent = formatLargeCurrency(todaysDrawValue);

            chartData.push({
                age: initialAge,
                investments: initialNetInvestments,
                netWorth: initialNetWorth / Math.pow((1 + inflationRate), 0)
            });

            for (let i = 1; currentProjectedAge <= 100; i++) {
                const year = startYear + i;
                const age = currentProjectedAge;

                let annualMy401kContributionCurrentYear = currentBaseSalary * my401kContributionRate;
                let annualCompany401kContributionCurrentYear = currentBaseSalary * company401kContributionRate;
                let annual529ContributionCurrentYear = monthly529Contribution * 12;
                let annualHSAContributionCurrentYear = monthlyHSAContribution * 12;
                let annualRothContributionCurrentYear = annualRothContribution;

                if (age >= retirementYearInput) {
                    annualMy401kContributionCurrentYear = 0;
                    annualCompany401kContributionCurrentYear = 0;
                    annual529ContributionCurrentYear = 0;
                    annualHSAContributionCurrentYear = 0;
                    annualRothContributionCurrentYear = 0;
                }

                currentInvestments *= (1 + stockAppreciation);

                let totalNewInvestmentMoneyCurrentYear = 0;
                totalNewInvestmentMoneyCurrentYear += annualMy401kContributionCurrentYear;
                totalNewInvestmentMoneyCurrentYear += annual529ContributionCurrentYear;
                totalNewInvestmentMoneyCurrentYear += annualHSAContributionCurrentYear;
                totalNewInvestmentMoneyCurrentYear += annualRothContributionCurrentYear;
                totalNewInvestmentMoneyCurrentYear += annualCompany401kContributionCurrentYear;

                let currentAnnualOtherIncome = 0;
                projectedOtherIncomes.forEach(income => {
                    income.value *= (1 + income.escalationRate);
                    if (income.name.toLowerCase().includes("rental") && income.escalationRate > 0) {
                        // Round down to nearest $100 for rental income if it has escalation
                        income.value = Math.floor(income.value / 100) * 100;
                    }
                    currentAnnualOtherIncome += income.value * 12;
                });
                totalNewInvestmentMoneyCurrentYear += currentAnnualOtherIncome;

                currentInvestments += totalNewInvestmentMoneyCurrentYear;

                // Draw calculations now include other income for the specific year
                if (age === 45) {
                    const drawValue = (currentInvestments * retirementDrawRate) + currentAnnualOtherIncome;
                    const drawValueInTodaysDollars = drawValue / Math.pow((1 + inflationRate), i);
                    fortyFiveYODrawDisplay.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                }

                if (age === 62) {
                    const drawValue = (currentInvestments * retirementDrawRate) + currentAnnualOtherIncome;
                    const drawValueInTodaysDollars = drawValue / Math.pow((1 + inflationRate), i);
                    sixtyTwoYODrawDisplay.textContent = formatLargeCurrency(drawValueInTodaysDollars);
                }

                currentHomeValue *= (1 + housingAppreciation);
                currentOtherEquity = otherEquityValueFromInitialAssets / Math.pow((1 + inflationRate), 0) * Math.pow((1 + inflationRate), i); // Adjust other equity for inflation

                currentMortgage = Math.max(0, currentMortgage - annualPrincipalPayment);

                const currentHomeEquity = currentHomeValue - currentMortgage;
                const currentTotalLiabilitiesInProjection = currentMortgage + currentOtherLiabilitiesTotal; // Assuming other liabilities don't change
                let currentNetWorth = currentInvestments + currentHomeEquity + currentOtherEquity - currentTotalLiabilitiesInProjection;
                const netWorthInTodaysDollars = currentNetWorth / Math.pow((1 + inflationRate), i);

                chartData.push({
                    age: age,
                    investments: currentInvestments,
                    netWorth: netWorthInTodaysDollars
                });

                const row = projectionTableBody.insertRow();
                row.classList.add('hover:bg-blue-50');

                if (age % 5 === 0) {
                    row.classList.add('bg-blue-100');
                }

                row.insertCell().textContent = age;
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatTableCurrency(currentInvestments);
                row.insertCell().textContent = formatTableCurrency(currentNetWorth);
                row.insertCell().textContent = formatTableCurrency(netWorthInTodaysDollars);

                currentBaseSalary *= (1 + annualSalaryRaise);

                currentProjectedAge++;
            }
            renderChart(chartData);
        }

        // D3.js Chart Rendering Function for Projected Growth
        function renderChart(data) {
            d3.select(chartContainer).select("svg").remove();

            const parentWidth = chartContainer.offsetWidth;
            const margin = { top: 40, right: 60, bottom: 50, left: 80 };
            const width = parentWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(chartContainer).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("class", "chart-svg")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.age))
                .range([0, width]);

            const yMax = d3.max(data, d => Math.max(d.investments, d.netWorth));
            const yMin = d3.min(data, d => Math.min(d.investments, d.netWorth));

            const yScale = d3.scaleLinear()
                .domain([yMin * 0.95, yMax * 1.05])
                .range([height, 0]);

            const xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
            const yAxis = d3.axisLeft(yScale).tickFormat(d => formatProjectedChartAxisLabel(d, yMax));


            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                );

            const lineInvestments = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.investments));

            const lineNetWorth = d3.line()
                .x(d => xScale(d.age))
                .y(d => yScale(d.netWorth));

            svg.append("path")
                .datum(data)
                .attr("class", "line line-investments")
                .attr("fill", "none")
                .attr("d", lineInvestments);

            svg.append("path")
                .datum(data)
                .attr("class", "line line-networth")
                .attr("fill", "none")
                .attr("d", lineNetWorth);

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Age");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 20)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .attr("font-size", "0.9rem")
                .text("Value ($)");

            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .text("Projected Investments & Net Worth");

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute");

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .on("mouseover", function() { focusInvestment.style("display", null); focusNetWorth.style("display", null); tooltip.style("opacity", 1); })
                .on("mouseout", function() { focusInvestment.style("display", "none"); focusNetWorth.style("display", "none"); tooltip.style("opacity", 0); })
                .on("mousemove", mousemove);

            const focusInvestment = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusInvestment.append("circle")
                .attr("r", 5)
                .attr("fill", "#2563eb");

            const focusNetWorth = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focusNetWorth.append("circle")
                .attr("r", 5)
                .attr("fill", "#10b981");

            function mousemove(event) {
                const x0 = xScale.invert(d3.pointer(event)[0]);
                const bisect = d3.bisector(d => d.age).left;
                const i = bisect(data, x0, 1);
                const d0 = data[i - 1];
                const d1 = data[i];
                const d = x0 - d0.age > d1.age - x0 ? d1 : d0;

                focusInvestment.attr("transform", `translate(${xScale(d.age)},${yScale(d.investments)})`);
                focusNetWorth.attr("transform", `translate(${xScale(d.age)},${yScale(d.netWorth)})`);

                tooltip.html(`Age: ${d.age}<br>Investments: ${formatTableCurrency(d.investments)}<br>Net Worth (Today's $): ${formatTableCurrency(d.netWorth)}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            }
            chartContainer.__chartData__ = data; // Store data for resize handling
        }


        // Add event listeners to all static input fields
        for (const key in staticInputs) {
            // All changes to static inputs trigger save
            staticInputs[key].addEventListener('input', () => calculateFinancials(true));
            // Add specific input formatting for relevant fields
            if (staticInputs[key].type === 'text') {
                 staticInputs[key].addEventListener('input', (event) => {
                    const rawValue = event.target.value;
                    event.target.value = formatInputNumber(rawValue);
                });
            }
        }

        // Add event listener for adding new investment accounts
        addInvestmentBtn.addEventListener('click', () => { addInvestmentAccountInput(); calculateFinancials(true); });
        // Add event listener for adding new other asset accounts
        addOtherAssetBtn.addEventListener('click', () => { addOtherAssetInput(); calculateFinancials(true); });
        // Add event listener for adding new liability accounts
        addLiabilityBtn.addEventListener('click', () => { addLiabilityInput(); calculateFinancials(true); });
        // Add event listener for adding new other income accounts
        addOtherIncomeBtn.addEventListener('click', () => { addOtherIncomeInput(); calculateFinancials(true); });

        // Attach event listeners for slider value display updates and trigger save
        sliderPairs.forEach(pair => {
            pair.slider.addEventListener('input', () => updateSliderValueDisplay(pair.slider, pair.valueDisplay, pair.unit));
            pair.slider.addEventListener('change', () => calculateFinancials(true)); // Change also triggers save
            // Initial display update handled by populateInputsFromFirestore
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Populate initial default dynamic rows. These will be overwritten by Firestore if data exists.
            initialInvestmentAccounts.forEach(account => addInvestmentAccountInput(account));
            initialOtherAssets.forEach(asset => addOtherAssetInput(asset));
            initialLiabilities.forEach(liability => addLiabilityInput(liability));
            initialOtherIncome.forEach(income => addOtherIncomeInput(income));

            initFirebase(); // Initialize Firebase and start data loading/listening

            // Re-render charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                const projectedData = chartContainer.__chartData__;
                if (projectedData) {
                    renderChart(projectedData);
                }
            });
        });
    </script>
</head>
<body class="flex flex-col lg:flex-row min-h-screen">
    <!-- Left Sticky Banner -->
    <div id="leftStickyBanner" class="fixed top-0 left-0 h-screen w-64 bg-blue-800 text-white p-6 shadow-2xl flex flex-col items-center justify-start z-50 overflow-y-auto
                                     lg:w-64 lg:h-screen lg:flex-col
                                     w-full h-auto flex-row flex-wrap justify-center items-start pt-4 pb-2 px-2">
        <h2 class="text-3xl font-extrabold mb-8 text-center text-white lg:text-3xl text-2xl w-full">Your Snapshot</h2>
        <!-- Each summary item will be a div -->
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">Net Worth:</p>
            <p id="currentNetWorth" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">Net Investments:</p>
            <p id="currentNetInvestments" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">Annual Income:</p>
            <p id="annualIncomeDisplay" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">Annual Savings:</p>
            <p id="annualSavingsDisplay" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">Today's Draw:</p>
            <p id="todaysDraw" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">45 YO Draw (Today's $):</p>
            <p id="fortyFiveYODraw" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
        <div class="text-center w-full mb-4 summary-item lg:w-auto lg:text-center sm:text-left">
            <p class="text-lg font-bold text-blue-200 sm:text-base">62 YO Draw (Today's $):</p>
            <p id="sixtyTwoYODraw" class="text-3xl font-semibold text-white mt-1 sm:text-xl">$0</p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 ml-0 lg:ml-64 p-4 md:p-8 main-content-wrapper mt-[10rem] sm:mt-[7rem] lg:mt-0">
        <div class="w-full bg-white rounded-lg shadow-xl p-4 md:p-8">
            <h1 class="text-4xl font-extrabold mb-4 text-center text-blue-800">Retirement Plan Calculator</h1>

            <!-- Section 1: Current Financials & Assumptions -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <!-- Collapsible Section: Assets, Investments, and Liabilities -->
                <details open>
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        1. Assets, Investments, and Liabilities
                    </summary>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Investment Accounts (Dynamic) -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Investment Accounts <span class="font-bold text-green-600" id="totalInvestmentsSummary"></span></h3>
                            <div id="investmentAccountsContainer" class="mb-4 space-y-4">
                                <!-- Dynamic investment inputs will be added here by JavaScript -->
                            </div>
                            <button id="addInvestmentBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Investment Account
                            </button>
                        </div>

                        <!-- Other Assets -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Other Assets <span class="font-bold text-green-600" id="totalOtherAssetsSummary"></span></h3>
                            <div id="otherAssetsContainer" class="mb-4 space-y-4">
                                <!-- Dynamic other assets inputs will be added here by JavaScript -->
                            </div>
                            <button id="addOtherAssetBtn" type="button" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Asset
                            </button>

                            <!-- Liabilities - Moved here, no longer spanning two columns -->
                            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Liabilities <span class="font-bold text-red-600" id="totalLiabilitiesSummary"></span></h3>
                            <div id="liabilitiesContainer" class="mb-4 space-y-4">
                                <!-- Dynamic liability inputs will be added here by JavaScript -->
                            </div>
                            <button id="addLiabilityBtn" type="button" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Liability
                            </button>
                        </div>
                    </div>
                </details>

                <!-- Collapsible Section: Income, Savings, and Assumptions -->
                <details open class="mt-8">
                    <summary class="text-2xl font-bold mb-6 text-blue-700 cursor-pointer">
                        2. Income, Savings, and Assumptions
                    </summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Income & Contribution Assumptions</h3>
                            <div class="mb-4">
                                <label for="currentAge" class="label-style">Current Age</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="currentAge" min="18" max="100" value="38" step="1" class="w-full">
                                    <span class="slider-value-display" id="currentAgeValue"></span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="baseSalary" class="label-style">Base Salary ($)</label>
                                <input type="text" id="baseSalary" value="179386" class="input-field">
                            </div>

                            <div class="mb-4">
                                <label for="bonusRate" class="label-style">Bonus Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="bonusRate" min="0" max="50" value="23" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="bonusRateValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="my401kContributionRate" class="label-style">My 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="my401kContributionRate" min="0" max="20" value="13" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="my401kContributionRateValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="company401kContributionRate" class="label-style">Company 401K Contribution Rate (% of Base Salary)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="company401kContributionRate" min="0" max="20" value="10" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="company401kContributionRateValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthly529Contribution" class="label-style">Monthly 529 Contribution ($)</label>
                                <input type="text" id="monthly529Contribution" value="400" class="input-field">
                            </div>
                            <div class="mb-4">
                                <label for="monthlyHSAContribution" class="label-style">Monthly HSA Contribution ($)</label>
                                <input type="text" id="monthlyHSAContribution" value="600" class="input-field">
                            </div>

                            <div class="mb-4">
                                <label for="annualRothContribution" class="label-style">Other Annual Savings Contribution ($)</label>
                                <input type="text" id="annualRothContribution" value="25000" class="input-field">
                            </div>
                            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Other Income (Monthly)</h3>
                            <!-- Labels for Other Income inputs -->
                            <div class="flex items-center text-sm font-semibold mb-2 ml-2">
                                <div class="flex-1 min-w-[120px]">Income Description</div>
                                <div class="flex-1 min-w-[100px]">Monthly Amount</div>
                                <div class="w-24 ml-1">Annual Escalation</div>
                                <div class="w-6"></div> <!-- Spacer for delete button -->
                            </div>
                            <div id="otherIncomeContainer" class="mb-4 space-y-4">
                                <!-- Dynamic other income inputs will be added here by JavaScript -->
                            </div>
                            <button id="addOtherIncomeBtn" type="button" class="mt-4 bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                                + Add Other Income
                            </button>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Growth & Expense Assumptions</h3>
                            <div class="mb-4">
                                <label for="annualSalaryRaise" class="label-style">Annual Salary Raise (%)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="annualSalaryRaise" min="0" max="10" value="3.8" step="0.1" class="w-full">
                                    <span class="slider-value-display" id="annualSalaryRaiseValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="stockAppreciation" class="label-style">Stock Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="stockAppreciation" min="0" max="15" value="10" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="stockAppreciationValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="housingAppreciation" class="label-style">Housing Appreciation (%)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="housingAppreciation" min="0" max="10" value="4" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="housingAppreciationValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="inflation" class="label-style">Inflation (%)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="inflation" min="0" max="10" value="3" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="inflationValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="retirementDrawRate" class="label-style">Retirement Draw (%)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="retirementDrawRate" min="0" max="10" value="7" step="0.5" class="w-full">
                                    <span class="slider-value-display" id="retirementDrawRateValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="retirementYear" class="label-style">Retirement Year (Age)</label>
                                <div class="slider-input-wrapper">
                                    <input type="range" id="retirementYear" min="38" max="100" value="65" step="1" class="w-full">
                                    <span class="slider-value-display" id="retirementYearValue"></span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="monthlyPrincipalPayment" class="label-style">Monthly Principal Payment ($)</label>
                                <input type="text" id="monthlyPrincipalPayment" value="1428" class="input-field">
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Section 3: Projected Growth Chart -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">3. Projected Growth Chart</h2>
                <div id="chart-container" class="w-full overflow-x-auto">
                    <!-- D3.js chart will be rendered here -->
                </div>
                <div class="flex justify-center mt-4 space-x-6 text-gray-700 font-semibold">
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #2563eb;"></span>
                        Net Investments
                    </div>
                    <div class="flex items-center">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #10b981;"></span>
                        Net Worth (Today's $)
                    </div>
                </div>
            </div>

            <!-- Section 4: Growth Projection Table -->
            <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">4. Projected Growth Table</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-blue-600 text-white uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Age</th>
                                <th class="py-3 px-6 text-left">Year</th>
                                <th class="py-3 px-6 text-left">Investments</th>
                                <th class="py-3 px-6 text-left">Net Worth</th>
                                <th class="py-3 px-6 text-left">Net Worth (Today's $)</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTableBody" class="text-gray-700 text-sm font-light divide-y divide-gray-200">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
